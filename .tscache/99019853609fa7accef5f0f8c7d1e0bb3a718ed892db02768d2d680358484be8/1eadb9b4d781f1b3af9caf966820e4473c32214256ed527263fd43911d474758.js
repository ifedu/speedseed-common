var path = require('path');
var clone = require('clone');
var cloneStats = require('clone-stats');
var cloneBuffer = require('./lib/cloneBuffer');
var isBuffer = require('./lib/isBuffer');
var isStream = require('./lib/isStream');
var isNull = require('./lib/isNull');
var inspectStream = require('./lib/inspectStream');
var Stream = require('stream');
var replaceExt = require('replace-ext');
var builtInFields = [
    '_contents', 'contents', 'stat', 'history', 'path', 'base', 'cwd',
];
function File(file) {
    var self = this;
    if (!file) {
        file = {};
    }
    // Record path change
    var history = file.path ? [file.path] : file.history;
    this.history = history || [];
    this.cwd = file.cwd || process.cwd();
    this.base = file.base || this.cwd;
    // Stat = files stats object
    this.stat = file.stat || null;
    // Contents = stream, buffer, or null if not read
    this.contents = file.contents || null;
    this._isVinyl = true;
    // Set custom properties
    Object.keys(file).forEach(function (key) {
        if (self.constructor.isCustomProp(key)) {
            self[key] = file[key];
        }
    });
}
File.prototype.isBuffer = function () {
    return isBuffer(this.contents);
};
File.prototype.isStream = function () {
    return isStream(this.contents);
};
File.prototype.isNull = function () {
    return isNull(this.contents);
};
// TODO: Should this be moved to vinyl-fs?
File.prototype.isDirectory = function () {
    return this.isNull() && this.stat && this.stat.isDirectory();
};
File.prototype.clone = function (opt) {
    var self = this;
    if (typeof opt === 'boolean') {
        opt = {
            deep: opt,
            contents: true,
        };
    }
    else if (!opt) {
        opt = {
            deep: true,
            contents: true,
        };
    }
    else {
        opt.deep = opt.deep === true;
        opt.contents = opt.contents !== false;
    }
    // Clone our file contents
    var contents;
    if (this.isStream()) {
        contents = this.contents.pipe(new Stream.PassThrough());
        this.contents = this.contents.pipe(new Stream.PassThrough());
    }
    else if (this.isBuffer()) {
        contents = opt.contents ? cloneBuffer(this.contents) : this.contents;
    }
    var file = new this.constructor({
        cwd: this.cwd,
        base: this.base,
        stat: (this.stat ? cloneStats(this.stat) : null),
        history: this.history.slice(),
        contents: contents,
    });
    // Clone our custom properties
    Object.keys(this).forEach(function (key) {
        if (self.constructor.isCustomProp(key)) {
            file[key] = opt.deep ? clone(self[key], true) : self[key];
        }
    });
    return file;
};
File.prototype.pipe = function (stream, opt) {
    if (!opt) {
        opt = {};
    }
    if (typeof opt.end === 'undefined') {
        opt.end = true;
    }
    if (this.isStream()) {
        return this.contents.pipe(stream, opt);
    }
    if (this.isBuffer()) {
        if (opt.end) {
            stream.end(this.contents);
        }
        else {
            stream.write(this.contents);
        }
        return stream;
    }
    // Check if isNull
    if (opt.end) {
        stream.end();
    }
    return stream;
};
File.prototype.inspect = function () {
    var inspect = [];
    // Use relative path if possible
    var filePath = (this.base && this.path) ? this.relative : this.path;
    if (filePath) {
        inspect.push('"' + filePath + '"');
    }
    if (this.isBuffer()) {
        inspect.push(this.contents.inspect());
    }
    if (this.isStream()) {
        inspect.push(inspectStream(this.contents));
    }
    return '<File ' + inspect.join(' ') + '>';
};
File.isCustomProp = function (key) {
    return builtInFields.indexOf(key) === -1;
};
File.isVinyl = function (file) {
    return (file && file._isVinyl === true) || false;
};
// Virtual attributes
// Or stuff with extra logic
Object.defineProperty(File.prototype, 'contents', {
    get: function () {
        return this._contents;
    },
    set: function (val) {
        if (!isBuffer(val) && !isStream(val) && !isNull(val)) {
            throw new Error('File.contents can only be a Buffer, a Stream, or null.');
        }
        this._contents = val;
    },
});
// TODO: Should this be moved to vinyl-fs?
Object.defineProperty(File.prototype, 'relative', {
    get: function () {
        if (!this.base) {
            throw new Error('No base specified! Can not get relative.');
        }
        if (!this.path) {
            throw new Error('No path specified! Can not get relative.');
        }
        return path.relative(this.base, this.path);
    },
    set: function () {
        throw new Error('File.relative is generated from the base and path attributes. Do not modify it.');
    },
});
Object.defineProperty(File.prototype, 'dirname', {
    get: function () {
        if (!this.path) {
            throw new Error('No path specified! Can not get dirname.');
        }
        return path.dirname(this.path);
    },
    set: function (dirname) {
        if (!this.path) {
            throw new Error('No path specified! Can not set dirname.');
        }
        this.path = path.join(dirname, path.basename(this.path));
    },
});
Object.defineProperty(File.prototype, 'basename', {
    get: function () {
        if (!this.path) {
            throw new Error('No path specified! Can not get basename.');
        }
        return path.basename(this.path);
    },
    set: function (basename) {
        if (!this.path) {
            throw new Error('No path specified! Can not set basename.');
        }
        this.path = path.join(path.dirname(this.path), basename);
    },
});
// Property for getting/setting stem of the filename.
Object.defineProperty(File.prototype, 'stem', {
    get: function () {
        if (!this.path) {
            throw new Error('No path specified! Can not get stem.');
        }
        return path.basename(this.path, this.extname);
    },
    set: function (stem) {
        if (!this.path) {
            throw new Error('No path specified! Can not set stem.');
        }
        this.path = path.join(path.dirname(this.path), stem + this.extname);
    },
});
Object.defineProperty(File.prototype, 'extname', {
    get: function () {
        if (!this.path) {
            throw new Error('No path specified! Can not get extname.');
        }
        return path.extname(this.path);
    },
    set: function (extname) {
        if (!this.path) {
            throw new Error('No path specified! Can not set extname.');
        }
        this.path = replaceExt(this.path, extname);
    },
});
Object.defineProperty(File.prototype, 'path', {
    get: function () {
        return this.history[this.history.length - 1];
    },
    set: function (path) {
        if (typeof path !== 'string') {
            throw new Error('path should be string');
        }
        // Record history only when path changed
        if (path && path !== this.path) {
            this.history.push(path);
        }
    },
});
module.exports = File;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFx2aW55bC1maWxlXFxub2RlX21vZHVsZXNcXHZpbnlsXFxpbmRleC5qcyIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFx2aW55bC1maWxlXFxub2RlX21vZHVsZXNcXHZpbnlsXFxpbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN4QyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUMvQyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUN6QyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUN6QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDckMsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbkQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUV4QyxJQUFJLGFBQWEsR0FBRztJQUNsQixXQUFXLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLO0NB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UUFDN0QsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQ0QsR0FBRyxFQUFFLFVBQVMsT0FBTztRQUNuQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUM7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFO0lBQzVDLEdBQUcsRUFBRTtRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFDRCxHQUFHLEVBQUUsVUFBUyxJQUFJO1FBQ2hCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFFRCx3Q0FBd0M7UUFDeEMsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgY2xvbmUgPSByZXF1aXJlKCdjbG9uZScpO1xudmFyIGNsb25lU3RhdHMgPSByZXF1aXJlKCdjbG9uZS1zdGF0cycpO1xudmFyIGNsb25lQnVmZmVyID0gcmVxdWlyZSgnLi9saWIvY2xvbmVCdWZmZXInKTtcbnZhciBpc0J1ZmZlciA9IHJlcXVpcmUoJy4vbGliL2lzQnVmZmVyJyk7XG52YXIgaXNTdHJlYW0gPSByZXF1aXJlKCcuL2xpYi9pc1N0cmVhbScpO1xudmFyIGlzTnVsbCA9IHJlcXVpcmUoJy4vbGliL2lzTnVsbCcpO1xudmFyIGluc3BlY3RTdHJlYW0gPSByZXF1aXJlKCcuL2xpYi9pbnNwZWN0U3RyZWFtJyk7XG52YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG52YXIgcmVwbGFjZUV4dCA9IHJlcXVpcmUoJ3JlcGxhY2UtZXh0Jyk7XG5cbnZhciBidWlsdEluRmllbGRzID0gW1xuICAnX2NvbnRlbnRzJywgJ2NvbnRlbnRzJywgJ3N0YXQnLCAnaGlzdG9yeScsICdwYXRoJywgJ2Jhc2UnLCAnY3dkJyxcbl07XG5cbmZ1bmN0aW9uIEZpbGUoZmlsZSkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgaWYgKCFmaWxlKSB7XG4gICAgZmlsZSA9IHt9O1xuICB9XG5cbiAgLy8gUmVjb3JkIHBhdGggY2hhbmdlXG4gIHZhciBoaXN0b3J5ID0gZmlsZS5wYXRoID8gW2ZpbGUucGF0aF0gOiBmaWxlLmhpc3Rvcnk7XG4gIHRoaXMuaGlzdG9yeSA9IGhpc3RvcnkgfHwgW107XG5cbiAgdGhpcy5jd2QgPSBmaWxlLmN3ZCB8fCBwcm9jZXNzLmN3ZCgpO1xuICB0aGlzLmJhc2UgPSBmaWxlLmJhc2UgfHwgdGhpcy5jd2Q7XG5cbiAgLy8gU3RhdCA9IGZpbGVzIHN0YXRzIG9iamVjdFxuICB0aGlzLnN0YXQgPSBmaWxlLnN0YXQgfHwgbnVsbDtcblxuICAvLyBDb250ZW50cyA9IHN0cmVhbSwgYnVmZmVyLCBvciBudWxsIGlmIG5vdCByZWFkXG4gIHRoaXMuY29udGVudHMgPSBmaWxlLmNvbnRlbnRzIHx8IG51bGw7XG5cbiAgdGhpcy5faXNWaW55bCA9IHRydWU7XG5cbiAgLy8gU2V0IGN1c3RvbSBwcm9wZXJ0aWVzXG4gIE9iamVjdC5rZXlzKGZpbGUpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7XG4gICAgaWYgKHNlbGYuY29uc3RydWN0b3IuaXNDdXN0b21Qcm9wKGtleSkpIHtcbiAgICAgIHNlbGZba2V5XSA9IGZpbGVba2V5XTtcbiAgICB9XG4gIH0pO1xufVxuXG5GaWxlLnByb3RvdHlwZS5pc0J1ZmZlciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gaXNCdWZmZXIodGhpcy5jb250ZW50cyk7XG59O1xuXG5GaWxlLnByb3RvdHlwZS5pc1N0cmVhbSA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gaXNTdHJlYW0odGhpcy5jb250ZW50cyk7XG59O1xuXG5GaWxlLnByb3RvdHlwZS5pc051bGwgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIGlzTnVsbCh0aGlzLmNvbnRlbnRzKTtcbn07XG5cbi8vIFRPRE86IFNob3VsZCB0aGlzIGJlIG1vdmVkIHRvIHZpbnlsLWZzP1xuRmlsZS5wcm90b3R5cGUuaXNEaXJlY3RvcnkgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuaXNOdWxsKCkgJiYgdGhpcy5zdGF0ICYmIHRoaXMuc3RhdC5pc0RpcmVjdG9yeSgpO1xufTtcblxuRmlsZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihvcHQpIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gIGlmICh0eXBlb2Ygb3B0ID09PSAnYm9vbGVhbicpIHtcbiAgICBvcHQgPSB7XG4gICAgICBkZWVwOiBvcHQsXG4gICAgICBjb250ZW50czogdHJ1ZSxcbiAgICB9O1xuICB9IGVsc2UgaWYgKCFvcHQpIHtcbiAgICBvcHQgPSB7XG4gICAgICBkZWVwOiB0cnVlLFxuICAgICAgY29udGVudHM6IHRydWUsXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBvcHQuZGVlcCA9IG9wdC5kZWVwID09PSB0cnVlO1xuICAgIG9wdC5jb250ZW50cyA9IG9wdC5jb250ZW50cyAhPT0gZmFsc2U7XG4gIH1cblxuICAvLyBDbG9uZSBvdXIgZmlsZSBjb250ZW50c1xuICB2YXIgY29udGVudHM7XG4gIGlmICh0aGlzLmlzU3RyZWFtKCkpIHtcbiAgICBjb250ZW50cyA9IHRoaXMuY29udGVudHMucGlwZShuZXcgU3RyZWFtLlBhc3NUaHJvdWdoKCkpO1xuICAgIHRoaXMuY29udGVudHMgPSB0aGlzLmNvbnRlbnRzLnBpcGUobmV3IFN0cmVhbS5QYXNzVGhyb3VnaCgpKTtcbiAgfSBlbHNlIGlmICh0aGlzLmlzQnVmZmVyKCkpIHtcbiAgICBjb250ZW50cyA9IG9wdC5jb250ZW50cyA/IGNsb25lQnVmZmVyKHRoaXMuY29udGVudHMpIDogdGhpcy5jb250ZW50cztcbiAgfVxuXG4gIHZhciBmaWxlID0gbmV3IHRoaXMuY29uc3RydWN0b3Ioe1xuICAgIGN3ZDogdGhpcy5jd2QsXG4gICAgYmFzZTogdGhpcy5iYXNlLFxuICAgIHN0YXQ6ICh0aGlzLnN0YXQgPyBjbG9uZVN0YXRzKHRoaXMuc3RhdCkgOiBudWxsKSxcbiAgICBoaXN0b3J5OiB0aGlzLmhpc3Rvcnkuc2xpY2UoKSxcbiAgICBjb250ZW50czogY29udGVudHMsXG4gIH0pO1xuXG4gIC8vIENsb25lIG91ciBjdXN0b20gcHJvcGVydGllc1xuICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xuICAgIGlmIChzZWxmLmNvbnN0cnVjdG9yLmlzQ3VzdG9tUHJvcChrZXkpKSB7XG4gICAgICBmaWxlW2tleV0gPSBvcHQuZGVlcCA/IGNsb25lKHNlbGZba2V5XSwgdHJ1ZSkgOiBzZWxmW2tleV07XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGZpbGU7XG59O1xuXG5GaWxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oc3RyZWFtLCBvcHQpIHtcbiAgaWYgKCFvcHQpIHtcbiAgICBvcHQgPSB7fTtcbiAgfVxuICBpZiAodHlwZW9mIG9wdC5lbmQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgb3B0LmVuZCA9IHRydWU7XG4gIH1cblxuICBpZiAodGhpcy5pc1N0cmVhbSgpKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udGVudHMucGlwZShzdHJlYW0sIG9wdCk7XG4gIH1cbiAgaWYgKHRoaXMuaXNCdWZmZXIoKSkge1xuICAgIGlmIChvcHQuZW5kKSB7XG4gICAgICBzdHJlYW0uZW5kKHRoaXMuY29udGVudHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdHJlYW0ud3JpdGUodGhpcy5jb250ZW50cyk7XG4gICAgfVxuICAgIHJldHVybiBzdHJlYW07XG4gIH1cblxuICAvLyBDaGVjayBpZiBpc051bGxcbiAgaWYgKG9wdC5lbmQpIHtcbiAgICBzdHJlYW0uZW5kKCk7XG4gIH1cbiAgcmV0dXJuIHN0cmVhbTtcbn07XG5cbkZpbGUucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbigpIHtcbiAgdmFyIGluc3BlY3QgPSBbXTtcblxuICAvLyBVc2UgcmVsYXRpdmUgcGF0aCBpZiBwb3NzaWJsZVxuICB2YXIgZmlsZVBhdGggPSAodGhpcy5iYXNlICYmIHRoaXMucGF0aCkgPyB0aGlzLnJlbGF0aXZlIDogdGhpcy5wYXRoO1xuXG4gIGlmIChmaWxlUGF0aCkge1xuICAgIGluc3BlY3QucHVzaCgnXCInICsgZmlsZVBhdGggKyAnXCInKTtcbiAgfVxuXG4gIGlmICh0aGlzLmlzQnVmZmVyKCkpIHtcbiAgICBpbnNwZWN0LnB1c2godGhpcy5jb250ZW50cy5pbnNwZWN0KCkpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNTdHJlYW0oKSkge1xuICAgIGluc3BlY3QucHVzaChpbnNwZWN0U3RyZWFtKHRoaXMuY29udGVudHMpKTtcbiAgfVxuXG4gIHJldHVybiAnPEZpbGUgJyArIGluc3BlY3Quam9pbignICcpICsgJz4nO1xufTtcblxuRmlsZS5pc0N1c3RvbVByb3AgPSBmdW5jdGlvbihrZXkpIHtcbiAgcmV0dXJuIGJ1aWx0SW5GaWVsZHMuaW5kZXhPZihrZXkpID09PSAtMTtcbn07XG5cbkZpbGUuaXNWaW55bCA9IGZ1bmN0aW9uKGZpbGUpIHtcbiAgcmV0dXJuIChmaWxlICYmIGZpbGUuX2lzVmlueWwgPT09IHRydWUpIHx8IGZhbHNlO1xufTtcblxuLy8gVmlydHVhbCBhdHRyaWJ1dGVzXG4vLyBPciBzdHVmZiB3aXRoIGV4dHJhIGxvZ2ljXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoRmlsZS5wcm90b3R5cGUsICdjb250ZW50cycsIHtcbiAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY29udGVudHM7XG4gIH0sXG4gIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgaWYgKCFpc0J1ZmZlcih2YWwpICYmICFpc1N0cmVhbSh2YWwpICYmICFpc051bGwodmFsKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGaWxlLmNvbnRlbnRzIGNhbiBvbmx5IGJlIGEgQnVmZmVyLCBhIFN0cmVhbSwgb3IgbnVsbC4nKTtcbiAgICB9XG4gICAgdGhpcy5fY29udGVudHMgPSB2YWw7XG4gIH0sXG59KTtcblxuLy8gVE9ETzogU2hvdWxkIHRoaXMgYmUgbW92ZWQgdG8gdmlueWwtZnM/XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoRmlsZS5wcm90b3R5cGUsICdyZWxhdGl2ZScsIHtcbiAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuYmFzZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBiYXNlIHNwZWNpZmllZCEgQ2FuIG5vdCBnZXQgcmVsYXRpdmUuJyk7XG4gICAgfVxuICAgIGlmICghdGhpcy5wYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHBhdGggc3BlY2lmaWVkISBDYW4gbm90IGdldCByZWxhdGl2ZS4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGgucmVsYXRpdmUodGhpcy5iYXNlLCB0aGlzLnBhdGgpO1xuICB9LFxuICBzZXQ6IGZ1bmN0aW9uKCkge1xuICAgIHRocm93IG5ldyBFcnJvcignRmlsZS5yZWxhdGl2ZSBpcyBnZW5lcmF0ZWQgZnJvbSB0aGUgYmFzZSBhbmQgcGF0aCBhdHRyaWJ1dGVzLiBEbyBub3QgbW9kaWZ5IGl0LicpO1xuICB9LFxufSk7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShGaWxlLnByb3RvdHlwZSwgJ2Rpcm5hbWUnLCB7XG4gIGdldDogZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLnBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcGF0aCBzcGVjaWZpZWQhIENhbiBub3QgZ2V0IGRpcm5hbWUuJyk7XG4gICAgfVxuICAgIHJldHVybiBwYXRoLmRpcm5hbWUodGhpcy5wYXRoKTtcbiAgfSxcbiAgc2V0OiBmdW5jdGlvbihkaXJuYW1lKSB7XG4gICAgaWYgKCF0aGlzLnBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcGF0aCBzcGVjaWZpZWQhIENhbiBub3Qgc2V0IGRpcm5hbWUuJyk7XG4gICAgfVxuICAgIHRoaXMucGF0aCA9IHBhdGguam9pbihkaXJuYW1lLCBwYXRoLmJhc2VuYW1lKHRoaXMucGF0aCkpO1xuICB9LFxufSk7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShGaWxlLnByb3RvdHlwZSwgJ2Jhc2VuYW1lJywge1xuICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5wYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHBhdGggc3BlY2lmaWVkISBDYW4gbm90IGdldCBiYXNlbmFtZS4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGguYmFzZW5hbWUodGhpcy5wYXRoKTtcbiAgfSxcbiAgc2V0OiBmdW5jdGlvbihiYXNlbmFtZSkge1xuICAgIGlmICghdGhpcy5wYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHBhdGggc3BlY2lmaWVkISBDYW4gbm90IHNldCBiYXNlbmFtZS4nKTtcbiAgICB9XG4gICAgdGhpcy5wYXRoID0gcGF0aC5qb2luKHBhdGguZGlybmFtZSh0aGlzLnBhdGgpLCBiYXNlbmFtZSk7XG4gIH0sXG59KTtcblxuLy8gUHJvcGVydHkgZm9yIGdldHRpbmcvc2V0dGluZyBzdGVtIG9mIHRoZSBmaWxlbmFtZS5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShGaWxlLnByb3RvdHlwZSwgJ3N0ZW0nLCB7XG4gIGdldDogZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLnBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcGF0aCBzcGVjaWZpZWQhIENhbiBub3QgZ2V0IHN0ZW0uJyk7XG4gICAgfVxuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKHRoaXMucGF0aCwgdGhpcy5leHRuYW1lKTtcbiAgfSxcbiAgc2V0OiBmdW5jdGlvbihzdGVtKSB7XG4gICAgaWYgKCF0aGlzLnBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcGF0aCBzcGVjaWZpZWQhIENhbiBub3Qgc2V0IHN0ZW0uJyk7XG4gICAgfVxuICAgIHRoaXMucGF0aCA9IHBhdGguam9pbihwYXRoLmRpcm5hbWUodGhpcy5wYXRoKSwgc3RlbSArIHRoaXMuZXh0bmFtZSk7XG4gIH0sXG59KTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KEZpbGUucHJvdG90eXBlLCAnZXh0bmFtZScsIHtcbiAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMucGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBwYXRoIHNwZWNpZmllZCEgQ2FuIG5vdCBnZXQgZXh0bmFtZS4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGguZXh0bmFtZSh0aGlzLnBhdGgpO1xuICB9LFxuICBzZXQ6IGZ1bmN0aW9uKGV4dG5hbWUpIHtcbiAgICBpZiAoIXRoaXMucGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBwYXRoIHNwZWNpZmllZCEgQ2FuIG5vdCBzZXQgZXh0bmFtZS4nKTtcbiAgICB9XG4gICAgdGhpcy5wYXRoID0gcmVwbGFjZUV4dCh0aGlzLnBhdGgsIGV4dG5hbWUpO1xuICB9LFxufSk7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShGaWxlLnByb3RvdHlwZSwgJ3BhdGgnLCB7XG4gIGdldDogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeVt0aGlzLmhpc3RvcnkubGVuZ3RoIC0gMV07XG4gIH0sXG4gIHNldDogZnVuY3Rpb24ocGF0aCkge1xuICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncGF0aCBzaG91bGQgYmUgc3RyaW5nJyk7XG4gICAgfVxuXG4gICAgLy8gUmVjb3JkIGhpc3Rvcnkgb25seSB3aGVuIHBhdGggY2hhbmdlZFxuICAgIGlmIChwYXRoICYmIHBhdGggIT09IHRoaXMucGF0aCkge1xuICAgICAgdGhpcy5oaXN0b3J5LnB1c2gocGF0aCk7XG4gICAgfVxuICB9LFxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gRmlsZTtcbiJdfQ==