'use strict';
var fs = require('fs');
var path = require('path');
var through = require('through2');
var mkdirp = require('mkdirp');
var rimraf = require('rimraf');
function write(file) {
    var dir = path.dirname(file.path);
    if (!fs.existsSync(dir)) {
        mkdirp.sync(dir);
    }
    fs.writeFileSync(file.path, file.contents, {
        mode: file.stat ? file.stat.mode : null
    });
}
function remove(file) {
    rimraf.sync(file.path);
}
module.exports = function (filters, cb) {
    var store = this.store;
    if (arguments.length === 1) {
        cb = filters;
        filters = [];
    }
    var modifiedFilter = through.obj(function (file, enc, cb) {
        // Don't process deleted file who haven't been commited yet.
        if (file.state === 'modified' || (file.state === 'deleted' && !file.isNew)) {
            this.push(file);
        }
        cb();
    });
    var commitFilter = through.obj(function (file, enc, cb) {
        store.add(file);
        if (file.state === 'modified') {
            write(file);
        }
        else if (file.state === 'deleted') {
            remove(file);
        }
        delete file.state;
        delete file.isNew;
        cb();
    });
    filters.unshift(modifiedFilter);
    filters.push(commitFilter);
    var stream = filters.reduce(function (stream, filter) {
        return stream.pipe(filter);
    }, this.store.stream());
    stream.on('finish', cb);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxtZW0tZnMtZWRpdG9yXFxsaWJcXGFjdGlvbnNcXGNvbW1pdC5qcyIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxtZW0tZnMtZWRpdG9yXFxsaWJcXGFjdGlvbnNcXGNvbW1pdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRS9CLGVBQWUsSUFBSTtJQUNqQixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUNELEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFO1FBQ3pDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUk7S0FDeEMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELGdCQUFnQixJQUFJO0lBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLENBQUM7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLFVBQVUsT0FBTyxFQUFFLEVBQUU7SUFDcEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUV2QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0IsRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUNiLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsSUFBSSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN0RCw0REFBNEQ7UUFDNUQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxVQUFVLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0UsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsQixDQUFDO1FBRUQsRUFBRSxFQUFFLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDcEQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDOUIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2QsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2YsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEIsRUFBRSxFQUFFLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDaEMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUUzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsTUFBTSxFQUFFLE1BQU07UUFDbEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0IsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUV4QixNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMxQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciB0aHJvdWdoID0gcmVxdWlyZSgndGhyb3VnaDInKTtcbnZhciBta2RpcnAgPSByZXF1aXJlKCdta2RpcnAnKTtcbnZhciByaW1yYWYgPSByZXF1aXJlKCdyaW1yYWYnKTtcblxuZnVuY3Rpb24gd3JpdGUoZmlsZSkge1xuICB2YXIgZGlyID0gcGF0aC5kaXJuYW1lKGZpbGUucGF0aCk7XG4gIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKSB7XG4gICAgbWtkaXJwLnN5bmMoZGlyKTtcbiAgfVxuICBmcy53cml0ZUZpbGVTeW5jKGZpbGUucGF0aCwgZmlsZS5jb250ZW50cywge1xuICAgIG1vZGU6IGZpbGUuc3RhdCA/IGZpbGUuc3RhdC5tb2RlIDogbnVsbFxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlKGZpbGUpIHtcbiAgcmltcmFmLnN5bmMoZmlsZS5wYXRoKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZmlsdGVycywgY2IpIHtcbiAgdmFyIHN0b3JlID0gdGhpcy5zdG9yZTtcblxuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNiID0gZmlsdGVycztcbiAgICBmaWx0ZXJzID0gW107XG4gIH1cblxuICB2YXIgbW9kaWZpZWRGaWx0ZXIgPSB0aHJvdWdoLm9iaihmdW5jdGlvbiAoZmlsZSwgZW5jLCBjYikge1xuICAgIC8vIERvbid0IHByb2Nlc3MgZGVsZXRlZCBmaWxlIHdobyBoYXZlbid0IGJlZW4gY29tbWl0ZWQgeWV0LlxuICAgIGlmIChmaWxlLnN0YXRlID09PSAnbW9kaWZpZWQnIHx8IChmaWxlLnN0YXRlID09PSAnZGVsZXRlZCcgJiYgIWZpbGUuaXNOZXcpKSB7XG4gICAgICB0aGlzLnB1c2goZmlsZSk7XG4gICAgfVxuXG4gICAgY2IoKTtcbiAgfSk7XG5cbiAgdmFyIGNvbW1pdEZpbHRlciA9IHRocm91Z2gub2JqKGZ1bmN0aW9uIChmaWxlLCBlbmMsIGNiKSB7XG4gICAgc3RvcmUuYWRkKGZpbGUpO1xuICAgIGlmIChmaWxlLnN0YXRlID09PSAnbW9kaWZpZWQnKSB7XG4gICAgICB3cml0ZShmaWxlKTtcbiAgICB9IGVsc2UgaWYgKGZpbGUuc3RhdGUgPT09ICdkZWxldGVkJykge1xuICAgICAgcmVtb3ZlKGZpbGUpO1xuICAgIH1cblxuICAgIGRlbGV0ZSBmaWxlLnN0YXRlO1xuICAgIGRlbGV0ZSBmaWxlLmlzTmV3O1xuICAgIGNiKCk7XG4gIH0pO1xuXG4gIGZpbHRlcnMudW5zaGlmdChtb2RpZmllZEZpbHRlcik7XG4gIGZpbHRlcnMucHVzaChjb21taXRGaWx0ZXIpO1xuXG4gIHZhciBzdHJlYW0gPSBmaWx0ZXJzLnJlZHVjZShmdW5jdGlvbiAoc3RyZWFtLCBmaWx0ZXIpIHtcbiAgICByZXR1cm4gc3RyZWFtLnBpcGUoZmlsdGVyKTtcbiAgfSwgdGhpcy5zdG9yZS5zdHJlYW0oKSk7XG5cbiAgc3RyZWFtLm9uKCdmaW5pc2gnLCBjYik7XG59O1xuIl19