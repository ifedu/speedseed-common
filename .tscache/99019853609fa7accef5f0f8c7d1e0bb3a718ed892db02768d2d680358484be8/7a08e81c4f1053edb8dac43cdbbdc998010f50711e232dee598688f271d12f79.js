'use strict';
var url = require('url');
var gitHosts = require('./git-host-info.js');
var GitHost = module.exports = require('./git-host.js');
var protocolToRepresentationMap = {
    'git+ssh': 'sshurl',
    'git+https': 'https',
    'ssh': 'sshurl',
    'git': 'git'
};
function protocolToRepresentation(protocol) {
    if (protocol.substr(-1) === ':')
        protocol = protocol.slice(0, -1);
    return protocolToRepresentationMap[protocol] || protocol;
}
var authProtocols = {
    'git:': true,
    'https:': true,
    'git+https:': true,
    'http:': true,
    'git+http:': true
};
var cache = {};
module.exports.fromUrl = function (giturl, opts) {
    var key = giturl + JSON.stringify(opts || {});
    if (!(key in cache)) {
        cache[key] = fromUrl(giturl, opts);
    }
    return cache[key];
};
function fromUrl(giturl, opts) {
    if (giturl == null || giturl === '')
        return;
    var url = fixupUnqualifiedGist(isGitHubShorthand(giturl) ? 'github:' + giturl : giturl);
    var parsed = parseGitUrl(url);
    var shortcutMatch = url.match(new RegExp('^([^:]+):(?:(?:[^@:]+(?:[^@]+)?@)?([^/]*))[/](.+?)(?:[.]git)?($|#)'));
    var matches = Object.keys(gitHosts).map(function (gitHostName) {
        try {
            var gitHostInfo = gitHosts[gitHostName];
            var auth = null;
            if (parsed.auth && authProtocols[parsed.protocol]) {
                auth = decodeURIComponent(parsed.auth);
            }
            var committish = parsed.hash ? decodeURIComponent(parsed.hash.substr(1)) : null;
            var user = null;
            var project = null;
            var defaultRepresentation = null;
            if (shortcutMatch && shortcutMatch[1] === gitHostName) {
                user = shortcutMatch[2] && decodeURIComponent(shortcutMatch[2]);
                project = decodeURIComponent(shortcutMatch[3]);
                defaultRepresentation = 'shortcut';
            }
            else {
                if (parsed.host !== gitHostInfo.domain)
                    return;
                if (!gitHostInfo.protocols_re.test(parsed.protocol))
                    return;
                if (!parsed.path)
                    return;
                var pathmatch = gitHostInfo.pathmatch;
                var matched = parsed.path.match(pathmatch);
                if (!matched)
                    return;
                if (matched[1] != null)
                    user = decodeURIComponent(matched[1].replace(/^:/, ''));
                if (matched[2] != null)
                    project = decodeURIComponent(matched[2]);
                defaultRepresentation = protocolToRepresentation(parsed.protocol);
            }
            return new GitHost(gitHostName, user, auth, project, committish, defaultRepresentation, opts);
        }
        catch (ex) {
            if (!(ex instanceof URIError))
                throw ex;
        }
    }).filter(function (gitHostInfo) { return gitHostInfo; });
    if (matches.length !== 1)
        return;
    return matches[0];
}
function isGitHubShorthand(arg) {
    // Note: This does not fully test the git ref format.
    // See https://www.kernel.org/pub/software/scm/git/docs/git-check-ref-format.html
    //
    // The only way to do this properly would be to shell out to
    // git-check-ref-format, and as this is a fast sync function,
    // we don't want to do that.  Just let git fail if it turns
    // out that the commit-ish is invalid.
    // GH usernames cannot start with . or -
    return /^[^:@%/\s.-][^:@%/\s]*[/][^:@\s/%]+(?:#.*)?$/.test(arg);
}
function fixupUnqualifiedGist(giturl) {
    // necessary for round-tripping gists
    var parsed = url.parse(giturl);
    if (parsed.protocol === 'gist:' && parsed.host && !parsed.path) {
        return parsed.protocol + '/' + parsed.host;
    }
    else {
        return giturl;
    }
}
function parseGitUrl(giturl) {
    if (typeof giturl !== 'string')
        giturl = '' + giturl;
    var matched = giturl.match(/^([^@]+)@([^:/]+):[/]?((?:[^/]+[/])?[^/]+?)(?:[.]git)?(#.*)?$/);
    if (!matched)
        return url.parse(giturl);
    return {
        protocol: 'git+ssh:',
        slashes: true,
        auth: matched[1],
        host: matched[2],
        port: null,
        hostname: matched[2],
        hash: matched[4],
        search: null,
        query: null,
        pathname: '/' + matched[3],
        path: '/' + matched[3],
        href: 'git+ssh://' + matched[1] + '@' + matched[2] +
            '/' + matched[3] + (matched[4] || '')
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxob3N0ZWQtZ2l0LWluZm9cXGluZGV4LmpzIiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGlmZWR1XFxBcHBEYXRhXFxSb2FtaW5nXFxudm1cXHY4LjQuMFxcbm9kZV9tb2R1bGVzXFxnZW5lcmF0b3Itc3BlZWRzZWVkXFxub2RlX21vZHVsZXNcXGhvc3RlZC1naXQtaW5mb1xcaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBO0FBQ1osSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3hCLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0FBQzVDLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBRXZELElBQUksMkJBQTJCLEdBQUc7SUFDaEMsU0FBUyxFQUFFLFFBQVE7SUFDbkIsV0FBVyxFQUFFLE9BQU87SUFDcEIsS0FBSyxFQUFFLFFBQVE7SUFDZixLQUFLLEVBQUUsS0FBSztDQUNiLENBQUE7QUFFRCxrQ0FBbUMsUUFBUTtJQUN6QyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDO1FBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDakUsTUFBTSxDQUFDLDJCQUEyQixDQUFDLFFBQVEsQ0FBQyxJQUFJLFFBQVEsQ0FBQTtBQUMxRCxDQUFDO0FBRUQsSUFBSSxhQUFhLEdBQUc7SUFDbEIsTUFBTSxFQUFFLElBQUk7SUFDWixRQUFRLEVBQUUsSUFBSTtJQUNkLFlBQVksRUFBRSxJQUFJO0lBQ2xC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QUNoQixJQUFJLEVBQUUsSUFBSTtRQUNWLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLE1BQU0sRUFBRSxJQUFJO1FBQ1osS0FBSyxFQUFFLElBQUk7UUFDWCxRQUFRLEVBQUUsR0FBRyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDMUIsSUFBSSxFQUFFLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLElBQUksRUFBRSxZQUFZLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQzVDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQzVDLENBQUE7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG52YXIgdXJsID0gcmVxdWlyZSgndXJsJylcbnZhciBnaXRIb3N0cyA9IHJlcXVpcmUoJy4vZ2l0LWhvc3QtaW5mby5qcycpXG52YXIgR2l0SG9zdCA9IG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9naXQtaG9zdC5qcycpXG5cbnZhciBwcm90b2NvbFRvUmVwcmVzZW50YXRpb25NYXAgPSB7XG4gICdnaXQrc3NoJzogJ3NzaHVybCcsXG4gICdnaXQraHR0cHMnOiAnaHR0cHMnLFxuICAnc3NoJzogJ3NzaHVybCcsXG4gICdnaXQnOiAnZ2l0J1xufVxuXG5mdW5jdGlvbiBwcm90b2NvbFRvUmVwcmVzZW50YXRpb24gKHByb3RvY29sKSB7XG4gIGlmIChwcm90b2NvbC5zdWJzdHIoLTEpID09PSAnOicpIHByb3RvY29sID0gcHJvdG9jb2wuc2xpY2UoMCwgLTEpXG4gIHJldHVybiBwcm90b2NvbFRvUmVwcmVzZW50YXRpb25NYXBbcHJvdG9jb2xdIHx8IHByb3RvY29sXG59XG5cbnZhciBhdXRoUHJvdG9jb2xzID0ge1xuICAnZ2l0Oic6IHRydWUsXG4gICdodHRwczonOiB0cnVlLFxuICAnZ2l0K2h0dHBzOic6IHRydWUsXG4gICdodHRwOic6IHRydWUsXG4gICdnaXQraHR0cDonOiB0cnVlXG59XG5cbnZhciBjYWNoZSA9IHt9XG5cbm1vZHVsZS5leHBvcnRzLmZyb21VcmwgPSBmdW5jdGlvbiAoZ2l0dXJsLCBvcHRzKSB7XG4gIHZhciBrZXkgPSBnaXR1cmwgKyBKU09OLnN0cmluZ2lmeShvcHRzIHx8IHt9KVxuXG4gIGlmICghKGtleSBpbiBjYWNoZSkpIHtcbiAgICBjYWNoZVtrZXldID0gZnJvbVVybChnaXR1cmwsIG9wdHMpXG4gIH1cblxuICByZXR1cm4gY2FjaGVba2V5XVxufVxuXG5mdW5jdGlvbiBmcm9tVXJsIChnaXR1cmwsIG9wdHMpIHtcbiAgaWYgKGdpdHVybCA9PSBudWxsIHx8IGdpdHVybCA9PT0gJycpIHJldHVyblxuICB2YXIgdXJsID0gZml4dXBVbnF1YWxpZmllZEdpc3QoXG4gICAgaXNHaXRIdWJTaG9ydGhhbmQoZ2l0dXJsKSA/ICdnaXRodWI6JyArIGdpdHVybCA6IGdpdHVybFxuICApXG4gIHZhciBwYXJzZWQgPSBwYXJzZUdpdFVybCh1cmwpXG4gIHZhciBzaG9ydGN1dE1hdGNoID0gdXJsLm1hdGNoKG5ldyBSZWdFeHAoJ14oW146XSspOig/Oig/OlteQDpdKyg/OlteQF0rKT9AKT8oW14vXSopKVsvXSguKz8pKD86Wy5dZ2l0KT8oJHwjKScpKVxuICB2YXIgbWF0Y2hlcyA9IE9iamVjdC5rZXlzKGdpdEhvc3RzKS5tYXAoZnVuY3Rpb24gKGdpdEhvc3ROYW1lKSB7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBnaXRIb3N0SW5mbyA9IGdpdEhvc3RzW2dpdEhvc3ROYW1lXVxuICAgICAgdmFyIGF1dGggPSBudWxsXG4gICAgICBpZiAocGFyc2VkLmF1dGggJiYgYXV0aFByb3RvY29sc1twYXJzZWQucHJvdG9jb2xdKSB7XG4gICAgICAgIGF1dGggPSBkZWNvZGVVUklDb21wb25lbnQocGFyc2VkLmF1dGgpXG4gICAgICB9XG4gICAgICB2YXIgY29tbWl0dGlzaCA9IHBhcnNlZC5oYXNoID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcnNlZC5oYXNoLnN1YnN0cigxKSkgOiBudWxsXG4gICAgICB2YXIgdXNlciA9IG51bGxcbiAgICAgIHZhciBwcm9qZWN0ID0gbnVsbFxuICAgICAgdmFyIGRlZmF1bHRSZXByZXNlbnRhdGlvbiA9IG51bGxcbiAgICAgIGlmIChzaG9ydGN1dE1hdGNoICYmIHNob3J0Y3V0TWF0Y2hbMV0gPT09IGdpdEhvc3ROYW1lKSB7XG4gICAgICAgIHVzZXIgPSBzaG9ydGN1dE1hdGNoWzJdICYmIGRlY29kZVVSSUNvbXBvbmVudChzaG9ydGN1dE1hdGNoWzJdKVxuICAgICAgICBwcm9qZWN0ID0gZGVjb2RlVVJJQ29tcG9uZW50KHNob3J0Y3V0TWF0Y2hbM10pXG4gICAgICAgIGRlZmF1bHRSZXByZXNlbnRhdGlvbiA9ICdzaG9ydGN1dCdcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChwYXJzZWQuaG9zdCAhPT0gZ2l0SG9zdEluZm8uZG9tYWluKSByZXR1cm5cbiAgICAgICAgaWYgKCFnaXRIb3N0SW5mby5wcm90b2NvbHNfcmUudGVzdChwYXJzZWQucHJvdG9jb2wpKSByZXR1cm5cbiAgICAgICAgaWYgKCFwYXJzZWQucGF0aCkgcmV0dXJuXG4gICAgICAgIHZhciBwYXRobWF0Y2ggPSBnaXRIb3N0SW5mby5wYXRobWF0Y2hcbiAgICAgICAgdmFyIG1hdGNoZWQgPSBwYXJzZWQucGF0aC5tYXRjaChwYXRobWF0Y2gpXG4gICAgICAgIGlmICghbWF0Y2hlZCkgcmV0dXJuXG4gICAgICAgIGlmIChtYXRjaGVkWzFdICE9IG51bGwpIHVzZXIgPSBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hlZFsxXS5yZXBsYWNlKC9eOi8sICcnKSlcbiAgICAgICAgaWYgKG1hdGNoZWRbMl0gIT0gbnVsbCkgcHJvamVjdCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaGVkWzJdKVxuICAgICAgICBkZWZhdWx0UmVwcmVzZW50YXRpb24gPSBwcm90b2NvbFRvUmVwcmVzZW50YXRpb24ocGFyc2VkLnByb3RvY29sKVxuICAgICAgfVxuICAgICAgcmV0dXJuIG5ldyBHaXRIb3N0KGdpdEhvc3ROYW1lLCB1c2VyLCBhdXRoLCBwcm9qZWN0LCBjb21taXR0aXNoLCBkZWZhdWx0UmVwcmVzZW50YXRpb24sIG9wdHMpXG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGlmICghKGV4IGluc3RhbmNlb2YgVVJJRXJyb3IpKSB0aHJvdyBleFxuICAgIH1cbiAgfSkuZmlsdGVyKGZ1bmN0aW9uIChnaXRIb3N0SW5mbykgeyByZXR1cm4gZ2l0SG9zdEluZm8gfSlcbiAgaWYgKG1hdGNoZXMubGVuZ3RoICE9PSAxKSByZXR1cm5cbiAgcmV0dXJuIG1hdGNoZXNbMF1cbn1cblxuZnVuY3Rpb24gaXNHaXRIdWJTaG9ydGhhbmQgKGFyZykge1xuICAvLyBOb3RlOiBUaGlzIGRvZXMgbm90IGZ1bGx5IHRlc3QgdGhlIGdpdCByZWYgZm9ybWF0LlxuICAvLyBTZWUgaHR0cHM6Ly93d3cua2VybmVsLm9yZy9wdWIvc29mdHdhcmUvc2NtL2dpdC9kb2NzL2dpdC1jaGVjay1yZWYtZm9ybWF0Lmh0bWxcbiAgLy9cbiAgLy8gVGhlIG9ubHkgd2F5IHRvIGRvIHRoaXMgcHJvcGVybHkgd291bGQgYmUgdG8gc2hlbGwgb3V0IHRvXG4gIC8vIGdpdC1jaGVjay1yZWYtZm9ybWF0LCBhbmQgYXMgdGhpcyBpcyBhIGZhc3Qgc3luYyBmdW5jdGlvbixcbiAgLy8gd2UgZG9uJ3Qgd2FudCB0byBkbyB0aGF0LiAgSnVzdCBsZXQgZ2l0IGZhaWwgaWYgaXQgdHVybnNcbiAgLy8gb3V0IHRoYXQgdGhlIGNvbW1pdC1pc2ggaXMgaW52YWxpZC5cbiAgLy8gR0ggdXNlcm5hbWVzIGNhbm5vdCBzdGFydCB3aXRoIC4gb3IgLVxuICByZXR1cm4gL15bXjpAJS9cXHMuLV1bXjpAJS9cXHNdKlsvXVteOkBcXHMvJV0rKD86Iy4qKT8kLy50ZXN0KGFyZylcbn1cblxuZnVuY3Rpb24gZml4dXBVbnF1YWxpZmllZEdpc3QgKGdpdHVybCkge1xuICAvLyBuZWNlc3NhcnkgZm9yIHJvdW5kLXRyaXBwaW5nIGdpc3RzXG4gIHZhciBwYXJzZWQgPSB1cmwucGFyc2UoZ2l0dXJsKVxuICBpZiAocGFyc2VkLnByb3RvY29sID09PSAnZ2lzdDonICYmIHBhcnNlZC5ob3N0ICYmICFwYXJzZWQucGF0aCkge1xuICAgIHJldHVybiBwYXJzZWQucHJvdG9jb2wgKyAnLycgKyBwYXJzZWQuaG9zdFxuICB9IGVsc2Uge1xuICAgIHJldHVybiBnaXR1cmxcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUdpdFVybCAoZ2l0dXJsKSB7XG4gIGlmICh0eXBlb2YgZ2l0dXJsICE9PSAnc3RyaW5nJykgZ2l0dXJsID0gJycgKyBnaXR1cmxcbiAgdmFyIG1hdGNoZWQgPSBnaXR1cmwubWF0Y2goL14oW15AXSspQChbXjovXSspOlsvXT8oKD86W14vXStbL10pP1teL10rPykoPzpbLl1naXQpPygjLiopPyQvKVxuICBpZiAoIW1hdGNoZWQpIHJldHVybiB1cmwucGFyc2UoZ2l0dXJsKVxuICByZXR1cm4ge1xuICAgIHByb3RvY29sOiAnZ2l0K3NzaDonLFxuICAgIHNsYXNoZXM6IHRydWUsXG4gICAgYXV0aDogbWF0Y2hlZFsxXSxcbiAgICBob3N0OiBtYXRjaGVkWzJdLFxuICAgIHBvcnQ6IG51bGwsXG4gICAgaG9zdG5hbWU6IG1hdGNoZWRbMl0sXG4gICAgaGFzaDogbWF0Y2hlZFs0XSxcbiAgICBzZWFyY2g6IG51bGwsXG4gICAgcXVlcnk6IG51bGwsXG4gICAgcGF0aG5hbWU6ICcvJyArIG1hdGNoZWRbM10sXG4gICAgcGF0aDogJy8nICsgbWF0Y2hlZFszXSxcbiAgICBocmVmOiAnZ2l0K3NzaDovLycgKyBtYXRjaGVkWzFdICsgJ0AnICsgbWF0Y2hlZFsyXSArXG4gICAgICAgICAgJy8nICsgbWF0Y2hlZFszXSArIChtYXRjaGVkWzRdIHx8ICcnKVxuICB9XG59XG4iXX0=