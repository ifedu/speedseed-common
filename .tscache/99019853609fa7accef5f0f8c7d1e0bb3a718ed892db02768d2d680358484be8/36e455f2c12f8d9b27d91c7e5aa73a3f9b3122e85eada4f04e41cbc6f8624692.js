// Generated by CoffeeScript 1.11.1
/*
  ExternalEditor
  Kevin Gravier <kevin@mrkmg.com>
  MIT
 */
(function () {
    var CreateFileError, ExternalEditor, FS, LaunchEditorError, ReadFileError, RemoveFileError, Spawn, SpawnSync, Temp, bind = function (fn, me) { return function () { return fn.apply(me, arguments); }; };
    FS = require('fs');
    Temp = require('tmp');
    SpawnSync = require('spawn-sync');
    Spawn = require('child_process').spawn;
    CreateFileError = require('./errors/CreateFileError');
    ReadFileError = require('./errors/ReadFileError');
    RemoveFileError = require('./errors/RemoveFileError');
    LaunchEditorError = require('./errors/LaunchEditorError');
    ExternalEditor = (function () {
        ExternalEditor.edit = function (text) {
            var editor;
            if (text == null) {
                text = '';
            }
            editor = new ExternalEditor(text);
            editor.run();
            editor.cleanup();
            return editor.text;
        };
        ExternalEditor.editAsync = function (text, callback) {
            var editor;
            if (text == null) {
                text = '';
            }
            editor = new ExternalEditor(text);
            return editor.runAsync(function (error_run, response) {
                var error_cleanup;
                if (!error_run) {
                    try {
                        editor.cleanup();
                    }
                    catch (error) {
                        error_cleanup = error;
                        if (typeof callback === 'function') {
                            callback(error_cleanup);
                        }
                    }
                    return callback(null, response);
                }
                else {
                    return callback(error_run) in typeof callback === 'function';
                }
            });
        };
        ExternalEditor.CreateFileError = CreateFileError;
        ExternalEditor.ReadFileError = ReadFileError;
        ExternalEditor.RemoveFileError = RemoveFileError;
        ExternalEditor.LaunchEditorError = LaunchEditorError;
        ExternalEditor.prototype.text = '';
        ExternalEditor.prototype.temp_file = void 0;
        ExternalEditor.prototype.editor = {
            bin: void 0,
            args: []
        };
        function ExternalEditor(text1) {
            this.text = text1 != null ? text1 : '';
            this.launchEditorAsync = bind(this.launchEditorAsync, this);
            this.launchEditor = bind(this.launchEditor, this);
            this.removeTemporaryFile = bind(this.removeTemporaryFile, this);
            this.readTemporaryFile = bind(this.readTemporaryFile, this);
            this.createTemporaryFile = bind(this.createTemporaryFile, this);
            this.determineEditor = bind(this.determineEditor, this);
            this.cleanup = bind(this.cleanup, this);
            this.runAsync = bind(this.runAsync, this);
            this.run = bind(this.run, this);
            this.determineEditor();
            this.createTemporaryFile();
        }
        ExternalEditor.prototype.run = function () {
            this.launchEditor();
            return this.readTemporaryFile();
        };
        ExternalEditor.prototype.runAsync = function (callback) {
            var error_launch;
            try {
                return this.launchEditorAsync((function (_this) {
                    return function () {
                        var error_read;
                        try {
                            _this.readTemporaryFile();
                            if (typeof callback === 'function') {
                                return callback(null, _this.text);
                            }
                        }
                        catch (error) {
                            error_read = error;
                            if (typeof callback === 'function') {
                                return callback(error_read);
                            }
                        }
                    };
                })(this));
            }
            catch (error) {
                error_launch = error;
                if (typeof callback === 'function') {
                    return callback(error_launch);
                }
            }
        };
        ExternalEditor.prototype.cleanup = function () {
            return this.removeTemporaryFile();
        };
        ExternalEditor.prototype.determineEditor = function () {
            var args, ed, editor;
            ed = /^win/.test(process.platform) ? 'notepad' : 'vim';
            editor = process.env.VISUAL || process.env.EDITOR || ed;
            args = editor.split(/\s+/);
            this.bin = args.shift();
            return this.args = args;
        };
        ExternalEditor.prototype.createTemporaryFile = function () {
            var e;
            try {
                this.temp_file = Temp.tmpNameSync({});
                return FS.writeFileSync(this.temp_file, this.text);
            }
            catch (error) {
                e = error;
                throw new CreateFileError(e);
            }
        };
        ExternalEditor.prototype.readTemporaryFile = function () {
            var e;
            try {
                return this.text = FS.readFileSync(this.temp_file).toString();
            }
            catch (error) {
                e = error;
                throw new ReadFileError(e);
            }
        };
        ExternalEditor.prototype.removeTemporaryFile = function () {
            var e;
            try {
                return FS.unlinkSync(this.temp_file);
            }
            catch (error) {
                e = error;
                throw new RemoveFileError(e);
            }
        };
        ExternalEditor.prototype.launchEditor = function () {
            var e;
            try {
                return SpawnSync(this.bin, this.args.concat([this.temp_file]), {
                    stdio: 'inherit'
                });
            }
            catch (error) {
                e = error;
                throw new LaunchEditorError(e);
            }
        };
        ExternalEditor.prototype.launchEditorAsync = function (callback) {
            var child_process, e;
            try {
                child_process = Spawn(this.bin, this.args.concat([this.temp_file]), {
                    stdio: 'inherit'
                });
                return child_process.on('exit', function () {
                    if (typeof callback === 'function') {
                        return callback();
                    }
                });
            }
            catch (error) {
                e = error;
                throw new LaunchEditorError(e);
            }
        };
        return ExternalEditor;
    })();
    module.exports = ExternalEditor;
}).call(this);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxleHRlcm5hbC1lZGl0b3JcXG1haW5cXGluZGV4LmpzIiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGlmZWR1XFxBcHBEYXRhXFxSb2FtaW5nXFxudm1cXHY4LjQuMFxcbm9kZV9tb2R1bGVzXFxnZW5lcmF0b3Itc3BlZWRzZWVkXFxub2RlX21vZHVsZXNcXGV4dGVybmFsLWVkaXRvclxcbWFpblxcaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsbUNBQW1DO0FBRW5DOzs7O0dBSUc7QUFFSCxDQUFDO0lBQ0MsSUFBSSxlQUFlLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUNoSCxJQUFJLEdBQUcsVUFBUyxFQUFFLEVBQUUsRUFBRSxJQUFHLE1BQU0sQ0FBQyxjQUFZLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVuRixFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRW5CLElBQUksR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFdEIsU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUVsQyxLQUFLLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUV2QyxlQUFlLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFFdEQsYUFBYSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBRWxELGVBQWUsR0FBRyxPQUFPLENBQUMsMEJBQTBCLENBQUMsQ0FBQztJQUV0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UUFBUSxFQUFFLENBQUM7b0JBQ3BCLENBQUM7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDZixDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUNWLE1BQU0sSUFBSSxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDO1FBRUYsTUFBTSxDQUFDLGNBQWMsQ0FBQztJQUV4QixDQUFDLENBQUMsRUFBRSxDQUFDO0lBRUwsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUM7QUFFbEMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjExLjFcblxuLypcbiAgRXh0ZXJuYWxFZGl0b3JcbiAgS2V2aW4gR3JhdmllciA8a2V2aW5AbXJrbWcuY29tPlxuICBNSVRcbiAqL1xuXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBDcmVhdGVGaWxlRXJyb3IsIEV4dGVybmFsRWRpdG9yLCBGUywgTGF1bmNoRWRpdG9yRXJyb3IsIFJlYWRGaWxlRXJyb3IsIFJlbW92ZUZpbGVFcnJvciwgU3Bhd24sIFNwYXduU3luYywgVGVtcCxcbiAgICBiaW5kID0gZnVuY3Rpb24oZm4sIG1lKXsgcmV0dXJuIGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTsgfTsgfTtcblxuICBGUyA9IHJlcXVpcmUoJ2ZzJyk7XG5cbiAgVGVtcCA9IHJlcXVpcmUoJ3RtcCcpO1xuXG4gIFNwYXduU3luYyA9IHJlcXVpcmUoJ3NwYXduLXN5bmMnKTtcblxuICBTcGF3biA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5zcGF3bjtcblxuICBDcmVhdGVGaWxlRXJyb3IgPSByZXF1aXJlKCcuL2Vycm9ycy9DcmVhdGVGaWxlRXJyb3InKTtcblxuICBSZWFkRmlsZUVycm9yID0gcmVxdWlyZSgnLi9lcnJvcnMvUmVhZEZpbGVFcnJvcicpO1xuXG4gIFJlbW92ZUZpbGVFcnJvciA9IHJlcXVpcmUoJy4vZXJyb3JzL1JlbW92ZUZpbGVFcnJvcicpO1xuXG4gIExhdW5jaEVkaXRvckVycm9yID0gcmVxdWlyZSgnLi9lcnJvcnMvTGF1bmNoRWRpdG9yRXJyb3InKTtcblxuICBFeHRlcm5hbEVkaXRvciA9IChmdW5jdGlvbigpIHtcbiAgICBFeHRlcm5hbEVkaXRvci5lZGl0ID0gZnVuY3Rpb24odGV4dCkge1xuICAgICAgdmFyIGVkaXRvcjtcbiAgICAgIGlmICh0ZXh0ID09IG51bGwpIHtcbiAgICAgICAgdGV4dCA9ICcnO1xuICAgICAgfVxuICAgICAgZWRpdG9yID0gbmV3IEV4dGVybmFsRWRpdG9yKHRleHQpO1xuICAgICAgZWRpdG9yLnJ1bigpO1xuICAgICAgZWRpdG9yLmNsZWFudXAoKTtcbiAgICAgIHJldHVybiBlZGl0b3IudGV4dDtcbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IuZWRpdEFzeW5jID0gZnVuY3Rpb24odGV4dCwgY2FsbGJhY2spIHtcbiAgICAgIHZhciBlZGl0b3I7XG4gICAgICBpZiAodGV4dCA9PSBudWxsKSB7XG4gICAgICAgIHRleHQgPSAnJztcbiAgICAgIH1cbiAgICAgIGVkaXRvciA9IG5ldyBFeHRlcm5hbEVkaXRvcih0ZXh0KTtcbiAgICAgIHJldHVybiBlZGl0b3IucnVuQXN5bmMoZnVuY3Rpb24oZXJyb3JfcnVuLCByZXNwb25zZSkge1xuICAgICAgICB2YXIgZXJyb3JfY2xlYW51cDtcbiAgICAgICAgaWYgKCFlcnJvcl9ydW4pIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZWRpdG9yLmNsZWFudXAoKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3JfY2xlYW51cCA9IGVycm9yO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvcl9jbGVhbnVwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JfcnVuKSBpbiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbic7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBFeHRlcm5hbEVkaXRvci5DcmVhdGVGaWxlRXJyb3IgPSBDcmVhdGVGaWxlRXJyb3I7XG5cbiAgICBFeHRlcm5hbEVkaXRvci5SZWFkRmlsZUVycm9yID0gUmVhZEZpbGVFcnJvcjtcblxuICAgIEV4dGVybmFsRWRpdG9yLlJlbW92ZUZpbGVFcnJvciA9IFJlbW92ZUZpbGVFcnJvcjtcblxuICAgIEV4dGVybmFsRWRpdG9yLkxhdW5jaEVkaXRvckVycm9yID0gTGF1bmNoRWRpdG9yRXJyb3I7XG5cbiAgICBFeHRlcm5hbEVkaXRvci5wcm90b3R5cGUudGV4dCA9ICcnO1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLnRlbXBfZmlsZSA9IHZvaWQgMDtcblxuICAgIEV4dGVybmFsRWRpdG9yLnByb3RvdHlwZS5lZGl0b3IgPSB7XG4gICAgICBiaW46IHZvaWQgMCxcbiAgICAgIGFyZ3M6IFtdXG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIEV4dGVybmFsRWRpdG9yKHRleHQxKSB7XG4gICAgICB0aGlzLnRleHQgPSB0ZXh0MSAhPSBudWxsID8gdGV4dDEgOiAnJztcbiAgICAgIHRoaXMubGF1bmNoRWRpdG9yQXN5bmMgPSBiaW5kKHRoaXMubGF1bmNoRWRpdG9yQXN5bmMsIHRoaXMpO1xuICAgICAgdGhpcy5sYXVuY2hFZGl0b3IgPSBiaW5kKHRoaXMubGF1bmNoRWRpdG9yLCB0aGlzKTtcbiAgICAgIHRoaXMucmVtb3ZlVGVtcG9yYXJ5RmlsZSA9IGJpbmQodGhpcy5yZW1vdmVUZW1wb3JhcnlGaWxlLCB0aGlzKTtcbiAgICAgIHRoaXMucmVhZFRlbXBvcmFyeUZpbGUgPSBiaW5kKHRoaXMucmVhZFRlbXBvcmFyeUZpbGUsIHRoaXMpO1xuICAgICAgdGhpcy5jcmVhdGVUZW1wb3JhcnlGaWxlID0gYmluZCh0aGlzLmNyZWF0ZVRlbXBvcmFyeUZpbGUsIHRoaXMpO1xuICAgICAgdGhpcy5kZXRlcm1pbmVFZGl0b3IgPSBiaW5kKHRoaXMuZGV0ZXJtaW5lRWRpdG9yLCB0aGlzKTtcbiAgICAgIHRoaXMuY2xlYW51cCA9IGJpbmQodGhpcy5jbGVhbnVwLCB0aGlzKTtcbiAgICAgIHRoaXMucnVuQXN5bmMgPSBiaW5kKHRoaXMucnVuQXN5bmMsIHRoaXMpO1xuICAgICAgdGhpcy5ydW4gPSBiaW5kKHRoaXMucnVuLCB0aGlzKTtcbiAgICAgIHRoaXMuZGV0ZXJtaW5lRWRpdG9yKCk7XG4gICAgICB0aGlzLmNyZWF0ZVRlbXBvcmFyeUZpbGUoKTtcbiAgICB9XG5cbiAgICBFeHRlcm5hbEVkaXRvci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLmxhdW5jaEVkaXRvcigpO1xuICAgICAgcmV0dXJuIHRoaXMucmVhZFRlbXBvcmFyeUZpbGUoKTtcbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLnJ1bkFzeW5jID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICAgIHZhciBlcnJvcl9sYXVuY2g7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gdGhpcy5sYXVuY2hFZGl0b3JBc3luYygoZnVuY3Rpb24oX3RoaXMpIHtcbiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB2YXIgZXJyb3JfcmVhZDtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIF90aGlzLnJlYWRUZW1wb3JhcnlGaWxlKCk7XG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgX3RoaXMudGV4dCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgIGVycm9yX3JlYWQgPSBlcnJvcjtcbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcl9yZWFkKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH07XG4gICAgICAgIH0pKHRoaXMpKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGVycm9yX2xhdW5jaCA9IGVycm9yO1xuICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yX2xhdW5jaCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLmNsZWFudXAgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlbW92ZVRlbXBvcmFyeUZpbGUoKTtcbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLmRldGVybWluZUVkaXRvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGFyZ3MsIGVkLCBlZGl0b3I7XG4gICAgICBlZCA9IC9ed2luLy50ZXN0KHByb2Nlc3MucGxhdGZvcm0pID8gJ25vdGVwYWQnIDogJ3ZpbSc7XG4gICAgICBlZGl0b3IgPSBwcm9jZXNzLmVudi5WSVNVQUwgfHwgcHJvY2Vzcy5lbnYuRURJVE9SIHx8IGVkO1xuICAgICAgYXJncyA9IGVkaXRvci5zcGxpdCgvXFxzKy8pO1xuICAgICAgdGhpcy5iaW4gPSBhcmdzLnNoaWZ0KCk7XG4gICAgICByZXR1cm4gdGhpcy5hcmdzID0gYXJncztcbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLmNyZWF0ZVRlbXBvcmFyeUZpbGUgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy50ZW1wX2ZpbGUgPSBUZW1wLnRtcE5hbWVTeW5jKHt9KTtcbiAgICAgICAgcmV0dXJuIEZTLndyaXRlRmlsZVN5bmModGhpcy50ZW1wX2ZpbGUsIHRoaXMudGV4dCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBlID0gZXJyb3I7XG4gICAgICAgIHRocm93IG5ldyBDcmVhdGVGaWxlRXJyb3IoZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIEV4dGVybmFsRWRpdG9yLnByb3RvdHlwZS5yZWFkVGVtcG9yYXJ5RmlsZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGU7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXh0ID0gRlMucmVhZEZpbGVTeW5jKHRoaXMudGVtcF9maWxlKS50b1N0cmluZygpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZSA9IGVycm9yO1xuICAgICAgICB0aHJvdyBuZXcgUmVhZEZpbGVFcnJvcihlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgRXh0ZXJuYWxFZGl0b3IucHJvdG90eXBlLnJlbW92ZVRlbXBvcmFyeUZpbGUgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIEZTLnVubGlua1N5bmModGhpcy50ZW1wX2ZpbGUpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZSA9IGVycm9yO1xuICAgICAgICB0aHJvdyBuZXcgUmVtb3ZlRmlsZUVycm9yKGUpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBFeHRlcm5hbEVkaXRvci5wcm90b3R5cGUubGF1bmNoRWRpdG9yID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBTcGF3blN5bmModGhpcy5iaW4sIHRoaXMuYXJncy5jb25jYXQoW3RoaXMudGVtcF9maWxlXSksIHtcbiAgICAgICAgICBzdGRpbzogJ2luaGVyaXQnXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZSA9IGVycm9yO1xuICAgICAgICB0aHJvdyBuZXcgTGF1bmNoRWRpdG9yRXJyb3IoZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIEV4dGVybmFsRWRpdG9yLnByb3RvdHlwZS5sYXVuY2hFZGl0b3JBc3luYyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICB2YXIgY2hpbGRfcHJvY2VzcywgZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNoaWxkX3Byb2Nlc3MgPSBTcGF3bih0aGlzLmJpbiwgdGhpcy5hcmdzLmNvbmNhdChbdGhpcy50ZW1wX2ZpbGVdKSwge1xuICAgICAgICAgIHN0ZGlvOiAnaW5oZXJpdCdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjaGlsZF9wcm9jZXNzLm9uKCdleGl0JywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGUgPSBlcnJvcjtcbiAgICAgICAgdGhyb3cgbmV3IExhdW5jaEVkaXRvckVycm9yKGUpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4gRXh0ZXJuYWxFZGl0b3I7XG5cbiAgfSkoKTtcblxuICBtb2R1bGUuZXhwb3J0cyA9IEV4dGVybmFsRWRpdG9yO1xuXG59KS5jYWxsKHRoaXMpO1xuIl19