'use strict';
var bufferStream = require('./buffer-stream');
function getStream(inputStream, opts) {
    if (!inputStream) {
        return Promise.reject(new Error('Expected a stream'));
    }
    opts = Object.assign({ maxBuffer: Infinity }, opts);
    var maxBuffer = opts.maxBuffer;
    var stream;
    var clean;
    var p = new Promise(function (resolve, reject) {
        var error = function (err) {
            if (err) {
                err.bufferedData = stream.getBufferedValue();
            }
            reject(err);
        };
        stream = bufferStream(opts);
        inputStream.once('error', error);
        inputStream.pipe(stream);
        stream.on('data', function () {
            if (stream.getBufferedLength() > maxBuffer) {
                reject(new Error('maxBuffer exceeded'));
            }
        });
        stream.once('error', error);
        stream.on('end', resolve);
        clean = function () {
            // some streams doesn't implement the `stream.Readable` interface correctly
            if (inputStream.unpipe) {
                inputStream.unpipe(stream);
            }
        };
    });
    p.then(clean, clean);
    return p.then(function () { return stream.getBufferedValue(); });
}
module.exports = getStream;
module.exports.buffer = function (stream, opts) { return getStream(stream, Object.assign({}, opts, { encoding: 'buffer' })); };
module.exports.array = function (stream, opts) { return getStream(stream, Object.assign({}, opts, { array: true })); };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxnZXQtc3RyZWFtXFxpbmRleC5qcyIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxnZXQtc3RyZWFtXFxpbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFDYixJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUVoRCxtQkFBbUIsV0FBVyxFQUFFLElBQUk7SUFDbkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBQyxTQUFTLEVBQUUsUUFBUSxFQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFbEQsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNqQyxJQUFJLE1BQU0sQ0FBQztJQUNYLElBQUksS0FBSyxDQUFDO0lBRVYsSUFBTSxDQUFDLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUNyQyxJQUFNLEtBQUssR0FBRyxVQUFBLEdBQUc7WUFDaEIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDVCxHQUFHLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzlDLENBQUM7WUFFRCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDYixDQUFDLENBQUM7UUFFRixNQUFNLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFekIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7WUFDakIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztZQUN6QyxDQUFDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM1QixNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUUxQixLQUFLLEdBQUc7WUFDUCwyRUFBMkU7WUFDM0UsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3hCLFdBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDNUIsQ0FBQztRQUNGLENBQUMsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFckIsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBTSxPQUFBLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxFQUF6QixDQUF5QixDQUFDLENBQUM7QUFDaEQsQ0FBQztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLFVBQUMsTUFBTSxFQUFFLElBQUksSUFBSyxPQUFBLFNBQVMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUMsUUFBUSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUMsRUFBaEUsQ0FBZ0UsQ0FBQztBQUMzRyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxVQUFDLE1BQU0sRUFBRSxJQUFJLElBQUssT0FBQSxTQUFTLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLEVBQXpELENBQXlELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5jb25zdCBidWZmZXJTdHJlYW0gPSByZXF1aXJlKCcuL2J1ZmZlci1zdHJlYW0nKTtcblxuZnVuY3Rpb24gZ2V0U3RyZWFtKGlucHV0U3RyZWFtLCBvcHRzKSB7XG5cdGlmICghaW5wdXRTdHJlYW0pIHtcblx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdFeHBlY3RlZCBhIHN0cmVhbScpKTtcblx0fVxuXG5cdG9wdHMgPSBPYmplY3QuYXNzaWduKHttYXhCdWZmZXI6IEluZmluaXR5fSwgb3B0cyk7XG5cblx0Y29uc3QgbWF4QnVmZmVyID0gb3B0cy5tYXhCdWZmZXI7XG5cdGxldCBzdHJlYW07XG5cdGxldCBjbGVhbjtcblxuXHRjb25zdCBwID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGNvbnN0IGVycm9yID0gZXJyID0+IHtcblx0XHRcdGlmIChlcnIpIHsgLy8gbnVsbCBjaGVja1xuXHRcdFx0XHRlcnIuYnVmZmVyZWREYXRhID0gc3RyZWFtLmdldEJ1ZmZlcmVkVmFsdWUoKTtcblx0XHRcdH1cblxuXHRcdFx0cmVqZWN0KGVycik7XG5cdFx0fTtcblxuXHRcdHN0cmVhbSA9IGJ1ZmZlclN0cmVhbShvcHRzKTtcblx0XHRpbnB1dFN0cmVhbS5vbmNlKCdlcnJvcicsIGVycm9yKTtcblx0XHRpbnB1dFN0cmVhbS5waXBlKHN0cmVhbSk7XG5cblx0XHRzdHJlYW0ub24oJ2RhdGEnLCAoKSA9PiB7XG5cdFx0XHRpZiAoc3RyZWFtLmdldEJ1ZmZlcmVkTGVuZ3RoKCkgPiBtYXhCdWZmZXIpIHtcblx0XHRcdFx0cmVqZWN0KG5ldyBFcnJvcignbWF4QnVmZmVyIGV4Y2VlZGVkJykpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHN0cmVhbS5vbmNlKCdlcnJvcicsIGVycm9yKTtcblx0XHRzdHJlYW0ub24oJ2VuZCcsIHJlc29sdmUpO1xuXG5cdFx0Y2xlYW4gPSAoKSA9PiB7XG5cdFx0XHQvLyBzb21lIHN0cmVhbXMgZG9lc24ndCBpbXBsZW1lbnQgdGhlIGBzdHJlYW0uUmVhZGFibGVgIGludGVyZmFjZSBjb3JyZWN0bHlcblx0XHRcdGlmIChpbnB1dFN0cmVhbS51bnBpcGUpIHtcblx0XHRcdFx0aW5wdXRTdHJlYW0udW5waXBlKHN0cmVhbSk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fSk7XG5cblx0cC50aGVuKGNsZWFuLCBjbGVhbik7XG5cblx0cmV0dXJuIHAudGhlbigoKSA9PiBzdHJlYW0uZ2V0QnVmZmVyZWRWYWx1ZSgpKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBnZXRTdHJlYW07XG5tb2R1bGUuZXhwb3J0cy5idWZmZXIgPSAoc3RyZWFtLCBvcHRzKSA9PiBnZXRTdHJlYW0oc3RyZWFtLCBPYmplY3QuYXNzaWduKHt9LCBvcHRzLCB7ZW5jb2Rpbmc6ICdidWZmZXInfSkpO1xubW9kdWxlLmV4cG9ydHMuYXJyYXkgPSAoc3RyZWFtLCBvcHRzKSA9PiBnZXRTdHJlYW0oc3RyZWFtLCBPYmplY3QuYXNzaWduKHt9LCBvcHRzLCB7YXJyYXk6IHRydWV9KSk7XG4iXX0=