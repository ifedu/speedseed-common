var common = require('./common');
var fs = require('fs');
// add c spaces to the left of str
function lpad(c, str) {
    var res = '' + str;
    if (res.length < c) {
        res = Array((c - res.length) + 1).join(' ') + res;
    }
    return res;
}
common.register('uniq', _uniq, {
    canReceivePipe: true,
    cmdOptions: {
        'i': 'ignoreCase',
        'c': 'count',
        'd': 'duplicates',
    },
});
//@
//@ ### uniq([options,] [input, [output]])
//@ Available options:
//@
//@ + `-i`: Ignore case while comparing
//@ + `-c`: Prefix lines by the number of occurrences
//@ + `-d`: Only print duplicate lines, one for each group of identical lines
//@
//@ Examples:
//@
//@ ```javascript
//@ uniq('foo.txt');
//@ uniq('-i', 'foo.txt');
//@ uniq('-cd', 'foo.txt', 'bar.txt');
//@ ```
//@
//@ Filter adjacent matching lines from input
function _uniq(options, input, output) {
    // Check if this is coming from a pipe
    var pipe = common.readFromPipe();
    if (!pipe) {
        if (!input)
            common.error('no input given');
        if (!fs.existsSync(input)) {
            common.error(input + ': No such file or directory');
        }
        else if (fs.statSync(input).isDirectory()) {
            common.error("error reading '" + input + "'");
        }
    }
    if (output && fs.existsSync(output) && fs.statSync(output).isDirectory()) {
        common.error(output + ': Is a directory');
    }
    var lines = (input ? fs.readFileSync(input, 'utf8') : pipe).
        trimRight().
        split(/\r*\n/);
    var compare = function (a, b) {
        return options.ignoreCase ?
            a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase()) :
            a.localeCompare(b);
    };
    var uniqed = lines.reduceRight(function (res, e) {
        // Perform uniq -c on the input
        if (res.length === 0) {
            return [{ count: 1, ln: e }];
        }
        else if (compare(res[0].ln, e) === 0) {
            return [{ count: res[0].count + 1, ln: e }].concat(res.slice(1));
        }
        else {
            return [{ count: 1, ln: e }].concat(res);
        }
    }, []).filter(function (obj) {
        // Do we want only duplicated objects?
        return options.duplicates ? obj.count > 1 : true;
    }).map(function (obj) {
        // Are we tracking the counts of each line?
        return (options.count ? (lpad(7, obj.count) + ' ') : '') + obj.ln;
    }).join('\n') + '\n';
    if (output) {
        (new common.ShellString(uniqed)).to(output);
        // if uniq writes to output, nothing is passed to the next command in the pipeline (if any)
        return '';
    }
    else {
        return uniqed;
    }
}
module.exports = _uniq;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxzaGVsbGpzXFxzcmNcXHVuaXEuanMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcaWZlZHVcXEFwcERhdGFcXFJvYW1pbmdcXG52bVxcdjguNC4wXFxub2RlX21vZHVsZXNcXGdlbmVyYXRvci1zcGVlZHNlZWRcXG5vZGVfbW9kdWxlc1xcc2hlbGxqc1xcc3JjXFx1bmlxLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNqQyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFdkIsa0NBQWtDO0FBQ2xDLGNBQWMsQ0FBQyxFQUFFLEdBQUc7SUFDbEIsSUFBSSxHQUFHLEdBQUcsRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUNuQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkIsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUNwRCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUU7SUFDN0IsY0FBYyxFQUFFLElBQUk7SUFDcEIsVUFBVSxFQUFFO1FBQ1YsR0FBRyxFQUFFLFlBQVk7UUFDakIsR0FBRyxFQUFFLE9BQU87UUFDWixHQUFHLEVBQUUsWUFBWTtLQUNsQjtDQUNGLENBQUMsQ0FBQztBQUVILEdBQUc7QUFDSCwwQ0FBMEM7QUFDMUMsc0JBQXNCO0FBQ3RCLEdBQUc7QUFDSCx1Q0FBdUM7QUFDdkMscURBQXFEO0FBQ3JELDZFQUE2RTtBQUM3RSxHQUFHO0FBQ0gsYUFBYTtBQUNiLEdBQUc7QUFDSCxpQkFBaUI7QUFDakIsb0JBQW9CO0FBQ3BCLDBCQUEwQjtBQUMxQixzQ0FBc0M7QUFDdEMsT0FBTztBQUNQLEdBQUc7QUFDSCw2Q0FBNkM7QUFDN0MsZUFBZSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU07SUFDbkMsc0NBQXNDO0lBQ3RDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUVqQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDVixFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUUzQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLDZCQUE2QixDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsS0FBSyxDQUFDLGlCQUFpQixHQUFHLEtBQUssR0FBRyxHQUFHLENBQUMsQ0FBQztRQUNoRCxDQUFDO0lBQ0gsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3pFLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLGtCQUFrQixDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELElBQUksS0FBSyxHQUFHLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUMvQyxTQUFTLEVBQUU7UUFDWCxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFM0IsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVU7WUFDbEIsQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQzFELENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDO0lBQ0YsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQzdDLCtCQUErQjtRQUMvQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QyxNQUFNLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0MsQ0FBQztJQUNILENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHO1FBQ1osc0NBQXNDO1FBQ25ELE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUNuRCxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHO1FBQ0wsMkNBQTJDO1FBQ3hELE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ3BFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFFckIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLDJGQUEyRjtRQUMzRixNQUFNLENBQUMsRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNoQixDQUFDO0FBQ0gsQ0FBQztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNvbW1vbiA9IHJlcXVpcmUoJy4vY29tbW9uJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xuXG4vLyBhZGQgYyBzcGFjZXMgdG8gdGhlIGxlZnQgb2Ygc3RyXG5mdW5jdGlvbiBscGFkKGMsIHN0cikge1xuICB2YXIgcmVzID0gJycgKyBzdHI7XG4gIGlmIChyZXMubGVuZ3RoIDwgYykge1xuICAgIHJlcyA9IEFycmF5KChjIC0gcmVzLmxlbmd0aCkgKyAxKS5qb2luKCcgJykgKyByZXM7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuY29tbW9uLnJlZ2lzdGVyKCd1bmlxJywgX3VuaXEsIHtcbiAgY2FuUmVjZWl2ZVBpcGU6IHRydWUsXG4gIGNtZE9wdGlvbnM6IHtcbiAgICAnaSc6ICdpZ25vcmVDYXNlJyxcbiAgICAnYyc6ICdjb3VudCcsXG4gICAgJ2QnOiAnZHVwbGljYXRlcycsXG4gIH0sXG59KTtcblxuLy9AXG4vL0AgIyMjIHVuaXEoW29wdGlvbnMsXSBbaW5wdXQsIFtvdXRwdXRdXSlcbi8vQCBBdmFpbGFibGUgb3B0aW9uczpcbi8vQFxuLy9AICsgYC1pYDogSWdub3JlIGNhc2Ugd2hpbGUgY29tcGFyaW5nXG4vL0AgKyBgLWNgOiBQcmVmaXggbGluZXMgYnkgdGhlIG51bWJlciBvZiBvY2N1cnJlbmNlc1xuLy9AICsgYC1kYDogT25seSBwcmludCBkdXBsaWNhdGUgbGluZXMsIG9uZSBmb3IgZWFjaCBncm91cCBvZiBpZGVudGljYWwgbGluZXNcbi8vQFxuLy9AIEV4YW1wbGVzOlxuLy9AXG4vL0AgYGBgamF2YXNjcmlwdFxuLy9AIHVuaXEoJ2Zvby50eHQnKTtcbi8vQCB1bmlxKCctaScsICdmb28udHh0Jyk7XG4vL0AgdW5pcSgnLWNkJywgJ2Zvby50eHQnLCAnYmFyLnR4dCcpO1xuLy9AIGBgYFxuLy9AXG4vL0AgRmlsdGVyIGFkamFjZW50IG1hdGNoaW5nIGxpbmVzIGZyb20gaW5wdXRcbmZ1bmN0aW9uIF91bmlxKG9wdGlvbnMsIGlucHV0LCBvdXRwdXQpIHtcbiAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBjb21pbmcgZnJvbSBhIHBpcGVcbiAgdmFyIHBpcGUgPSBjb21tb24ucmVhZEZyb21QaXBlKCk7XG5cbiAgaWYgKCFwaXBlKSB7XG4gICAgaWYgKCFpbnB1dCkgY29tbW9uLmVycm9yKCdubyBpbnB1dCBnaXZlbicpO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGlucHV0KSkge1xuICAgICAgY29tbW9uLmVycm9yKGlucHV0ICsgJzogTm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeScpO1xuICAgIH0gZWxzZSBpZiAoZnMuc3RhdFN5bmMoaW5wdXQpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIGNvbW1vbi5lcnJvcihcImVycm9yIHJlYWRpbmcgJ1wiICsgaW5wdXQgKyBcIidcIik7XG4gICAgfVxuICB9XG4gIGlmIChvdXRwdXQgJiYgZnMuZXhpc3RzU3luYyhvdXRwdXQpICYmIGZzLnN0YXRTeW5jKG91dHB1dCkuaXNEaXJlY3RvcnkoKSkge1xuICAgIGNvbW1vbi5lcnJvcihvdXRwdXQgKyAnOiBJcyBhIGRpcmVjdG9yeScpO1xuICB9XG5cbiAgdmFyIGxpbmVzID0gKGlucHV0ID8gZnMucmVhZEZpbGVTeW5jKGlucHV0LCAndXRmOCcpIDogcGlwZSkuXG4gICAgICAgICAgICAgIHRyaW1SaWdodCgpLlxuICAgICAgICAgICAgICBzcGxpdCgvXFxyKlxcbi8pO1xuXG4gIHZhciBjb21wYXJlID0gZnVuY3Rpb24gKGEsIGIpIHtcbiAgICByZXR1cm4gb3B0aW9ucy5pZ25vcmVDYXNlID9cbiAgICAgICAgICAgYS50b0xvY2FsZUxvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvY2FsZUxvd2VyQ2FzZSgpKSA6XG4gICAgICAgICAgIGEubG9jYWxlQ29tcGFyZShiKTtcbiAgfTtcbiAgdmFyIHVuaXFlZCA9IGxpbmVzLnJlZHVjZVJpZ2h0KGZ1bmN0aW9uIChyZXMsIGUpIHtcbiAgICAvLyBQZXJmb3JtIHVuaXEgLWMgb24gdGhlIGlucHV0XG4gICAgaWYgKHJlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbeyBjb3VudDogMSwgbG46IGUgfV07XG4gICAgfSBlbHNlIGlmIChjb21wYXJlKHJlc1swXS5sbiwgZSkgPT09IDApIHtcbiAgICAgIHJldHVybiBbeyBjb3VudDogcmVzWzBdLmNvdW50ICsgMSwgbG46IGUgfV0uY29uY2F0KHJlcy5zbGljZSgxKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbeyBjb3VudDogMSwgbG46IGUgfV0uY29uY2F0KHJlcyk7XG4gICAgfVxuICB9LCBbXSkuZmlsdGVyKGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgICAgICAgLy8gRG8gd2Ugd2FudCBvbmx5IGR1cGxpY2F0ZWQgb2JqZWN0cz9cbiAgICByZXR1cm4gb3B0aW9ucy5kdXBsaWNhdGVzID8gb2JqLmNvdW50ID4gMSA6IHRydWU7XG4gIH0pLm1hcChmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICAgICAgIC8vIEFyZSB3ZSB0cmFja2luZyB0aGUgY291bnRzIG9mIGVhY2ggbGluZT9cbiAgICByZXR1cm4gKG9wdGlvbnMuY291bnQgPyAobHBhZCg3LCBvYmouY291bnQpICsgJyAnKSA6ICcnKSArIG9iai5sbjtcbiAgfSkuam9pbignXFxuJykgKyAnXFxuJztcblxuICBpZiAob3V0cHV0KSB7XG4gICAgKG5ldyBjb21tb24uU2hlbGxTdHJpbmcodW5pcWVkKSkudG8ob3V0cHV0KTtcbiAgICAvLyBpZiB1bmlxIHdyaXRlcyB0byBvdXRwdXQsIG5vdGhpbmcgaXMgcGFzc2VkIHRvIHRoZSBuZXh0IGNvbW1hbmQgaW4gdGhlIHBpcGVsaW5lIChpZiBhbnkpXG4gICAgcmV0dXJuICcnO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmlxZWQ7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBfdW5pcTtcbiJdfQ==