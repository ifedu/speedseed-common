'use strict';
var _ = require('lodash');
var util = require('./readline');
var cliWidth = require('cli-width');
var stripAnsi = require('strip-ansi');
var stringWidth = require('string-width');
function height(content) {
    return content.split('\n').length;
}
function lastLine(content) {
    return _.last(content.split('\n'));
}
var ScreenManager = module.exports = function (rl) {
    // These variables are keeping information to allow correct prompt re-rendering
    this.height = 0;
    this.extraLinesUnderPrompt = 0;
    this.rl = rl;
};
ScreenManager.prototype.render = function (content, bottomContent) {
    this.rl.output.unmute();
    this.clean(this.extraLinesUnderPrompt);
    /**
     * Write message to screen and setPrompt to control backspace
     */
    var promptLine = lastLine(content);
    var rawPromptLine = stripAnsi(promptLine);
    // Remove the rl.line from our prompt. We can't rely on the content of
    // rl.line (mainly because of the password prompt), so just rely on it's
    // length.
    var prompt = promptLine;
    if (this.rl.line.length) {
        prompt = prompt.slice(0, -this.rl.line.length);
    }
    this.rl.setPrompt(prompt);
    // setPrompt will change cursor position, now we can get correct value
    var cursorPos = this.rl._getCursorPos();
    var width = this.normalizedCliWidth();
    content = forceLineReturn(content, width);
    if (bottomContent) {
        bottomContent = forceLineReturn(bottomContent, width);
    }
    // Manually insert an extra line if we're at the end of the line.
    // This prevent the cursor from appearing at the beginning of the
    // current line.
    if (rawPromptLine.length % width === 0) {
        content += '\n';
    }
    var fullContent = content + (bottomContent ? '\n' + bottomContent : '');
    this.rl.output.write(fullContent);
    /**
     * Re-adjust the cursor at the correct position.
     */
    // We need to consider parts of the prompt under the cursor as part of the bottom
    // content in order to correctly cleanup and re-render.
    var promptLineUpDiff = Math.floor(rawPromptLine.length / width) - cursorPos.rows;
    var bottomContentHeight = promptLineUpDiff + (bottomContent ? height(bottomContent) : 0);
    if (bottomContentHeight > 0) {
        util.up(this.rl, bottomContentHeight);
    }
    // Reset cursor at the beginning of the line
    util.left(this.rl, stringWidth(lastLine(fullContent)));
    // Adjust cursor on the right
    util.right(this.rl, cursorPos.cols);
    /**
     * Set up state for next re-rendering
     */
    this.extraLinesUnderPrompt = bottomContentHeight;
    this.height = height(fullContent);
    this.rl.output.mute();
};
ScreenManager.prototype.clean = function (extraLines) {
    if (extraLines > 0) {
        util.down(this.rl, extraLines);
    }
    util.clearLine(this.rl, this.height);
};
ScreenManager.prototype.done = function () {
    this.rl.setPrompt('');
    this.rl.output.unmute();
    this.rl.output.write('\n');
};
ScreenManager.prototype.normalizedCliWidth = function () {
    var width = cliWidth({
        defaultWidth: 80,
        output: this.rl.output
    });
    if (process.platform === 'win32') {
        return width - 1;
    }
    return width;
};
function breakLines(lines, width) {
    // Break lines who're longuer than the cli width so we can normalize the natural line
    // returns behavior accross terminals.
    var regex = new RegExp('(?:(?:\\033[[0-9;]*m)*.?){1,' + width + '}', 'g');
    return lines.map(function (line) {
        var chunk = line.match(regex);
        // last match is always empty
        chunk.pop();
        return chunk || '';
    });
}
function forceLineReturn(content, width) {
    return _.flatten(breakLines(content.split('\n'), width)).join('\n');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFx1dGlsc1xcc2NyZWVuLW1hbmFnZXIuanMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcaWZlZHVcXEFwcERhdGFcXFJvYW1pbmdcXG52bVxcdjguNC4wXFxub2RlX21vZHVsZXNcXGdlbmVyYXRvci1zcGVlZHNlZWRcXG5vZGVfbW9kdWxlc1xcaW5xdWlyZXJcXGxpYlxcdXRpbHNcXHNjcmVlbi1tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUNiLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDakMsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3BDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFMUMsZ0JBQWdCLE9BQU87SUFDckIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ3BDLENBQUM7QUFFRCxrQkFBa0IsT0FBTztJQUN2QixNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUVELElBQUksYUFBYSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBVSxFQUFFO0lBQy9DLCtFQUErRTtJQUMvRSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNoQixJQUFJLENBQUMscUJBQXFCLEdBQUcs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Q3RDLElBQUksS0FBSyxHQUFHLElBQUksTUFBTSxDQUNwQiw4QkFBOEIsR0FBRyxLQUFLLEdBQUcsR0FBRyxFQUM1QyxHQUFHLENBQ0osQ0FBQztJQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSTtRQUM3QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlCLDZCQUE2QjtRQUM3QixLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDWixNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCx5QkFBeUIsT0FBTyxFQUFFLEtBQUs7SUFDckMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJy4vcmVhZGxpbmUnKTtcbnZhciBjbGlXaWR0aCA9IHJlcXVpcmUoJ2NsaS13aWR0aCcpO1xudmFyIHN0cmlwQW5zaSA9IHJlcXVpcmUoJ3N0cmlwLWFuc2knKTtcbnZhciBzdHJpbmdXaWR0aCA9IHJlcXVpcmUoJ3N0cmluZy13aWR0aCcpO1xuXG5mdW5jdGlvbiBoZWlnaHQoY29udGVudCkge1xuICByZXR1cm4gY29udGVudC5zcGxpdCgnXFxuJykubGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBsYXN0TGluZShjb250ZW50KSB7XG4gIHJldHVybiBfLmxhc3QoY29udGVudC5zcGxpdCgnXFxuJykpO1xufVxuXG52YXIgU2NyZWVuTWFuYWdlciA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHJsKSB7XG4gIC8vIFRoZXNlIHZhcmlhYmxlcyBhcmUga2VlcGluZyBpbmZvcm1hdGlvbiB0byBhbGxvdyBjb3JyZWN0IHByb21wdCByZS1yZW5kZXJpbmdcbiAgdGhpcy5oZWlnaHQgPSAwO1xuICB0aGlzLmV4dHJhTGluZXNVbmRlclByb21wdCA9IDA7XG5cbiAgdGhpcy5ybCA9IHJsO1xufTtcblxuU2NyZWVuTWFuYWdlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKGNvbnRlbnQsIGJvdHRvbUNvbnRlbnQpIHtcbiAgdGhpcy5ybC5vdXRwdXQudW5tdXRlKCk7XG4gIHRoaXMuY2xlYW4odGhpcy5leHRyYUxpbmVzVW5kZXJQcm9tcHQpO1xuXG4gIC8qKlxuICAgKiBXcml0ZSBtZXNzYWdlIHRvIHNjcmVlbiBhbmQgc2V0UHJvbXB0IHRvIGNvbnRyb2wgYmFja3NwYWNlXG4gICAqL1xuXG4gIHZhciBwcm9tcHRMaW5lID0gbGFzdExpbmUoY29udGVudCk7XG4gIHZhciByYXdQcm9tcHRMaW5lID0gc3RyaXBBbnNpKHByb21wdExpbmUpO1xuXG4gIC8vIFJlbW92ZSB0aGUgcmwubGluZSBmcm9tIG91ciBwcm9tcHQuIFdlIGNhbid0IHJlbHkgb24gdGhlIGNvbnRlbnQgb2ZcbiAgLy8gcmwubGluZSAobWFpbmx5IGJlY2F1c2Ugb2YgdGhlIHBhc3N3b3JkIHByb21wdCksIHNvIGp1c3QgcmVseSBvbiBpdCdzXG4gIC8vIGxlbmd0aC5cbiAgdmFyIHByb21wdCA9IHByb21wdExpbmU7XG4gIGlmICh0aGlzLnJsLmxpbmUubGVuZ3RoKSB7XG4gICAgcHJvbXB0ID0gcHJvbXB0LnNsaWNlKDAsIC10aGlzLnJsLmxpbmUubGVuZ3RoKTtcbiAgfVxuICB0aGlzLnJsLnNldFByb21wdChwcm9tcHQpO1xuXG4gIC8vIHNldFByb21wdCB3aWxsIGNoYW5nZSBjdXJzb3IgcG9zaXRpb24sIG5vdyB3ZSBjYW4gZ2V0IGNvcnJlY3QgdmFsdWVcbiAgdmFyIGN1cnNvclBvcyA9IHRoaXMucmwuX2dldEN1cnNvclBvcygpO1xuICB2YXIgd2lkdGggPSB0aGlzLm5vcm1hbGl6ZWRDbGlXaWR0aCgpO1xuXG4gIGNvbnRlbnQgPSBmb3JjZUxpbmVSZXR1cm4oY29udGVudCwgd2lkdGgpO1xuICBpZiAoYm90dG9tQ29udGVudCkge1xuICAgIGJvdHRvbUNvbnRlbnQgPSBmb3JjZUxpbmVSZXR1cm4oYm90dG9tQ29udGVudCwgd2lkdGgpO1xuICB9XG4gIC8vIE1hbnVhbGx5IGluc2VydCBhbiBleHRyYSBsaW5lIGlmIHdlJ3JlIGF0IHRoZSBlbmQgb2YgdGhlIGxpbmUuXG4gIC8vIFRoaXMgcHJldmVudCB0aGUgY3Vyc29yIGZyb20gYXBwZWFyaW5nIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlXG4gIC8vIGN1cnJlbnQgbGluZS5cbiAgaWYgKHJhd1Byb21wdExpbmUubGVuZ3RoICUgd2lkdGggPT09IDApIHtcbiAgICBjb250ZW50ICs9ICdcXG4nO1xuICB9XG4gIHZhciBmdWxsQ29udGVudCA9IGNvbnRlbnQgKyAoYm90dG9tQ29udGVudCA/ICdcXG4nICsgYm90dG9tQ29udGVudCA6ICcnKTtcbiAgdGhpcy5ybC5vdXRwdXQud3JpdGUoZnVsbENvbnRlbnQpO1xuXG4gIC8qKlxuICAgKiBSZS1hZGp1c3QgdGhlIGN1cnNvciBhdCB0aGUgY29ycmVjdCBwb3NpdGlvbi5cbiAgICovXG5cbiAgLy8gV2UgbmVlZCB0byBjb25zaWRlciBwYXJ0cyBvZiB0aGUgcHJvbXB0IHVuZGVyIHRoZSBjdXJzb3IgYXMgcGFydCBvZiB0aGUgYm90dG9tXG4gIC8vIGNvbnRlbnQgaW4gb3JkZXIgdG8gY29ycmVjdGx5IGNsZWFudXAgYW5kIHJlLXJlbmRlci5cbiAgdmFyIHByb21wdExpbmVVcERpZmYgPSBNYXRoLmZsb29yKHJhd1Byb21wdExpbmUubGVuZ3RoIC8gd2lkdGgpIC0gY3Vyc29yUG9zLnJvd3M7XG4gIHZhciBib3R0b21Db250ZW50SGVpZ2h0ID0gcHJvbXB0TGluZVVwRGlmZiArIChib3R0b21Db250ZW50ID8gaGVpZ2h0KGJvdHRvbUNvbnRlbnQpIDogMCk7XG4gIGlmIChib3R0b21Db250ZW50SGVpZ2h0ID4gMCkge1xuICAgIHV0aWwudXAodGhpcy5ybCwgYm90dG9tQ29udGVudEhlaWdodCk7XG4gIH1cblxuICAvLyBSZXNldCBjdXJzb3IgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgbGluZVxuICB1dGlsLmxlZnQodGhpcy5ybCwgc3RyaW5nV2lkdGgobGFzdExpbmUoZnVsbENvbnRlbnQpKSk7XG5cbiAgLy8gQWRqdXN0IGN1cnNvciBvbiB0aGUgcmlnaHRcbiAgdXRpbC5yaWdodCh0aGlzLnJsLCBjdXJzb3JQb3MuY29scyk7XG5cbiAgLyoqXG4gICAqIFNldCB1cCBzdGF0ZSBmb3IgbmV4dCByZS1yZW5kZXJpbmdcbiAgICovXG4gIHRoaXMuZXh0cmFMaW5lc1VuZGVyUHJvbXB0ID0gYm90dG9tQ29udGVudEhlaWdodDtcbiAgdGhpcy5oZWlnaHQgPSBoZWlnaHQoZnVsbENvbnRlbnQpO1xuXG4gIHRoaXMucmwub3V0cHV0Lm11dGUoKTtcbn07XG5cblNjcmVlbk1hbmFnZXIucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24gKGV4dHJhTGluZXMpIHtcbiAgaWYgKGV4dHJhTGluZXMgPiAwKSB7XG4gICAgdXRpbC5kb3duKHRoaXMucmwsIGV4dHJhTGluZXMpO1xuICB9XG4gIHV0aWwuY2xlYXJMaW5lKHRoaXMucmwsIHRoaXMuaGVpZ2h0KTtcbn07XG5cblNjcmVlbk1hbmFnZXIucHJvdG90eXBlLmRvbmUgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMucmwuc2V0UHJvbXB0KCcnKTtcbiAgdGhpcy5ybC5vdXRwdXQudW5tdXRlKCk7XG4gIHRoaXMucmwub3V0cHV0LndyaXRlKCdcXG4nKTtcbn07XG5cblNjcmVlbk1hbmFnZXIucHJvdG90eXBlLm5vcm1hbGl6ZWRDbGlXaWR0aCA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHdpZHRoID0gY2xpV2lkdGgoe1xuICAgIGRlZmF1bHRXaWR0aDogODAsXG4gICAgb3V0cHV0OiB0aGlzLnJsLm91dHB1dFxuICB9KTtcbiAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHtcbiAgICByZXR1cm4gd2lkdGggLSAxO1xuICB9XG4gIHJldHVybiB3aWR0aDtcbn07XG5cbmZ1bmN0aW9uIGJyZWFrTGluZXMobGluZXMsIHdpZHRoKSB7XG4gIC8vIEJyZWFrIGxpbmVzIHdobydyZSBsb25ndWVyIHRoYW4gdGhlIGNsaSB3aWR0aCBzbyB3ZSBjYW4gbm9ybWFsaXplIHRoZSBuYXR1cmFsIGxpbmVcbiAgLy8gcmV0dXJucyBiZWhhdmlvciBhY2Nyb3NzIHRlcm1pbmFscy5cbiAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cChcbiAgICAnKD86KD86XFxcXDAzM1tbMC05O10qbSkqLj8pezEsJyArIHdpZHRoICsgJ30nLFxuICAgICdnJ1xuICApO1xuICByZXR1cm4gbGluZXMubWFwKGZ1bmN0aW9uIChsaW5lKSB7XG4gICAgdmFyIGNodW5rID0gbGluZS5tYXRjaChyZWdleCk7XG4gICAgLy8gbGFzdCBtYXRjaCBpcyBhbHdheXMgZW1wdHlcbiAgICBjaHVuay5wb3AoKTtcbiAgICByZXR1cm4gY2h1bmsgfHwgJyc7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBmb3JjZUxpbmVSZXR1cm4oY29udGVudCwgd2lkdGgpIHtcbiAgcmV0dXJuIF8uZmxhdHRlbihicmVha0xpbmVzKGNvbnRlbnQuc3BsaXQoJ1xcbicpLCB3aWR0aCkpLmpvaW4oJ1xcbicpO1xufVxuIl19