'use strict';
var _ = require('lodash');
var rx = require('rx');
var util = require('util');
var runAsync = require('run-async');
var utils = require('../utils/utils');
var Base = require('./baseUI');
var Promise = require('pinkie-promise');
/**
 * Base interface class other can inherits from
 */
var PromptUI = module.exports = function (prompts, opt) {
    Base.call(this, opt);
    this.prompts = prompts;
};
util.inherits(PromptUI, Base);
PromptUI.prototype.run = function (questions) {
    // Keep global reference to the answers
    this.answers = {};
    // Make sure questions is an array.
    if (_.isPlainObject(questions)) {
        questions = [questions];
    }
    // Create an observable, unless we received one as parameter.
    // Note: As this is a public interface, we cannot do an instanceof check as we won't
    // be using the exact same object in memory.
    var obs = _.isArray(questions) ? rx.Observable.from(questions) : questions;
    this.process = obs
        .concatMap(this.processQuestion.bind(this))
        .publish();
    this.process.connect();
    return this.process
        .reduce(function (answers, answer) {
        this.answers[answer.name] = answer.answer;
        return this.answers;
    }.bind(this), {})
        .toPromise(Promise)
        .then(this.onCompletion.bind(this));
};
/**
 * Once all prompt are over
 */
PromptUI.prototype.onCompletion = function (answers) {
    this.close();
    return answers;
};
PromptUI.prototype.processQuestion = function (question) {
    question = _.clone(question);
    return rx.Observable.defer(function () {
        var obs = rx.Observable.of(question);
        return obs
            .concatMap(this.setDefaultType.bind(this))
            .concatMap(this.filterIfRunnable.bind(this))
            .concatMap(utils.fetchAsyncQuestionProperty.bind(null, question, 'message', this.answers))
            .concatMap(utils.fetchAsyncQuestionProperty.bind(null, question, 'default', this.answers))
            .concatMap(utils.fetchAsyncQuestionProperty.bind(null, question, 'choices', this.answers))
            .concatMap(this.fetchAnswer.bind(this));
    }.bind(this));
};
PromptUI.prototype.fetchAnswer = function (question) {
    var Prompt = this.prompts[question.type];
    var prompt = new Prompt(question, this.rl, this.answers);
    return rx.Observable.defer(function () {
        return rx.Observable.fromPromise(prompt.run().then(function (answer) {
            return { name: question.name, answer: answer };
        }));
    });
};
PromptUI.prototype.setDefaultType = function (question) {
    // Default type to input
    if (!this.prompts[question.type]) {
        question.type = 'input';
    }
    return rx.Observable.defer(function () {
        return rx.Observable.return(question);
    });
};
PromptUI.prototype.filterIfRunnable = function (question) {
    if (question.when === false) {
        return rx.Observable.empty();
    }
    if (!_.isFunction(question.when)) {
        return rx.Observable.return(question);
    }
    var answers = this.answers;
    return rx.Observable.defer(function () {
        return rx.Observable.fromPromise(runAsync(question.when)(answers).then(function (shouldRun) {
            if (shouldRun) {
                return question;
            }
        })).filter(function (val) {
            return val != null;
        });
    });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFx1aVxccHJvbXB0LmpzIiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGlmZWR1XFxBcHBEYXRhXFxSb2FtaW5nXFxudm1cXHY4LjQuMFxcbm9kZV9tb2R1bGVzXFxnZW5lcmF0b3Itc3BlZWRzZWVkXFxub2RlX21vZHVsZXNcXGlucXVpcmVyXFxsaWJcXHVpXFxwcm9tcHQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBQ2IsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFCLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN2QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3BDLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3RDLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUV4Qzs7R0FFRztBQUVILElBQUksUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBVSxPQUFPLEVBQUUsR0FBRztJQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztBQUN6QixDQUFDLENBQUM7QUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUU5QixRQUFRLENBQUMsU0FBUyxD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QUssRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxNQUFNLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDM0IsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO1FBQ3pCLE1BQU0sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FDOUIsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxTQUFTO1lBQ3ZELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUNsQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHO1lBQ3BCLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHJ4ID0gcmVxdWlyZSgncngnKTtcbnZhciB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xudmFyIHJ1bkFzeW5jID0gcmVxdWlyZSgncnVuLWFzeW5jJyk7XG52YXIgdXRpbHMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscycpO1xudmFyIEJhc2UgPSByZXF1aXJlKCcuL2Jhc2VVSScpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdwaW5raWUtcHJvbWlzZScpO1xuXG4vKipcbiAqIEJhc2UgaW50ZXJmYWNlIGNsYXNzIG90aGVyIGNhbiBpbmhlcml0cyBmcm9tXG4gKi9cblxudmFyIFByb21wdFVJID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAocHJvbXB0cywgb3B0KSB7XG4gIEJhc2UuY2FsbCh0aGlzLCBvcHQpO1xuICB0aGlzLnByb21wdHMgPSBwcm9tcHRzO1xufTtcbnV0aWwuaW5oZXJpdHMoUHJvbXB0VUksIEJhc2UpO1xuXG5Qcm9tcHRVSS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKHF1ZXN0aW9ucykge1xuICAvLyBLZWVwIGdsb2JhbCByZWZlcmVuY2UgdG8gdGhlIGFuc3dlcnNcbiAgdGhpcy5hbnN3ZXJzID0ge307XG5cbiAgLy8gTWFrZSBzdXJlIHF1ZXN0aW9ucyBpcyBhbiBhcnJheS5cbiAgaWYgKF8uaXNQbGFpbk9iamVjdChxdWVzdGlvbnMpKSB7XG4gICAgcXVlc3Rpb25zID0gW3F1ZXN0aW9uc107XG4gIH1cblxuICAvLyBDcmVhdGUgYW4gb2JzZXJ2YWJsZSwgdW5sZXNzIHdlIHJlY2VpdmVkIG9uZSBhcyBwYXJhbWV0ZXIuXG4gIC8vIE5vdGU6IEFzIHRoaXMgaXMgYSBwdWJsaWMgaW50ZXJmYWNlLCB3ZSBjYW5ub3QgZG8gYW4gaW5zdGFuY2VvZiBjaGVjayBhcyB3ZSB3b24ndFxuICAvLyBiZSB1c2luZyB0aGUgZXhhY3Qgc2FtZSBvYmplY3QgaW4gbWVtb3J5LlxuICB2YXIgb2JzID0gXy5pc0FycmF5KHF1ZXN0aW9ucykgPyByeC5PYnNlcnZhYmxlLmZyb20ocXVlc3Rpb25zKSA6IHF1ZXN0aW9ucztcblxuICB0aGlzLnByb2Nlc3MgPSBvYnNcbiAgICAuY29uY2F0TWFwKHRoaXMucHJvY2Vzc1F1ZXN0aW9uLmJpbmQodGhpcykpXG4gICAgLy8gYHB1Ymxpc2hgIGNyZWF0ZXMgYSBob3QgT2JzZXJ2YWJsZS4gSXQgcHJldmVudHMgZHVwbGljYXRpbmcgcHJvbXB0cy5cbiAgICAucHVibGlzaCgpO1xuXG4gIHRoaXMucHJvY2Vzcy5jb25uZWN0KCk7XG5cbiAgcmV0dXJuIHRoaXMucHJvY2Vzc1xuICAgIC5yZWR1Y2UoZnVuY3Rpb24gKGFuc3dlcnMsIGFuc3dlcikge1xuICAgICAgdGhpcy5hbnN3ZXJzW2Fuc3dlci5uYW1lXSA9IGFuc3dlci5hbnN3ZXI7XG4gICAgICByZXR1cm4gdGhpcy5hbnN3ZXJzO1xuICAgIH0uYmluZCh0aGlzKSwge30pXG4gICAgLnRvUHJvbWlzZShQcm9taXNlKVxuICAgIC50aGVuKHRoaXMub25Db21wbGV0aW9uLmJpbmQodGhpcykpO1xufTtcblxuLyoqXG4gKiBPbmNlIGFsbCBwcm9tcHQgYXJlIG92ZXJcbiAqL1xuXG5Qcm9tcHRVSS5wcm90b3R5cGUub25Db21wbGV0aW9uID0gZnVuY3Rpb24gKGFuc3dlcnMpIHtcbiAgdGhpcy5jbG9zZSgpO1xuXG4gIHJldHVybiBhbnN3ZXJzO1xufTtcblxuUHJvbXB0VUkucHJvdG90eXBlLnByb2Nlc3NRdWVzdGlvbiA9IGZ1bmN0aW9uIChxdWVzdGlvbikge1xuICBxdWVzdGlvbiA9IF8uY2xvbmUocXVlc3Rpb24pO1xuICByZXR1cm4gcnguT2JzZXJ2YWJsZS5kZWZlcihmdW5jdGlvbiAoKSB7XG4gICAgdmFyIG9icyA9IHJ4Lk9ic2VydmFibGUub2YocXVlc3Rpb24pO1xuXG4gICAgcmV0dXJuIG9ic1xuICAgICAgLmNvbmNhdE1hcCh0aGlzLnNldERlZmF1bHRUeXBlLmJpbmQodGhpcykpXG4gICAgICAuY29uY2F0TWFwKHRoaXMuZmlsdGVySWZSdW5uYWJsZS5iaW5kKHRoaXMpKVxuICAgICAgLmNvbmNhdE1hcCh1dGlscy5mZXRjaEFzeW5jUXVlc3Rpb25Qcm9wZXJ0eS5iaW5kKG51bGwsIHF1ZXN0aW9uLCAnbWVzc2FnZScsIHRoaXMuYW5zd2VycykpXG4gICAgICAuY29uY2F0TWFwKHV0aWxzLmZldGNoQXN5bmNRdWVzdGlvblByb3BlcnR5LmJpbmQobnVsbCwgcXVlc3Rpb24sICdkZWZhdWx0JywgdGhpcy5hbnN3ZXJzKSlcbiAgICAgIC5jb25jYXRNYXAodXRpbHMuZmV0Y2hBc3luY1F1ZXN0aW9uUHJvcGVydHkuYmluZChudWxsLCBxdWVzdGlvbiwgJ2Nob2ljZXMnLCB0aGlzLmFuc3dlcnMpKVxuICAgICAgLmNvbmNhdE1hcCh0aGlzLmZldGNoQW5zd2VyLmJpbmQodGhpcykpO1xuICB9LmJpbmQodGhpcykpO1xufTtcblxuUHJvbXB0VUkucHJvdG90eXBlLmZldGNoQW5zd2VyID0gZnVuY3Rpb24gKHF1ZXN0aW9uKSB7XG4gIHZhciBQcm9tcHQgPSB0aGlzLnByb21wdHNbcXVlc3Rpb24udHlwZV07XG4gIHZhciBwcm9tcHQgPSBuZXcgUHJvbXB0KHF1ZXN0aW9uLCB0aGlzLnJsLCB0aGlzLmFuc3dlcnMpO1xuICByZXR1cm4gcnguT2JzZXJ2YWJsZS5kZWZlcihmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHJ4Lk9ic2VydmFibGUuZnJvbVByb21pc2UocHJvbXB0LnJ1bigpLnRoZW4oZnVuY3Rpb24gKGFuc3dlcikge1xuICAgICAgcmV0dXJuIHtuYW1lOiBxdWVzdGlvbi5uYW1lLCBhbnN3ZXI6IGFuc3dlcn07XG4gICAgfSkpO1xuICB9KTtcbn07XG5cblByb21wdFVJLnByb3RvdHlwZS5zZXREZWZhdWx0VHlwZSA9IGZ1bmN0aW9uIChxdWVzdGlvbikge1xuICAvLyBEZWZhdWx0IHR5cGUgdG8gaW5wdXRcbiAgaWYgKCF0aGlzLnByb21wdHNbcXVlc3Rpb24udHlwZV0pIHtcbiAgICBxdWVzdGlvbi50eXBlID0gJ2lucHV0JztcbiAgfVxuICByZXR1cm4gcnguT2JzZXJ2YWJsZS5kZWZlcihmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHJ4Lk9ic2VydmFibGUucmV0dXJuKHF1ZXN0aW9uKTtcbiAgfSk7XG59O1xuXG5Qcm9tcHRVSS5wcm90b3R5cGUuZmlsdGVySWZSdW5uYWJsZSA9IGZ1bmN0aW9uIChxdWVzdGlvbikge1xuICBpZiAocXVlc3Rpb24ud2hlbiA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm4gcnguT2JzZXJ2YWJsZS5lbXB0eSgpO1xuICB9XG5cbiAgaWYgKCFfLmlzRnVuY3Rpb24ocXVlc3Rpb24ud2hlbikpIHtcbiAgICByZXR1cm4gcnguT2JzZXJ2YWJsZS5yZXR1cm4ocXVlc3Rpb24pO1xuICB9XG5cbiAgdmFyIGFuc3dlcnMgPSB0aGlzLmFuc3dlcnM7XG4gIHJldHVybiByeC5PYnNlcnZhYmxlLmRlZmVyKGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gcnguT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShcbiAgICAgIHJ1bkFzeW5jKHF1ZXN0aW9uLndoZW4pKGFuc3dlcnMpLnRoZW4oZnVuY3Rpb24gKHNob3VsZFJ1bikge1xuICAgICAgICBpZiAoc2hvdWxkUnVuKSB7XG4gICAgICAgICAgcmV0dXJuIHF1ZXN0aW9uO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICkuZmlsdGVyKGZ1bmN0aW9uICh2YWwpIHtcbiAgICAgIHJldHVybiB2YWwgIT0gbnVsbDtcbiAgICB9KTtcbiAgfSk7XG59O1xuIl19