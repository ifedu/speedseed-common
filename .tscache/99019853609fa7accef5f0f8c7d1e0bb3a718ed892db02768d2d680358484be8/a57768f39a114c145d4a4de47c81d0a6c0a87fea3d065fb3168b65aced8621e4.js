/**
 * Module dependencies.
 */
var colors = require('colors/safe'), utils = require('./utils'), repeat = utils.repeat, truncate = utils.truncate, pad = utils.pad;
/**
 * Table constructor
 *
 * @param {Object} options
 * @api public
 */
function Table(options) {
    this.options = utils.options({
        chars: {
            'top': '─',
            'top-mid': '┬',
            'top-left': '┌',
            'top-right': '┐',
            'bottom': '─',
            'bottom-mid': '┴',
            'bottom-left': '└',
            'bottom-right': '┘',
            'left': '│',
            'left-mid': '├',
            'mid': '─',
            'mid-mid': '┼',
            'right': '│',
            'right-mid': '┤',
            'middle': '│'
        },
        truncate: '…',
        colWidths: [],
        colAligns: [],
        style: {
            'padding-left': 1,
            'padding-right': 1,
            head: ['red'],
            border: ['grey'],
            compact: false
        },
        head: []
    }, options);
}
;
/**
 * Inherit from Array.
 */
Table.prototype.__proto__ = Array.prototype;
/**
 * Width getter
 *
 * @return {Number} width
 * @api public
 */
Table.prototype.__defineGetter__('width', function () {
    var str = this.toString().split("\n");
    if (str.length)
        return str[0].length;
    return 0;
});
/**
 * Render to a string.
 *
 * @return {String} table representation
 * @api public
 */
Table.prototype.render;
Table.prototype.toString = function () {
    var ret = '', options = this.options, style = options.style, head = options.head, chars = options.chars, truncater = options.truncate, colWidths = options.colWidths || new Array(this.head.length), totalWidth = 0;
    if (!head.length && !this.length)
        return '';
    if (!colWidths.length) {
        var all_rows = this.slice(0);
        if (head.length) {
            all_rows = all_rows.concat([head]);
        }
        ;
        all_rows.forEach(function (cells) {
            // horizontal (arrays)
            if (typeof cells === 'object' && cells.length) {
                extractColumnWidths(cells);
                // vertical (objects)
            }
            else {
                var header_cell = Object.keys(cells)[0], value_cell = cells[header_cell];
                colWidths[0] = Math.max(colWidths[0] || 0, get_width(header_cell) || 0);
                // cross (objects w/ array values)
                if (typeof value_cell === 'object' && value_cell.length) {
                    extractColumnWidths(value_cell, 1);
                }
                else {
                    colWidths[1] = Math.max(colWidths[1] || 0, get_width(value_cell) || 0);
                }
            }
        });
    }
    ;
    totalWidth = (colWidths.length == 1 ? colWidths[0] : colWidths.reduce(function (a, b) {
        return a + b;
    })) + colWidths.length + 1;
    function extractColumnWidths(arr, offset) {
        var offset = offset || 0;
        arr.forEach(function (cell, i) {
            colWidths[i + offset] = Math.max(colWidths[i + offset] || 0, get_width(cell) || 0);
        });
    }
    ;
    function get_width(obj) {
        return typeof obj == 'object' && obj.width != undefined
            ? obj.width
            : ((typeof obj == 'object' ? utils.strlen(obj.text) : utils.strlen(obj)) + (style['padding-left'] || 0) + (style['padding-right'] || 0));
    }
    // draws a line
    function line(line, left, right, intersection) {
        var width = 0, line = left
            + repeat(line, totalWidth - 2)
            + right;
        colWidths.forEach(function (w, i) {
            if (i == colWidths.length - 1)
                return;
            width += w + 1;
            line = line.substr(0, width) + intersection + line.substr(width + 1);
        });
        return applyStyles(options.style.border, line);
    }
    ;
    // draws the top line
    function lineTop() {
        var l = line(chars.top, chars['top-left'] || chars.top, chars['top-right'] || chars.top, chars['top-mid']);
        if (l)
            ret += l + "\n";
    }
    ;
    function generateRow(items, style) {
        var cells = [], max_height = 0;
        // prepare vertical and cross table data
        if (!Array.isArray(items) && typeof items === "object") {
            var key = Object.keys(items)[0], value = items[key], first_cell_head = true;
            if (Array.isArray(value)) {
                items = value;
                items.unshift(key);
            }
            else {
                items = [key, value];
            }
        }
        // transform array of item strings into structure of cells
        items.forEach(function (item, i) {
            var contents = item.toString().split("\n").reduce(function (memo, l) {
                memo.push(string(l, i));
                return memo;
            }, []);
            var height = contents.length;
            if (height > max_height) {
                max_height = height;
            }
            ;
            cells.push({ contents: contents, height: height });
        });
        // transform vertical cells into horizontal lines
        var lines = new Array(max_height);
        cells.forEach(function (cell, i) {
            cell.contents.forEach(function (line, j) {
                if (!lines[j]) {
                    lines[j] = [];
                }
                ;
                if (style || (first_cell_head && i === 0 && options.style.head)) {
                    line = applyStyles(options.style.head, line);
                }
                lines[j].push(line);
            });
            // populate empty lines in cell
            for (var j = cell.height, l = max_height; j < l; j++) {
                if (!lines[j]) {
                    lines[j] = [];
                }
                ;
                lines[j].push(string('', i));
            }
        });
        var ret = "";
        lines.forEach(function (line, index) {
            if (ret.length > 0) {
                ret += "\n" + applyStyles(options.style.border, chars.left);
            }
            ret += line.join(applyStyles(options.style.border, chars.middle)) + applyStyles(options.style.border, chars.right);
        });
        return applyStyles(options.style.border, chars.left) + ret;
    }
    ;
    function applyStyles(styles, subject) {
        if (!subject)
            return '';
        styles.forEach(function (style) {
            subject = colors[style](subject);
        });
        return subject;
    }
    ;
    // renders a string, by padding it or truncating it
    function string(str, index) {
        var str = String(typeof str == 'object' && str.text ? str.text : str), length = utils.strlen(str), width = colWidths[index]
            - (style['padding-left'] || 0)
            - (style['padding-right'] || 0), align = options.colAligns[index] || 'left';
        return repeat(' ', style['padding-left'] || 0)
            + (length == width ? str :
                (length < width
                    ? pad(str, (width + (str.length - length)), ' ', align == 'left' ? 'right' :
                        (align == 'middle' ? 'both' : 'left'))
                    : (truncater ? truncate(str, width, truncater) : str)))
            + repeat(' ', style['padding-right'] || 0);
    }
    ;
    if (head.length) {
        lineTop();
        ret += generateRow(head, style.head) + "\n";
    }
    if (this.length)
        this.forEach(function (cells, i) {
            if (!head.length && i == 0)
                lineTop();
            else {
                if (!style.compact || i < (!!head.length) ? 1 : 0 || cells.length == 0) {
                    var l = line(chars.mid, chars['left-mid'], chars['right-mid'], chars['mid-mid']);
                    if (l)
                        ret += l + "\n";
                }
            }
            if (cells.hasOwnProperty("length") && !cells.length) {
                return;
            }
            else {
                ret += generateRow(cells) + "\n";
            }
            ;
        });
    var l = line(chars.bottom, chars['bottom-left'] || chars.bottom, chars['bottom-right'] || chars.bottom, chars['bottom-mid']);
    if (l)
        ret += l;
    else
        // trim the last '\n' if we didn't add the bottom decoration
        ret = ret.slice(0, -1);
    return ret;
};
/**
 * Module exports.
 */
module.exports = Table;
module.exports.version = '0.0.1';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxjbGktdGFibGVcXGxpYlxcaW5kZXguanMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcaWZlZHVcXEFwcERhdGFcXFJvYW1pbmdcXG52bVxcdjguNC4wXFxub2RlX21vZHVsZXNcXGdlbmVyYXRvci1zcGVlZHNlZWRcXG5vZGVfbW9kdWxlc1xcY2xpLXRhYmxlXFxsaWJcXGluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBOztHQUVHO0FBRUgsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUMvQixLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUMxQixNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFDckIsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQ3pCLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO0FBRXBCOzs7OztHQUtHO0FBRUgsZUFBZ0IsT0FBTztJQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDekIsS0FBSyxFQUFFO1lBQ0gsS0FBSyxFQUFFLEdBQUc7WUFDVixTQUFTLEVBQUUsR0FBRztZQUNkLFVBQVUsRUFBRSxHQUFHO1lBQ2YsV0FBVyxFQUFFLEdBQUc7WUFDaEIsUUFBUSxFQUFFLEdBQUc7WUFDYixZQUFZLEVBQUUsR0FBRztZQUNqQixhQUFhLEVBQUUsR0FBRztZQUNsQixjQUFjLEVBQUUsR0FBRztZQUNuQixNQUFNLEVBQUUsR0FBRztZQUNYLFVBQVUsRUFBRSxHQUFHO1lBQ2YsS0FBSyxFQUFFLEdBQUc7WUFDVixTQUFTLEVBQUUsR0FBRztZQUNkLE9BQU8sRUFBRSxHQUFHO1lBQ1osV0FBVyxFQUFFLEdBQUc7WUFDaEIsUUFBUSxFQUFFLEdBQUc7U0FDaEI7UUFDRCxR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SUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFBO2dCQUNuQixDQUFDO1lBQ0gsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDcEQsTUFBTSxDQUFBO1lBQ1IsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEdBQUcsSUFBSSxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ25DLENBQUM7WUFBQSxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFFTCxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFDWixLQUFLLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxDQUFDLE1BQU0sRUFDcEMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQ3JDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNKLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDWCxJQUFJO1FBQ0YsNERBQTREO1FBQzVELEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXpCLE1BQU0sQ0FBQyxHQUFHLENBQUM7QUFDYixDQUFDLENBQUM7QUFFRjs7R0FFRztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0FBRXZCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqXG4gKiBNb2R1bGUgZGVwZW5kZW5jaWVzLlxuICovXG5cbnZhciBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMvc2FmZScpXG4gICwgdXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJylcbiAgLCByZXBlYXQgPSB1dGlscy5yZXBlYXRcbiAgLCB0cnVuY2F0ZSA9IHV0aWxzLnRydW5jYXRlXG4gICwgcGFkID0gdXRpbHMucGFkO1xuXG4vKipcbiAqIFRhYmxlIGNvbnN0cnVjdG9yXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAqIEBhcGkgcHVibGljXG4gKi9cblxuZnVuY3Rpb24gVGFibGUgKG9wdGlvbnMpe1xuICB0aGlzLm9wdGlvbnMgPSB1dGlscy5vcHRpb25zKHtcbiAgICAgIGNoYXJzOiB7XG4gICAgICAgICAgJ3RvcCc6ICfilIAnXG4gICAgICAgICwgJ3RvcC1taWQnOiAn4pSsJ1xuICAgICAgICAsICd0b3AtbGVmdCc6ICfilIwnXG4gICAgICAgICwgJ3RvcC1yaWdodCc6ICfilJAnXG4gICAgICAgICwgJ2JvdHRvbSc6ICfilIAnXG4gICAgICAgICwgJ2JvdHRvbS1taWQnOiAn4pS0J1xuICAgICAgICAsICdib3R0b20tbGVmdCc6ICfilJQnXG4gICAgICAgICwgJ2JvdHRvbS1yaWdodCc6ICfilJgnXG4gICAgICAgICwgJ2xlZnQnOiAn4pSCJ1xuICAgICAgICAsICdsZWZ0LW1pZCc6ICfilJwnXG4gICAgICAgICwgJ21pZCc6ICfilIAnXG4gICAgICAgICwgJ21pZC1taWQnOiAn4pS8J1xuICAgICAgICAsICdyaWdodCc6ICfilIInXG4gICAgICAgICwgJ3JpZ2h0LW1pZCc6ICfilKQnXG4gICAgICAgICwgJ21pZGRsZSc6ICfilIInXG4gICAgICB9XG4gICAgLCB0cnVuY2F0ZTogJ+KApidcbiAgICAsIGNvbFdpZHRoczogW11cbiAgICAsIGNvbEFsaWduczogW11cbiAgICAsIHN0eWxlOiB7XG4gICAgICAgICAgJ3BhZGRpbmctbGVmdCc6IDFcbiAgICAgICAgLCAncGFkZGluZy1yaWdodCc6IDFcbiAgICAgICAgLCBoZWFkOiBbJ3JlZCddXG4gICAgICAgICwgYm9yZGVyOiBbJ2dyZXknXVxuICAgICAgICAsIGNvbXBhY3QgOiBmYWxzZVxuICAgICAgfVxuICAgICwgaGVhZDogW11cbiAgfSwgb3B0aW9ucyk7XG59O1xuXG4vKipcbiAqIEluaGVyaXQgZnJvbSBBcnJheS5cbiAqL1xuXG5UYWJsZS5wcm90b3R5cGUuX19wcm90b19fID0gQXJyYXkucHJvdG90eXBlO1xuXG4vKipcbiAqIFdpZHRoIGdldHRlclxuICpcbiAqIEByZXR1cm4ge051bWJlcn0gd2lkdGhcbiAqIEBhcGkgcHVibGljXG4gKi9cblxuVGFibGUucHJvdG90eXBlLl9fZGVmaW5lR2V0dGVyX18oJ3dpZHRoJywgZnVuY3Rpb24gKCl7XG4gIHZhciBzdHIgPSB0aGlzLnRvU3RyaW5nKCkuc3BsaXQoXCJcXG5cIik7XG4gIGlmIChzdHIubGVuZ3RoKSByZXR1cm4gc3RyWzBdLmxlbmd0aDtcbiAgcmV0dXJuIDA7XG59KTtcblxuLyoqXG4gKiBSZW5kZXIgdG8gYSBzdHJpbmcuXG4gKlxuICogQHJldHVybiB7U3RyaW5nfSB0YWJsZSByZXByZXNlbnRhdGlvblxuICogQGFwaSBwdWJsaWNcbiAqL1xuXG5UYWJsZS5wcm90b3R5cGUucmVuZGVyXG5UYWJsZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKXtcbiAgdmFyIHJldCA9ICcnXG4gICAgLCBvcHRpb25zID0gdGhpcy5vcHRpb25zXG4gICAgLCBzdHlsZSA9IG9wdGlvbnMuc3R5bGVcbiAgICAsIGhlYWQgPSBvcHRpb25zLmhlYWRcbiAgICAsIGNoYXJzID0gb3B0aW9ucy5jaGFyc1xuICAgICwgdHJ1bmNhdGVyID0gb3B0aW9ucy50cnVuY2F0ZVxuICAgICAgLCBjb2xXaWR0aHMgPSBvcHRpb25zLmNvbFdpZHRocyB8fCBuZXcgQXJyYXkodGhpcy5oZWFkLmxlbmd0aClcbiAgICAgICwgdG90YWxXaWR0aCA9IDA7XG5cbiAgICBpZiAoIWhlYWQubGVuZ3RoICYmICF0aGlzLmxlbmd0aCkgcmV0dXJuICcnO1xuXG4gICAgaWYgKCFjb2xXaWR0aHMubGVuZ3RoKXtcbiAgICAgIHZhciBhbGxfcm93cyA9IHRoaXMuc2xpY2UoMCk7XG4gICAgICBpZiAoaGVhZC5sZW5ndGgpIHsgYWxsX3Jvd3MgPSBhbGxfcm93cy5jb25jYXQoW2hlYWRdKSB9O1xuXG4gICAgICBhbGxfcm93cy5mb3JFYWNoKGZ1bmN0aW9uKGNlbGxzKXtcbiAgICAgICAgLy8gaG9yaXpvbnRhbCAoYXJyYXlzKVxuICAgICAgICBpZiAodHlwZW9mIGNlbGxzID09PSAnb2JqZWN0JyAmJiBjZWxscy5sZW5ndGgpIHtcbiAgICAgICAgICBleHRyYWN0Q29sdW1uV2lkdGhzKGNlbGxzKTtcblxuICAgICAgICAvLyB2ZXJ0aWNhbCAob2JqZWN0cylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB2YXIgaGVhZGVyX2NlbGwgPSBPYmplY3Qua2V5cyhjZWxscylbMF1cbiAgICAgICAgICAgICwgdmFsdWVfY2VsbCA9IGNlbGxzW2hlYWRlcl9jZWxsXTtcblxuICAgICAgICAgIGNvbFdpZHRoc1swXSA9IE1hdGgubWF4KGNvbFdpZHRoc1swXSB8fCAwLCBnZXRfd2lkdGgoaGVhZGVyX2NlbGwpIHx8IDApO1xuXG4gICAgICAgICAgLy8gY3Jvc3MgKG9iamVjdHMgdy8gYXJyYXkgdmFsdWVzKVxuICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWVfY2VsbCA9PT0gJ29iamVjdCcgJiYgdmFsdWVfY2VsbC5sZW5ndGgpIHtcbiAgICAgICAgICAgIGV4dHJhY3RDb2x1bW5XaWR0aHModmFsdWVfY2VsbCwgMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbFdpZHRoc1sxXSA9IE1hdGgubWF4KGNvbFdpZHRoc1sxXSB8fCAwLCBnZXRfd2lkdGgodmFsdWVfY2VsbCkgfHwgMCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgdG90YWxXaWR0aCA9IChjb2xXaWR0aHMubGVuZ3RoID09IDEgPyBjb2xXaWR0aHNbMF0gOiBjb2xXaWR0aHMucmVkdWNlKFxuICAgIGZ1bmN0aW9uIChhLCBiKXtcbiAgICAgIHJldHVybiBhICsgYlxuICAgIH0pKSArIGNvbFdpZHRocy5sZW5ndGggKyAxO1xuXG4gIGZ1bmN0aW9uIGV4dHJhY3RDb2x1bW5XaWR0aHMoYXJyLCBvZmZzZXQpIHtcbiAgICB2YXIgb2Zmc2V0ID0gb2Zmc2V0IHx8IDA7XG4gICAgYXJyLmZvckVhY2goZnVuY3Rpb24oY2VsbCwgaSl7XG4gICAgICBjb2xXaWR0aHNbaSArIG9mZnNldF0gPSBNYXRoLm1heChjb2xXaWR0aHNbaSArIG9mZnNldF0gfHwgMCwgZ2V0X3dpZHRoKGNlbGwpIHx8IDApO1xuICAgIH0pO1xuICB9O1xuXG4gIGZ1bmN0aW9uIGdldF93aWR0aChvYmopIHtcbiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PSAnb2JqZWN0JyAmJiBvYmoud2lkdGggIT0gdW5kZWZpbmVkXG4gICAgICAgICA/IG9iai53aWR0aFxuICAgICAgICAgOiAoKHR5cGVvZiBvYmogPT0gJ29iamVjdCcgPyB1dGlscy5zdHJsZW4ob2JqLnRleHQpIDogdXRpbHMuc3RybGVuKG9iaikpICsgKHN0eWxlWydwYWRkaW5nLWxlZnQnXSB8fCAwKSArIChzdHlsZVsncGFkZGluZy1yaWdodCddIHx8IDApKVxuICB9XG5cbiAgLy8gZHJhd3MgYSBsaW5lXG4gIGZ1bmN0aW9uIGxpbmUgKGxpbmUsIGxlZnQsIHJpZ2h0LCBpbnRlcnNlY3Rpb24pe1xuICAgIHZhciB3aWR0aCA9IDBcbiAgICAgICwgbGluZSA9XG4gICAgICAgICAgbGVmdFxuICAgICAgICArIHJlcGVhdChsaW5lLCB0b3RhbFdpZHRoIC0gMilcbiAgICAgICAgKyByaWdodDtcblxuICAgIGNvbFdpZHRocy5mb3JFYWNoKGZ1bmN0aW9uICh3LCBpKXtcbiAgICAgIGlmIChpID09IGNvbFdpZHRocy5sZW5ndGggLSAxKSByZXR1cm47XG4gICAgICB3aWR0aCArPSB3ICsgMTtcbiAgICAgIGxpbmUgPSBsaW5lLnN1YnN0cigwLCB3aWR0aCkgKyBpbnRlcnNlY3Rpb24gKyBsaW5lLnN1YnN0cih3aWR0aCArIDEpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGFwcGx5U3R5bGVzKG9wdGlvbnMuc3R5bGUuYm9yZGVyLCBsaW5lKTtcbiAgfTtcblxuICAvLyBkcmF3cyB0aGUgdG9wIGxpbmVcbiAgZnVuY3Rpb24gbGluZVRvcCAoKXtcbiAgICB2YXIgbCA9IGxpbmUoY2hhcnMudG9wXG4gICAgICAgICAgICAgICAsIGNoYXJzWyd0b3AtbGVmdCddIHx8IGNoYXJzLnRvcFxuICAgICAgICAgICAgICAgLCBjaGFyc1sndG9wLXJpZ2h0J10gfHwgIGNoYXJzLnRvcFxuICAgICAgICAgICAgICAgLCBjaGFyc1sndG9wLW1pZCddKTtcbiAgICBpZiAobClcbiAgICAgIHJldCArPSBsICsgXCJcXG5cIjtcbiAgfTtcblxuICBmdW5jdGlvbiBnZW5lcmF0ZVJvdyAoaXRlbXMsIHN0eWxlKSB7XG4gICAgdmFyIGNlbGxzID0gW11cbiAgICAgICwgbWF4X2hlaWdodCA9IDA7XG5cbiAgICAvLyBwcmVwYXJlIHZlcnRpY2FsIGFuZCBjcm9zcyB0YWJsZSBkYXRhXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZW1zKSAmJiB0eXBlb2YgaXRlbXMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIHZhciBrZXkgPSBPYmplY3Qua2V5cyhpdGVtcylbMF1cbiAgICAgICAgLCB2YWx1ZSA9IGl0ZW1zW2tleV1cbiAgICAgICAgLCBmaXJzdF9jZWxsX2hlYWQgPSB0cnVlO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgaXRlbXMgPSB2YWx1ZTtcbiAgICAgICAgaXRlbXMudW5zaGlmdChrZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaXRlbXMgPSBba2V5LCB2YWx1ZV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gdHJhbnNmb3JtIGFycmF5IG9mIGl0ZW0gc3RyaW5ncyBpbnRvIHN0cnVjdHVyZSBvZiBjZWxsc1xuICAgIGl0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGkpIHtcbiAgICAgIHZhciBjb250ZW50cyA9IGl0ZW0udG9TdHJpbmcoKS5zcGxpdChcIlxcblwiKS5yZWR1Y2UoZnVuY3Rpb24gKG1lbW8sIGwpIHtcbiAgICAgICAgbWVtby5wdXNoKHN0cmluZyhsLCBpKSk7XG4gICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgfSwgW10pXG5cbiAgICAgIHZhciBoZWlnaHQgPSBjb250ZW50cy5sZW5ndGg7XG4gICAgICBpZiAoaGVpZ2h0ID4gbWF4X2hlaWdodCkgeyBtYXhfaGVpZ2h0ID0gaGVpZ2h0IH07XG5cbiAgICAgIGNlbGxzLnB1c2goeyBjb250ZW50czogY29udGVudHMgLCBoZWlnaHQ6IGhlaWdodCB9KTtcbiAgICB9KTtcblxuICAgIC8vIHRyYW5zZm9ybSB2ZXJ0aWNhbCBjZWxscyBpbnRvIGhvcml6b250YWwgbGluZXNcbiAgICB2YXIgbGluZXMgPSBuZXcgQXJyYXkobWF4X2hlaWdodCk7XG4gICAgY2VsbHMuZm9yRWFjaChmdW5jdGlvbiAoY2VsbCwgaSkge1xuICAgICAgY2VsbC5jb250ZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChsaW5lLCBqKSB7XG4gICAgICAgIGlmICghbGluZXNbal0pIHsgbGluZXNbal0gPSBbXSB9O1xuICAgICAgICBpZiAoc3R5bGUgfHwgKGZpcnN0X2NlbGxfaGVhZCAmJiBpID09PSAwICYmIG9wdGlvbnMuc3R5bGUuaGVhZCkpIHtcbiAgICAgICAgICBsaW5lID0gYXBwbHlTdHlsZXMob3B0aW9ucy5zdHlsZS5oZWFkLCBsaW5lKVxuICAgICAgICB9XG5cbiAgICAgICAgbGluZXNbal0ucHVzaChsaW5lKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBwb3B1bGF0ZSBlbXB0eSBsaW5lcyBpbiBjZWxsXG4gICAgICBmb3IgKHZhciBqID0gY2VsbC5oZWlnaHQsIGwgPSBtYXhfaGVpZ2h0OyBqIDwgbDsgaisrKSB7XG4gICAgICAgIGlmICghbGluZXNbal0pIHsgbGluZXNbal0gPSBbXSB9O1xuICAgICAgICBsaW5lc1tqXS5wdXNoKHN0cmluZygnJywgaSkpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHZhciByZXQgPSBcIlwiO1xuICAgIGxpbmVzLmZvckVhY2goZnVuY3Rpb24gKGxpbmUsIGluZGV4KSB7XG4gICAgICBpZiAocmV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0ICs9IFwiXFxuXCIgKyBhcHBseVN0eWxlcyhvcHRpb25zLnN0eWxlLmJvcmRlciwgY2hhcnMubGVmdCk7XG4gICAgICB9XG5cbiAgICAgIHJldCArPSBsaW5lLmpvaW4oYXBwbHlTdHlsZXMob3B0aW9ucy5zdHlsZS5ib3JkZXIsIGNoYXJzLm1pZGRsZSkpICsgYXBwbHlTdHlsZXMob3B0aW9ucy5zdHlsZS5ib3JkZXIsIGNoYXJzLnJpZ2h0KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBhcHBseVN0eWxlcyhvcHRpb25zLnN0eWxlLmJvcmRlciwgY2hhcnMubGVmdCkgKyByZXQ7XG4gIH07XG5cbiAgZnVuY3Rpb24gYXBwbHlTdHlsZXMoc3R5bGVzLCBzdWJqZWN0KSB7XG4gICAgaWYgKCFzdWJqZWN0KVxuICAgICAgcmV0dXJuICcnO1xuICAgIHN0eWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHN0eWxlKSB7XG4gICAgICBzdWJqZWN0ID0gY29sb3JzW3N0eWxlXShzdWJqZWN0KTtcbiAgICB9KTtcbiAgICByZXR1cm4gc3ViamVjdDtcbiAgfTtcblxuICAvLyByZW5kZXJzIGEgc3RyaW5nLCBieSBwYWRkaW5nIGl0IG9yIHRydW5jYXRpbmcgaXRcbiAgZnVuY3Rpb24gc3RyaW5nIChzdHIsIGluZGV4KXtcbiAgICB2YXIgc3RyID0gU3RyaW5nKHR5cGVvZiBzdHIgPT0gJ29iamVjdCcgJiYgc3RyLnRleHQgPyBzdHIudGV4dCA6IHN0cilcbiAgICAgICwgbGVuZ3RoID0gdXRpbHMuc3RybGVuKHN0cilcbiAgICAgICwgd2lkdGggPSBjb2xXaWR0aHNbaW5kZXhdXG4gICAgICAgICAgLSAoc3R5bGVbJ3BhZGRpbmctbGVmdCddIHx8IDApXG4gICAgICAgICAgLSAoc3R5bGVbJ3BhZGRpbmctcmlnaHQnXSB8fCAwKVxuICAgICAgLCBhbGlnbiA9IG9wdGlvbnMuY29sQWxpZ25zW2luZGV4XSB8fCAnbGVmdCc7XG5cbiAgICByZXR1cm4gcmVwZWF0KCcgJywgc3R5bGVbJ3BhZGRpbmctbGVmdCddIHx8IDApXG4gICAgICAgICArIChsZW5ndGggPT0gd2lkdGggPyBzdHIgOlxuICAgICAgICAgICAgIChsZW5ndGggPCB3aWR0aFxuICAgICAgICAgICAgICA/IHBhZChzdHIsICggd2lkdGggKyAoc3RyLmxlbmd0aCAtIGxlbmd0aCkgKSwgJyAnLCBhbGlnbiA9PSAnbGVmdCcgPyAncmlnaHQnIDpcbiAgICAgICAgICAgICAgICAgIChhbGlnbiA9PSAnbWlkZGxlJyA/ICdib3RoJyA6ICdsZWZ0JykpXG4gICAgICAgICAgICAgIDogKHRydW5jYXRlciA/IHRydW5jYXRlKHN0ciwgd2lkdGgsIHRydW5jYXRlcikgOiBzdHIpKVxuICAgICAgICAgICApXG4gICAgICAgICArIHJlcGVhdCgnICcsIHN0eWxlWydwYWRkaW5nLXJpZ2h0J10gfHwgMCk7XG4gIH07XG5cbiAgaWYgKGhlYWQubGVuZ3RoKXtcbiAgICBsaW5lVG9wKCk7XG5cbiAgICByZXQgKz0gZ2VuZXJhdGVSb3coaGVhZCwgc3R5bGUuaGVhZCkgKyBcIlxcblwiXG4gIH1cblxuICBpZiAodGhpcy5sZW5ndGgpXG4gICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uIChjZWxscywgaSl7XG4gICAgICBpZiAoIWhlYWQubGVuZ3RoICYmIGkgPT0gMClcbiAgICAgICAgbGluZVRvcCgpO1xuICAgICAgZWxzZSB7XG4gICAgICAgIGlmICghc3R5bGUuY29tcGFjdCB8fCBpPCghIWhlYWQubGVuZ3RoKSA/MTowIHx8IGNlbGxzLmxlbmd0aCA9PSAwKXtcbiAgICAgICAgICB2YXIgbCA9IGxpbmUoY2hhcnMubWlkXG4gICAgICAgICAgICAgICAgICAgICAsIGNoYXJzWydsZWZ0LW1pZCddXG4gICAgICAgICAgICAgICAgICAgICAsIGNoYXJzWydyaWdodC1taWQnXVxuICAgICAgICAgICAgICAgICAgICAgLCBjaGFyc1snbWlkLW1pZCddKTtcbiAgICAgICAgICBpZiAobClcbiAgICAgICAgICAgIHJldCArPSBsICsgXCJcXG5cIlxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChjZWxscy5oYXNPd25Qcm9wZXJ0eShcImxlbmd0aFwiKSAmJiAhY2VsbHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0ICs9IGdlbmVyYXRlUm93KGNlbGxzKSArIFwiXFxuXCI7XG4gICAgICB9O1xuICAgIH0pO1xuXG4gIHZhciBsID0gbGluZShjaGFycy5ib3R0b21cbiAgICAgICAgICAgICAsIGNoYXJzWydib3R0b20tbGVmdCddIHx8IGNoYXJzLmJvdHRvbVxuICAgICAgICAgICAgICwgY2hhcnNbJ2JvdHRvbS1yaWdodCddIHx8IGNoYXJzLmJvdHRvbVxuICAgICAgICAgICAgICwgY2hhcnNbJ2JvdHRvbS1taWQnXSk7XG4gIGlmIChsKVxuICAgIHJldCArPSBsO1xuICBlbHNlXG4gICAgLy8gdHJpbSB0aGUgbGFzdCAnXFxuJyBpZiB3ZSBkaWRuJ3QgYWRkIHRoZSBib3R0b20gZGVjb3JhdGlvblxuICAgIHJldCA9IHJldC5zbGljZSgwLCAtMSk7XG5cbiAgcmV0dXJuIHJldDtcbn07XG5cbi8qKlxuICogTW9kdWxlIGV4cG9ydHMuXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSBUYWJsZTtcblxubW9kdWxlLmV4cG9ydHMudmVyc2lvbiA9ICcwLjAuMSc7XG4iXX0=