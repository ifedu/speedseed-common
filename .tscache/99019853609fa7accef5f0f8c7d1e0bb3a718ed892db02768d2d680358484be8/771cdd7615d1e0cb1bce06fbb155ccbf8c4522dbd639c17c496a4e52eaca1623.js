module.exports = which;
which.sync = whichSync;
var isWindows = process.platform === 'win32' ||
    process.env.OSTYPE === 'cygwin' ||
    process.env.OSTYPE === 'msys';
var path = require('path');
var COLON = isWindows ? ';' : ':';
var isexe = require('isexe');
function getNotFoundError(cmd) {
    var er = new Error('not found: ' + cmd);
    er.code = 'ENOENT';
    return er;
}
function getPathInfo(cmd, opt) {
    var colon = opt.colon || COLON;
    var pathEnv = opt.path || process.env.PATH || '';
    var pathExt = [''];
    pathEnv = pathEnv.split(colon);
    var pathExtExe = '';
    if (isWindows) {
        pathEnv.unshift(process.cwd());
        pathExtExe = (opt.pathExt || process.env.PATHEXT || '.EXE;.CMD;.BAT;.COM');
        pathExt = pathExtExe.split(colon);
        // Always test the cmd itself first.  isexe will check to make sure
        // it's found in the pathExt set.
        if (cmd.indexOf('.') !== -1 && pathExt[0] !== '')
            pathExt.unshift('');
    }
    // If it has a slash, then we don't bother searching the pathenv.
    // just check the file itself, and that's it.
    if (cmd.match(/\//) || isWindows && cmd.match(/\\/))
        pathEnv = [''];
    return {
        env: pathEnv,
        ext: pathExt,
        extExe: pathExtExe
    };
}
function which(cmd, opt, cb) {
    if (typeof opt === 'function') {
        cb = opt;
        opt = {};
    }
    var info = getPathInfo(cmd, opt);
    var pathEnv = info.env;
    var pathExt = info.ext;
    var pathExtExe = info.extExe;
    var found = [];
    (function F(i, l) {
        if (i === l) {
            if (opt.all && found.length)
                return cb(null, found);
            else
                return cb(getNotFoundError(cmd));
        }
        var pathPart = pathEnv[i];
        if (pathPart.charAt(0) === '"' && pathPart.slice(-1) === '"')
            pathPart = pathPart.slice(1, -1);
        var p = path.join(pathPart, cmd);
        if (!pathPart && (/^\.[\\\/]/).test(cmd)) {
            p = cmd.slice(0, 2) + p;
        }
        ;
        (function E(ii, ll) {
            if (ii === ll)
                return F(i + 1, l);
            var ext = pathExt[ii];
            isexe(p + ext, { pathExt: pathExtExe }, function (er, is) {
                if (!er && is) {
                    if (opt.all)
                        found.push(p + ext);
                    else
                        return cb(null, p + ext);
                }
                return E(ii + 1, ll);
            });
        })(0, pathExt.length);
    })(0, pathEnv.length);
}
function whichSync(cmd, opt) {
    opt = opt || {};
    var info = getPathInfo(cmd, opt);
    var pathEnv = info.env;
    var pathExt = info.ext;
    var pathExtExe = info.extExe;
    var found = [];
    for (var i = 0, l = pathEnv.length; i < l; i++) {
        var pathPart = pathEnv[i];
        if (pathPart.charAt(0) === '"' && pathPart.slice(-1) === '"')
            pathPart = pathPart.slice(1, -1);
        var p = path.join(pathPart, cmd);
        if (!pathPart && /^\.[\\\/]/.test(cmd)) {
            p = cmd.slice(0, 2) + p;
        }
        for (var j = 0, ll = pathExt.length; j < ll; j++) {
            var cur = p + pathExt[j];
            var is;
            try {
                is = isexe.sync(cur, { pathExt: pathExtExe });
                if (is) {
                    if (opt.all)
                        found.push(cur);
                    else
                        return cur;
                }
            }
            catch (ex) { }
        }
    }
    if (opt.all && found.length)
        return found;
    if (opt.nothrow)
        return null;
    throw getNotFoundError(cmd);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFx3aGljaFxcd2hpY2guanMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcaWZlZHVcXEFwcERhdGFcXFJvYW1pbmdcXG52bVxcdjguNC4wXFxub2RlX21vZHVsZXNcXGdlbmVyYXRvci1zcGVlZHNlZWRcXG5vZGVfbW9kdWxlc1xcd2hpY2hcXHdoaWNoLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBQ3RCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFBO0FBRXRCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTztJQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sS0FBSyxRQUFRO0lBQy9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQTtBQUVqQyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDMUIsSUFBSSxLQUFLLEdBQUcsU0FBUyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUE7QUFDakMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBRTVCLDBCQUEyQixHQUFHO0lBQzVCLElBQUksRUFBRSxHQUFHLElBQUksS0FBSyxDQUFDLGFBQWEsR0FBRyxHQUFHLENBQUMsQ0FBQTtJQUN2QyxFQUFFLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQTtJQUVsQixNQUFNLENBQUMsRUFBRSxDQUFBO0FBQ1gsQ0FBQztBQUVELHFCQUFzQixHQUFHLEVBQUUsR0FBRztJQUM1QixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQTtJQUM5QixJQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxJ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QyxFQUFHLEVBQUUsQ0FBQztZQUNsRCxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3hCLElBQUksRUFBRSxDQUFBO1lBQ04sSUFBSSxDQUFDO2dCQUNILEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFBO2dCQUM3QyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNQLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7d0JBQ1YsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDakIsSUFBSTt3QkFDRixNQUFNLENBQUMsR0FBRyxDQUFBO2dCQUNkLENBQUM7WUFDSCxDQUFDO1lBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUM7UUFDakIsQ0FBQztJQUNILENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDMUIsTUFBTSxDQUFDLEtBQUssQ0FBQTtJQUVkLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7UUFDZCxNQUFNLENBQUMsSUFBSSxDQUFBO0lBRWIsTUFBTSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUM3QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsibW9kdWxlLmV4cG9ydHMgPSB3aGljaFxud2hpY2guc3luYyA9IHdoaWNoU3luY1xuXG52YXIgaXNXaW5kb3dzID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyB8fFxuICAgIHByb2Nlc3MuZW52Lk9TVFlQRSA9PT0gJ2N5Z3dpbicgfHxcbiAgICBwcm9jZXNzLmVudi5PU1RZUEUgPT09ICdtc3lzJ1xuXG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxudmFyIENPTE9OID0gaXNXaW5kb3dzID8gJzsnIDogJzonXG52YXIgaXNleGUgPSByZXF1aXJlKCdpc2V4ZScpXG5cbmZ1bmN0aW9uIGdldE5vdEZvdW5kRXJyb3IgKGNtZCkge1xuICB2YXIgZXIgPSBuZXcgRXJyb3IoJ25vdCBmb3VuZDogJyArIGNtZClcbiAgZXIuY29kZSA9ICdFTk9FTlQnXG5cbiAgcmV0dXJuIGVyXG59XG5cbmZ1bmN0aW9uIGdldFBhdGhJbmZvIChjbWQsIG9wdCkge1xuICB2YXIgY29sb24gPSBvcHQuY29sb24gfHwgQ09MT05cbiAgdmFyIHBhdGhFbnYgPSBvcHQucGF0aCB8fCBwcm9jZXNzLmVudi5QQVRIIHx8ICcnXG4gIHZhciBwYXRoRXh0ID0gWycnXVxuXG4gIHBhdGhFbnYgPSBwYXRoRW52LnNwbGl0KGNvbG9uKVxuXG4gIHZhciBwYXRoRXh0RXhlID0gJydcbiAgaWYgKGlzV2luZG93cykge1xuICAgIHBhdGhFbnYudW5zaGlmdChwcm9jZXNzLmN3ZCgpKVxuICAgIHBhdGhFeHRFeGUgPSAob3B0LnBhdGhFeHQgfHwgcHJvY2Vzcy5lbnYuUEFUSEVYVCB8fCAnLkVYRTsuQ01EOy5CQVQ7LkNPTScpXG4gICAgcGF0aEV4dCA9IHBhdGhFeHRFeGUuc3BsaXQoY29sb24pXG5cblxuICAgIC8vIEFsd2F5cyB0ZXN0IHRoZSBjbWQgaXRzZWxmIGZpcnN0LiAgaXNleGUgd2lsbCBjaGVjayB0byBtYWtlIHN1cmVcbiAgICAvLyBpdCdzIGZvdW5kIGluIHRoZSBwYXRoRXh0IHNldC5cbiAgICBpZiAoY21kLmluZGV4T2YoJy4nKSAhPT0gLTEgJiYgcGF0aEV4dFswXSAhPT0gJycpXG4gICAgICBwYXRoRXh0LnVuc2hpZnQoJycpXG4gIH1cblxuICAvLyBJZiBpdCBoYXMgYSBzbGFzaCwgdGhlbiB3ZSBkb24ndCBib3RoZXIgc2VhcmNoaW5nIHRoZSBwYXRoZW52LlxuICAvLyBqdXN0IGNoZWNrIHRoZSBmaWxlIGl0c2VsZiwgYW5kIHRoYXQncyBpdC5cbiAgaWYgKGNtZC5tYXRjaCgvXFwvLykgfHwgaXNXaW5kb3dzICYmIGNtZC5tYXRjaCgvXFxcXC8pKVxuICAgIHBhdGhFbnYgPSBbJyddXG5cbiAgcmV0dXJuIHtcbiAgICBlbnY6IHBhdGhFbnYsXG4gICAgZXh0OiBwYXRoRXh0LFxuICAgIGV4dEV4ZTogcGF0aEV4dEV4ZVxuICB9XG59XG5cbmZ1bmN0aW9uIHdoaWNoIChjbWQsIG9wdCwgY2IpIHtcbiAgaWYgKHR5cGVvZiBvcHQgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjYiA9IG9wdFxuICAgIG9wdCA9IHt9XG4gIH1cblxuICB2YXIgaW5mbyA9IGdldFBhdGhJbmZvKGNtZCwgb3B0KVxuICB2YXIgcGF0aEVudiA9IGluZm8uZW52XG4gIHZhciBwYXRoRXh0ID0gaW5mby5leHRcbiAgdmFyIHBhdGhFeHRFeGUgPSBpbmZvLmV4dEV4ZVxuICB2YXIgZm91bmQgPSBbXVxuXG4gIDsoZnVuY3Rpb24gRiAoaSwgbCkge1xuICAgIGlmIChpID09PSBsKSB7XG4gICAgICBpZiAob3B0LmFsbCAmJiBmb3VuZC5sZW5ndGgpXG4gICAgICAgIHJldHVybiBjYihudWxsLCBmb3VuZClcbiAgICAgIGVsc2VcbiAgICAgICAgcmV0dXJuIGNiKGdldE5vdEZvdW5kRXJyb3IoY21kKSlcbiAgICB9XG5cbiAgICB2YXIgcGF0aFBhcnQgPSBwYXRoRW52W2ldXG4gICAgaWYgKHBhdGhQYXJ0LmNoYXJBdCgwKSA9PT0gJ1wiJyAmJiBwYXRoUGFydC5zbGljZSgtMSkgPT09ICdcIicpXG4gICAgICBwYXRoUGFydCA9IHBhdGhQYXJ0LnNsaWNlKDEsIC0xKVxuXG4gICAgdmFyIHAgPSBwYXRoLmpvaW4ocGF0aFBhcnQsIGNtZClcbiAgICBpZiAoIXBhdGhQYXJ0ICYmICgvXlxcLltcXFxcXFwvXS8pLnRlc3QoY21kKSkge1xuICAgICAgcCA9IGNtZC5zbGljZSgwLCAyKSArIHBcbiAgICB9XG4gICAgOyhmdW5jdGlvbiBFIChpaSwgbGwpIHtcbiAgICAgIGlmIChpaSA9PT0gbGwpIHJldHVybiBGKGkgKyAxLCBsKVxuICAgICAgdmFyIGV4dCA9IHBhdGhFeHRbaWldXG4gICAgICBpc2V4ZShwICsgZXh0LCB7IHBhdGhFeHQ6IHBhdGhFeHRFeGUgfSwgZnVuY3Rpb24gKGVyLCBpcykge1xuICAgICAgICBpZiAoIWVyICYmIGlzKSB7XG4gICAgICAgICAgaWYgKG9wdC5hbGwpXG4gICAgICAgICAgICBmb3VuZC5wdXNoKHAgKyBleHQpXG4gICAgICAgICAgZWxzZVxuICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHAgKyBleHQpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEUoaWkgKyAxLCBsbClcbiAgICAgIH0pXG4gICAgfSkoMCwgcGF0aEV4dC5sZW5ndGgpXG4gIH0pKDAsIHBhdGhFbnYubGVuZ3RoKVxufVxuXG5mdW5jdGlvbiB3aGljaFN5bmMgKGNtZCwgb3B0KSB7XG4gIG9wdCA9IG9wdCB8fCB7fVxuXG4gIHZhciBpbmZvID0gZ2V0UGF0aEluZm8oY21kLCBvcHQpXG4gIHZhciBwYXRoRW52ID0gaW5mby5lbnZcbiAgdmFyIHBhdGhFeHQgPSBpbmZvLmV4dFxuICB2YXIgcGF0aEV4dEV4ZSA9IGluZm8uZXh0RXhlXG4gIHZhciBmb3VuZCA9IFtdXG5cbiAgZm9yICh2YXIgaSA9IDAsIGwgPSBwYXRoRW52Lmxlbmd0aDsgaSA8IGw7IGkgKyspIHtcbiAgICB2YXIgcGF0aFBhcnQgPSBwYXRoRW52W2ldXG4gICAgaWYgKHBhdGhQYXJ0LmNoYXJBdCgwKSA9PT0gJ1wiJyAmJiBwYXRoUGFydC5zbGljZSgtMSkgPT09ICdcIicpXG4gICAgICBwYXRoUGFydCA9IHBhdGhQYXJ0LnNsaWNlKDEsIC0xKVxuXG4gICAgdmFyIHAgPSBwYXRoLmpvaW4ocGF0aFBhcnQsIGNtZClcbiAgICBpZiAoIXBhdGhQYXJ0ICYmIC9eXFwuW1xcXFxcXC9dLy50ZXN0KGNtZCkpIHtcbiAgICAgIHAgPSBjbWQuc2xpY2UoMCwgMikgKyBwXG4gICAgfVxuICAgIGZvciAodmFyIGogPSAwLCBsbCA9IHBhdGhFeHQubGVuZ3RoOyBqIDwgbGw7IGogKyspIHtcbiAgICAgIHZhciBjdXIgPSBwICsgcGF0aEV4dFtqXVxuICAgICAgdmFyIGlzXG4gICAgICB0cnkge1xuICAgICAgICBpcyA9IGlzZXhlLnN5bmMoY3VyLCB7IHBhdGhFeHQ6IHBhdGhFeHRFeGUgfSlcbiAgICAgICAgaWYgKGlzKSB7XG4gICAgICAgICAgaWYgKG9wdC5hbGwpXG4gICAgICAgICAgICBmb3VuZC5wdXNoKGN1cilcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICByZXR1cm4gY3VyXG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGV4KSB7fVxuICAgIH1cbiAgfVxuXG4gIGlmIChvcHQuYWxsICYmIGZvdW5kLmxlbmd0aClcbiAgICByZXR1cm4gZm91bmRcblxuICBpZiAob3B0Lm5vdGhyb3cpXG4gICAgcmV0dXJuIG51bGxcblxuICB0aHJvdyBnZXROb3RGb3VuZEVycm9yKGNtZClcbn1cbiJdfQ==