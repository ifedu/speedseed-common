/**
 * `list` type prompt
 */
var _ = require('lodash');
var util = require('util');
var chalk = require('chalk');
var cliCursor = require('cli-cursor');
var figures = require('figures');
var Base = require('./base');
var observe = require('../utils/events');
var Paginator = require('../utils/paginator');
/**
 * Module exports
 */
module.exports = Prompt;
/**
 * Constructor
 */
function Prompt() {
    Base.apply(this, arguments);
    if (!this.opt.choices) {
        this.throwParamError('choices');
    }
    if (_.isArray(this.opt.default)) {
        this.opt.choices.forEach(function (choice) {
            if (this.opt.default.indexOf(choice.value) >= 0) {
                choice.checked = true;
            }
        }, this);
    }
    this.pointer = 0;
    // Make sure no default is set (so it won't be printed)
    this.opt.default = null;
    this.paginator = new Paginator();
}
util.inherits(Prompt, Base);
/**
 * Start the Inquiry session
 * @param  {Function} cb      Callback when prompt is done
 * @return {this}
 */
Prompt.prototype._run = function (cb) {
    this.done = cb;
    var events = observe(this.rl);
    var validation = this.handleSubmitEvents(events.line.map(this.getCurrentValue.bind(this)));
    validation.success.forEach(this.onEnd.bind(this));
    validation.error.forEach(this.onError.bind(this));
    events.normalizedUpKey.takeUntil(validation.success).forEach(this.onUpKey.bind(this));
    events.normalizedDownKey.takeUntil(validation.success).forEach(this.onDownKey.bind(this));
    events.numberKey.takeUntil(validation.success).forEach(this.onNumberKey.bind(this));
    events.spaceKey.takeUntil(validation.success).forEach(this.onSpaceKey.bind(this));
    events.aKey.takeUntil(validation.success).forEach(this.onAllKey.bind(this));
    events.iKey.takeUntil(validation.success).forEach(this.onInverseKey.bind(this));
    // Init the prompt
    cliCursor.hide();
    this.render();
    return this;
};
/**
 * Render the prompt to screen
 * @return {Prompt} self
 */
Prompt.prototype.render = function (error) {
    // Render question
    var message = this.getQuestion();
    var bottomContent = '';
    if (!this.spaceKeyPressed) {
        message += '(Press ' + chalk.cyan.bold('<space>') + ' to select, ' + chalk.cyan.bold('<a>') + ' to toggle all, ' + chalk.cyan.bold('<i>') + ' to inverse selection)';
    }
    // Render choices or answer depending on the state
    if (this.status === 'answered') {
        message += chalk.cyan(this.selection.join(', '));
    }
    else {
        var choicesStr = renderChoices(this.opt.choices, this.pointer);
        var indexPosition = this.opt.choices.indexOf(this.opt.choices.getChoice(this.pointer));
        message += '\n' + this.paginator.paginate(choicesStr, indexPosition, this.opt.pageSize);
    }
    if (error) {
        bottomContent = chalk.red('>> ') + error;
    }
    this.screen.render(message, bottomContent);
};
/**
 * When user press `enter` key
 */
Prompt.prototype.onEnd = function (state) {
    this.status = 'answered';
    // Rerender prompt (and clean subline error)
    this.render();
    this.screen.done();
    cliCursor.show();
    this.done(state.value);
};
Prompt.prototype.onError = function (state) {
    this.render(state.isValid);
};
Prompt.prototype.getCurrentValue = function () {
    var choices = this.opt.choices.filter(function (choice) {
        return Boolean(choice.checked) && !choice.disabled;
    });
    this.selection = _.map(choices, 'short');
    return _.map(choices, 'value');
};
Prompt.prototype.onUpKey = function () {
    var len = this.opt.choices.realLength;
    this.pointer = (this.pointer > 0) ? this.pointer - 1 : len - 1;
    this.render();
};
Prompt.prototype.onDownKey = function () {
    var len = this.opt.choices.realLength;
    this.pointer = (this.pointer < len - 1) ? this.pointer + 1 : 0;
    this.render();
};
Prompt.prototype.onNumberKey = function (input) {
    if (input <= this.opt.choices.realLength) {
        this.pointer = input - 1;
        this.toggleChoice(this.pointer);
    }
    this.render();
};
Prompt.prototype.onSpaceKey = function () {
    this.spaceKeyPressed = true;
    this.toggleChoice(this.pointer);
    this.render();
};
Prompt.prototype.onAllKey = function () {
    var shouldBeChecked = Boolean(this.opt.choices.find(function (choice) {
        return choice.type !== 'separator' && !choice.checked;
    }));
    this.opt.choices.forEach(function (choice) {
        if (choice.type !== 'separator') {
            choice.checked = shouldBeChecked;
        }
    });
    this.render();
};
Prompt.prototype.onInverseKey = function () {
    this.opt.choices.forEach(function (choice) {
        if (choice.type !== 'separator') {
            choice.checked = !choice.checked;
        }
    });
    this.render();
};
Prompt.prototype.toggleChoice = function (index) {
    var item = this.opt.choices.getChoice(index);
    if (item !== undefined) {
        this.opt.choices.getChoice(index).checked = !item.checked;
    }
};
/**
 * Function for rendering checkbox choices
 * @param  {Number} pointer Position of the pointer
 * @return {String}         Rendered content
 */
function renderChoices(choices, pointer) {
    var output = '';
    var separatorOffset = 0;
    choices.forEach(function (choice, i) {
        if (choice.type === 'separator') {
            separatorOffset++;
            output += ' ' + choice + '\n';
            return;
        }
        if (choice.disabled) {
            separatorOffset++;
            output += ' - ' + choice.name;
            output += ' (' + (_.isString(choice.disabled) ? choice.disabled : 'Disabled') + ')';
        }
        else {
            var isSelected = (i - separatorOffset === pointer);
            output += isSelected ? chalk.cyan(figures.pointer) : ' ';
            output += getCheckbox(choice.checked) + ' ' + choice.name;
        }
        output += '\n';
    });
    return output.replace(/\n$/, '');
}
/**
 * Get the checkbox
 * @param  {Boolean} checked - add a X or not to the checkbox
 * @return {String} Composited checkbox string
 */
function getCheckbox(checked) {
    return checked ? chalk.green(figures.radioOn) : figures.radioOff;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFxwcm9tcHRzXFxjaGVja2JveC5qcyIsInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFxwcm9tcHRzXFxjaGVja2JveC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN0QyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDakMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3pDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRTlDOztHQUVHO0FBRUgsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFFeEI7O0dBRUc7QUFFSDtJQUNFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRTVCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLElBQUks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R0FBRyxDQUFDLENBQUMsR0FBRyxlQUFlLEtBQUssT0FBTyxDQUFDLENBQUM7WUFDbkQsTUFBTSxJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDekQsTUFBTSxJQUFJLFdBQVcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDNUQsQ0FBQztRQUVELE1BQU0sSUFBSSxJQUFJLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDbkMsQ0FBQztBQUVEOzs7O0dBSUc7QUFFSCxxQkFBcUIsT0FBTztJQUMxQixNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7QUFDbkUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogYGxpc3RgIHR5cGUgcHJvbXB0XG4gKi9cblxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xudmFyIGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKTtcbnZhciBjbGlDdXJzb3IgPSByZXF1aXJlKCdjbGktY3Vyc29yJyk7XG52YXIgZmlndXJlcyA9IHJlcXVpcmUoJ2ZpZ3VyZXMnKTtcbnZhciBCYXNlID0gcmVxdWlyZSgnLi9iYXNlJyk7XG52YXIgb2JzZXJ2ZSA9IHJlcXVpcmUoJy4uL3V0aWxzL2V2ZW50cycpO1xudmFyIFBhZ2luYXRvciA9IHJlcXVpcmUoJy4uL3V0aWxzL3BhZ2luYXRvcicpO1xuXG4vKipcbiAqIE1vZHVsZSBleHBvcnRzXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSBQcm9tcHQ7XG5cbi8qKlxuICogQ29uc3RydWN0b3JcbiAqL1xuXG5mdW5jdGlvbiBQcm9tcHQoKSB7XG4gIEJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcblxuICBpZiAoIXRoaXMub3B0LmNob2ljZXMpIHtcbiAgICB0aGlzLnRocm93UGFyYW1FcnJvcignY2hvaWNlcycpO1xuICB9XG5cbiAgaWYgKF8uaXNBcnJheSh0aGlzLm9wdC5kZWZhdWx0KSkge1xuICAgIHRoaXMub3B0LmNob2ljZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlKSB7XG4gICAgICBpZiAodGhpcy5vcHQuZGVmYXVsdC5pbmRleE9mKGNob2ljZS52YWx1ZSkgPj0gMCkge1xuICAgICAgICBjaG9pY2UuY2hlY2tlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSwgdGhpcyk7XG4gIH1cblxuICB0aGlzLnBvaW50ZXIgPSAwO1xuXG4gIC8vIE1ha2Ugc3VyZSBubyBkZWZhdWx0IGlzIHNldCAoc28gaXQgd29uJ3QgYmUgcHJpbnRlZClcbiAgdGhpcy5vcHQuZGVmYXVsdCA9IG51bGw7XG5cbiAgdGhpcy5wYWdpbmF0b3IgPSBuZXcgUGFnaW5hdG9yKCk7XG59XG51dGlsLmluaGVyaXRzKFByb21wdCwgQmFzZSk7XG5cbi8qKlxuICogU3RhcnQgdGhlIElucXVpcnkgc2Vzc2lvblxuICogQHBhcmFtICB7RnVuY3Rpb259IGNiICAgICAgQ2FsbGJhY2sgd2hlbiBwcm9tcHQgaXMgZG9uZVxuICogQHJldHVybiB7dGhpc31cbiAqL1xuXG5Qcm9tcHQucHJvdG90eXBlLl9ydW4gPSBmdW5jdGlvbiAoY2IpIHtcbiAgdGhpcy5kb25lID0gY2I7XG5cbiAgdmFyIGV2ZW50cyA9IG9ic2VydmUodGhpcy5ybCk7XG5cbiAgdmFyIHZhbGlkYXRpb24gPSB0aGlzLmhhbmRsZVN1Ym1pdEV2ZW50cyhcbiAgICBldmVudHMubGluZS5tYXAodGhpcy5nZXRDdXJyZW50VmFsdWUuYmluZCh0aGlzKSlcbiAgKTtcbiAgdmFsaWRhdGlvbi5zdWNjZXNzLmZvckVhY2godGhpcy5vbkVuZC5iaW5kKHRoaXMpKTtcbiAgdmFsaWRhdGlvbi5lcnJvci5mb3JFYWNoKHRoaXMub25FcnJvci5iaW5kKHRoaXMpKTtcblxuICBldmVudHMubm9ybWFsaXplZFVwS2V5LnRha2VVbnRpbCh2YWxpZGF0aW9uLnN1Y2Nlc3MpLmZvckVhY2godGhpcy5vblVwS2V5LmJpbmQodGhpcykpO1xuICBldmVudHMubm9ybWFsaXplZERvd25LZXkudGFrZVVudGlsKHZhbGlkYXRpb24uc3VjY2VzcykuZm9yRWFjaCh0aGlzLm9uRG93bktleS5iaW5kKHRoaXMpKTtcbiAgZXZlbnRzLm51bWJlcktleS50YWtlVW50aWwodmFsaWRhdGlvbi5zdWNjZXNzKS5mb3JFYWNoKHRoaXMub25OdW1iZXJLZXkuYmluZCh0aGlzKSk7XG4gIGV2ZW50cy5zcGFjZUtleS50YWtlVW50aWwodmFsaWRhdGlvbi5zdWNjZXNzKS5mb3JFYWNoKHRoaXMub25TcGFjZUtleS5iaW5kKHRoaXMpKTtcbiAgZXZlbnRzLmFLZXkudGFrZVVudGlsKHZhbGlkYXRpb24uc3VjY2VzcykuZm9yRWFjaCh0aGlzLm9uQWxsS2V5LmJpbmQodGhpcykpO1xuICBldmVudHMuaUtleS50YWtlVW50aWwodmFsaWRhdGlvbi5zdWNjZXNzKS5mb3JFYWNoKHRoaXMub25JbnZlcnNlS2V5LmJpbmQodGhpcykpO1xuXG4gIC8vIEluaXQgdGhlIHByb21wdFxuICBjbGlDdXJzb3IuaGlkZSgpO1xuICB0aGlzLnJlbmRlcigpO1xuXG4gIHJldHVybiB0aGlzO1xufTtcblxuLyoqXG4gKiBSZW5kZXIgdGhlIHByb21wdCB0byBzY3JlZW5cbiAqIEByZXR1cm4ge1Byb21wdH0gc2VsZlxuICovXG5cblByb21wdC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKGVycm9yKSB7XG4gIC8vIFJlbmRlciBxdWVzdGlvblxuICB2YXIgbWVzc2FnZSA9IHRoaXMuZ2V0UXVlc3Rpb24oKTtcbiAgdmFyIGJvdHRvbUNvbnRlbnQgPSAnJztcblxuICBpZiAoIXRoaXMuc3BhY2VLZXlQcmVzc2VkKSB7XG4gICAgbWVzc2FnZSArPSAnKFByZXNzICcgKyBjaGFsay5jeWFuLmJvbGQoJzxzcGFjZT4nKSArICcgdG8gc2VsZWN0LCAnICsgY2hhbGsuY3lhbi5ib2xkKCc8YT4nKSArICcgdG8gdG9nZ2xlIGFsbCwgJyArIGNoYWxrLmN5YW4uYm9sZCgnPGk+JykgKyAnIHRvIGludmVyc2Ugc2VsZWN0aW9uKSc7XG4gIH1cblxuICAvLyBSZW5kZXIgY2hvaWNlcyBvciBhbnN3ZXIgZGVwZW5kaW5nIG9uIHRoZSBzdGF0ZVxuICBpZiAodGhpcy5zdGF0dXMgPT09ICdhbnN3ZXJlZCcpIHtcbiAgICBtZXNzYWdlICs9IGNoYWxrLmN5YW4odGhpcy5zZWxlY3Rpb24uam9pbignLCAnKSk7XG4gIH0gZWxzZSB7XG4gICAgdmFyIGNob2ljZXNTdHIgPSByZW5kZXJDaG9pY2VzKHRoaXMub3B0LmNob2ljZXMsIHRoaXMucG9pbnRlcik7XG4gICAgdmFyIGluZGV4UG9zaXRpb24gPSB0aGlzLm9wdC5jaG9pY2VzLmluZGV4T2YodGhpcy5vcHQuY2hvaWNlcy5nZXRDaG9pY2UodGhpcy5wb2ludGVyKSk7XG4gICAgbWVzc2FnZSArPSAnXFxuJyArIHRoaXMucGFnaW5hdG9yLnBhZ2luYXRlKGNob2ljZXNTdHIsIGluZGV4UG9zaXRpb24sIHRoaXMub3B0LnBhZ2VTaXplKTtcbiAgfVxuXG4gIGlmIChlcnJvcikge1xuICAgIGJvdHRvbUNvbnRlbnQgPSBjaGFsay5yZWQoJz4+ICcpICsgZXJyb3I7XG4gIH1cblxuICB0aGlzLnNjcmVlbi5yZW5kZXIobWVzc2FnZSwgYm90dG9tQ29udGVudCk7XG59O1xuXG4vKipcbiAqIFdoZW4gdXNlciBwcmVzcyBgZW50ZXJgIGtleVxuICovXG5cblByb21wdC5wcm90b3R5cGUub25FbmQgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgdGhpcy5zdGF0dXMgPSAnYW5zd2VyZWQnO1xuXG4gIC8vIFJlcmVuZGVyIHByb21wdCAoYW5kIGNsZWFuIHN1YmxpbmUgZXJyb3IpXG4gIHRoaXMucmVuZGVyKCk7XG5cbiAgdGhpcy5zY3JlZW4uZG9uZSgpO1xuICBjbGlDdXJzb3Iuc2hvdygpO1xuICB0aGlzLmRvbmUoc3RhdGUudmFsdWUpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbkVycm9yID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gIHRoaXMucmVuZGVyKHN0YXRlLmlzVmFsaWQpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5nZXRDdXJyZW50VmFsdWUgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBjaG9pY2VzID0gdGhpcy5vcHQuY2hvaWNlcy5maWx0ZXIoZnVuY3Rpb24gKGNob2ljZSkge1xuICAgIHJldHVybiBCb29sZWFuKGNob2ljZS5jaGVja2VkKSAmJiAhY2hvaWNlLmRpc2FibGVkO1xuICB9KTtcblxuICB0aGlzLnNlbGVjdGlvbiA9IF8ubWFwKGNob2ljZXMsICdzaG9ydCcpO1xuICByZXR1cm4gXy5tYXAoY2hvaWNlcywgJ3ZhbHVlJyk7XG59O1xuXG5Qcm9tcHQucHJvdG90eXBlLm9uVXBLZXkgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBsZW4gPSB0aGlzLm9wdC5jaG9pY2VzLnJlYWxMZW5ndGg7XG4gIHRoaXMucG9pbnRlciA9ICh0aGlzLnBvaW50ZXIgPiAwKSA/IHRoaXMucG9pbnRlciAtIDEgOiBsZW4gLSAxO1xuICB0aGlzLnJlbmRlcigpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbkRvd25LZXkgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBsZW4gPSB0aGlzLm9wdC5jaG9pY2VzLnJlYWxMZW5ndGg7XG4gIHRoaXMucG9pbnRlciA9ICh0aGlzLnBvaW50ZXIgPCBsZW4gLSAxKSA/IHRoaXMucG9pbnRlciArIDEgOiAwO1xuICB0aGlzLnJlbmRlcigpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbk51bWJlcktleSA9IGZ1bmN0aW9uIChpbnB1dCkge1xuICBpZiAoaW5wdXQgPD0gdGhpcy5vcHQuY2hvaWNlcy5yZWFsTGVuZ3RoKSB7XG4gICAgdGhpcy5wb2ludGVyID0gaW5wdXQgLSAxO1xuICAgIHRoaXMudG9nZ2xlQ2hvaWNlKHRoaXMucG9pbnRlcik7XG4gIH1cbiAgdGhpcy5yZW5kZXIoKTtcbn07XG5cblByb21wdC5wcm90b3R5cGUub25TcGFjZUtleSA9IGZ1bmN0aW9uICgpIHtcbiAgdGhpcy5zcGFjZUtleVByZXNzZWQgPSB0cnVlO1xuICB0aGlzLnRvZ2dsZUNob2ljZSh0aGlzLnBvaW50ZXIpO1xuICB0aGlzLnJlbmRlcigpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbkFsbEtleSA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHNob3VsZEJlQ2hlY2tlZCA9IEJvb2xlYW4odGhpcy5vcHQuY2hvaWNlcy5maW5kKGZ1bmN0aW9uIChjaG9pY2UpIHtcbiAgICByZXR1cm4gY2hvaWNlLnR5cGUgIT09ICdzZXBhcmF0b3InICYmICFjaG9pY2UuY2hlY2tlZDtcbiAgfSkpO1xuXG4gIHRoaXMub3B0LmNob2ljZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlKSB7XG4gICAgaWYgKGNob2ljZS50eXBlICE9PSAnc2VwYXJhdG9yJykge1xuICAgICAgY2hvaWNlLmNoZWNrZWQgPSBzaG91bGRCZUNoZWNrZWQ7XG4gICAgfVxuICB9KTtcblxuICB0aGlzLnJlbmRlcigpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbkludmVyc2VLZXkgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMub3B0LmNob2ljZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlKSB7XG4gICAgaWYgKGNob2ljZS50eXBlICE9PSAnc2VwYXJhdG9yJykge1xuICAgICAgY2hvaWNlLmNoZWNrZWQgPSAhY2hvaWNlLmNoZWNrZWQ7XG4gICAgfVxuICB9KTtcblxuICB0aGlzLnJlbmRlcigpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS50b2dnbGVDaG9pY2UgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgdmFyIGl0ZW0gPSB0aGlzLm9wdC5jaG9pY2VzLmdldENob2ljZShpbmRleCk7XG4gIGlmIChpdGVtICE9PSB1bmRlZmluZWQpIHtcbiAgICB0aGlzLm9wdC5jaG9pY2VzLmdldENob2ljZShpbmRleCkuY2hlY2tlZCA9ICFpdGVtLmNoZWNrZWQ7XG4gIH1cbn07XG5cbi8qKlxuICogRnVuY3Rpb24gZm9yIHJlbmRlcmluZyBjaGVja2JveCBjaG9pY2VzXG4gKiBAcGFyYW0gIHtOdW1iZXJ9IHBvaW50ZXIgUG9zaXRpb24gb2YgdGhlIHBvaW50ZXJcbiAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgICBSZW5kZXJlZCBjb250ZW50XG4gKi9cblxuZnVuY3Rpb24gcmVuZGVyQ2hvaWNlcyhjaG9pY2VzLCBwb2ludGVyKSB7XG4gIHZhciBvdXRwdXQgPSAnJztcbiAgdmFyIHNlcGFyYXRvck9mZnNldCA9IDA7XG5cbiAgY2hvaWNlcy5mb3JFYWNoKGZ1bmN0aW9uIChjaG9pY2UsIGkpIHtcbiAgICBpZiAoY2hvaWNlLnR5cGUgPT09ICdzZXBhcmF0b3InKSB7XG4gICAgICBzZXBhcmF0b3JPZmZzZXQrKztcbiAgICAgIG91dHB1dCArPSAnICcgKyBjaG9pY2UgKyAnXFxuJztcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoY2hvaWNlLmRpc2FibGVkKSB7XG4gICAgICBzZXBhcmF0b3JPZmZzZXQrKztcbiAgICAgIG91dHB1dCArPSAnIC0gJyArIGNob2ljZS5uYW1lO1xuICAgICAgb3V0cHV0ICs9ICcgKCcgKyAoXy5pc1N0cmluZyhjaG9pY2UuZGlzYWJsZWQpID8gY2hvaWNlLmRpc2FibGVkIDogJ0Rpc2FibGVkJykgKyAnKSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBpc1NlbGVjdGVkID0gKGkgLSBzZXBhcmF0b3JPZmZzZXQgPT09IHBvaW50ZXIpO1xuICAgICAgb3V0cHV0ICs9IGlzU2VsZWN0ZWQgPyBjaGFsay5jeWFuKGZpZ3VyZXMucG9pbnRlcikgOiAnICc7XG4gICAgICBvdXRwdXQgKz0gZ2V0Q2hlY2tib3goY2hvaWNlLmNoZWNrZWQpICsgJyAnICsgY2hvaWNlLm5hbWU7XG4gICAgfVxuXG4gICAgb3V0cHV0ICs9ICdcXG4nO1xuICB9KTtcblxuICByZXR1cm4gb3V0cHV0LnJlcGxhY2UoL1xcbiQvLCAnJyk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBjaGVja2JveFxuICogQHBhcmFtICB7Qm9vbGVhbn0gY2hlY2tlZCAtIGFkZCBhIFggb3Igbm90IHRvIHRoZSBjaGVja2JveFxuICogQHJldHVybiB7U3RyaW5nfSBDb21wb3NpdGVkIGNoZWNrYm94IHN0cmluZ1xuICovXG5cbmZ1bmN0aW9uIGdldENoZWNrYm94KGNoZWNrZWQpIHtcbiAgcmV0dXJuIGNoZWNrZWQgPyBjaGFsay5ncmVlbihmaWd1cmVzLnJhZGlvT24pIDogZmlndXJlcy5yYWRpb09mZjtcbn1cbiJdfQ==