var common = require('./common');
var fs = require('fs');
var path = require('path');
var PERMS = (function (base) {
    return {
        OTHER_EXEC: base.EXEC,
        OTHER_WRITE: base.WRITE,
        OTHER_READ: base.READ,
        GROUP_EXEC: base.EXEC << 3,
        GROUP_WRITE: base.WRITE << 3,
        GROUP_READ: base.READ << 3,
        OWNER_EXEC: base.EXEC << 6,
        OWNER_WRITE: base.WRITE << 6,
        OWNER_READ: base.READ << 6,
        // Literal octal numbers are apparently not allowed in "strict" javascript.
        STICKY: parseInt('01000', 8),
        SETGID: parseInt('02000', 8),
        SETUID: parseInt('04000', 8),
        TYPE_MASK: parseInt('0770000', 8),
    };
}({
    EXEC: 1,
    WRITE: 2,
    READ: 4,
}));
common.register('chmod', _chmod, {});
//@
//@ ### chmod([options,] octal_mode || octal_string, file)
//@ ### chmod([options,] symbolic_mode, file)
//@
//@ Available options:
//@
//@ + `-v`: output a diagnostic for every file processed//@
//@ + `-c`: like verbose but report only when a change is made//@
//@ + `-R`: change files and directories recursively//@
//@
//@ Examples:
//@
//@ ```javascript
//@ chmod(755, '/Users/brandon');
//@ chmod('755', '/Users/brandon'); // same as above
//@ chmod('u+x', '/Users/brandon');
//@ chmod('-R', 'a-w', '/Users/brandon');
//@ ```
//@
//@ Alters the permissions of a file or directory by either specifying the
//@ absolute permissions in octal form or expressing the changes in symbols.
//@ This command tries to mimic the POSIX behavior as much as possible.
//@ Notable exceptions:
//@
//@ + In symbolic modes, 'a-r' and '-r' are identical.  No consideration is
//@   given to the umask.
//@ + There is no "quiet" option since default behavior is to run silent.
function _chmod(options, mode, filePattern) {
    if (!filePattern) {
        if (options.length > 0 && options.charAt(0) === '-') {
            // Special case where the specified file permissions started with - to subtract perms, which
            // get picked up by the option parser as command flags.
            // If we are down by one argument and options starts with -, shift everything over.
            [].unshift.call(arguments, '');
        }
        else {
            common.error('You must specify a file.');
        }
    }
    options = common.parseOptions(options, {
        'R': 'recursive',
        'c': 'changes',
        'v': 'verbose',
    });
    filePattern = [].slice.call(arguments, 2);
    var files;
    // TODO: replace this with a call to common.expand()
    if (options.recursive) {
        files = [];
        filePattern.forEach(function addFile(expandedFile) {
            var stat = fs.lstatSync(expandedFile);
            if (!stat.isSymbolicLink()) {
                files.push(expandedFile);
                if (stat.isDirectory()) {
                    fs.readdirSync(expandedFile).forEach(function (child) {
                        addFile(expandedFile + '/' + child);
                    });
                }
            }
        });
    }
    else {
        files = filePattern;
    }
    files.forEach(function innerChmod(file) {
        file = path.resolve(file);
        if (!fs.existsSync(file)) {
            common.error('File not found: ' + file);
        }
        // When recursing, don't follow symlinks.
        if (options.recursive && fs.lstatSync(file).isSymbolicLink()) {
            return;
        }
        var stat = fs.statSync(file);
        var isDir = stat.isDirectory();
        var perms = stat.mode;
        var type = perms & PERMS.TYPE_MASK;
        var newPerms = perms;
        if (isNaN(parseInt(mode, 8))) {
            // parse options
            mode.split(',').forEach(function (symbolicMode) {
                var pattern = /([ugoa]*)([=\+-])([rwxXst]*)/i;
                var matches = pattern.exec(symbolicMode);
                if (matches) {
                    var applyTo = matches[1];
                    var operator = matches[2];
                    var change = matches[3];
                    var changeOwner = applyTo.indexOf('u') !== -1 || applyTo === 'a' || applyTo === '';
                    var changeGroup = applyTo.indexOf('g') !== -1 || applyTo === 'a' || applyTo === '';
                    var changeOther = applyTo.indexOf('o') !== -1 || applyTo === 'a' || applyTo === '';
                    var changeRead = change.indexOf('r') !== -1;
                    var changeWrite = change.indexOf('w') !== -1;
                    var changeExec = change.indexOf('x') !== -1;
                    var changeExecDir = change.indexOf('X') !== -1;
                    var changeSticky = change.indexOf('t') !== -1;
                    var changeSetuid = change.indexOf('s') !== -1;
                    if (changeExecDir && isDir) {
                        changeExec = true;
                    }
                    var mask = 0;
                    if (changeOwner) {
                        mask |= (changeRead ? PERMS.OWNER_READ : 0) + (changeWrite ? PERMS.OWNER_WRITE : 0) + (changeExec ? PERMS.OWNER_EXEC : 0) + (changeSetuid ? PERMS.SETUID : 0);
                    }
                    if (changeGroup) {
                        mask |= (changeRead ? PERMS.GROUP_READ : 0) + (changeWrite ? PERMS.GROUP_WRITE : 0) + (changeExec ? PERMS.GROUP_EXEC : 0) + (changeSetuid ? PERMS.SETGID : 0);
                    }
                    if (changeOther) {
                        mask |= (changeRead ? PERMS.OTHER_READ : 0) + (changeWrite ? PERMS.OTHER_WRITE : 0) + (changeExec ? PERMS.OTHER_EXEC : 0);
                    }
                    // Sticky bit is special - it's not tied to user, group or other.
                    if (changeSticky) {
                        mask |= PERMS.STICKY;
                    }
                    switch (operator) {
                        case '+':
                            newPerms |= mask;
                            break;
                        case '-':
                            newPerms &= ~mask;
                            break;
                        case '=':
                            newPerms = type + mask;
                            // According to POSIX, when using = to explicitly set the
                            // permissions, setuid and setgid can never be cleared.
                            if (fs.statSync(file).isDirectory()) {
                                newPerms |= (PERMS.SETUID + PERMS.SETGID) & perms;
                            }
                            break;
                        default:
                            common.error('Could not recognize operator: `' + operator + '`');
                    }
                    if (options.verbose) {
                        console.log(file + ' -> ' + newPerms.toString(8));
                    }
                    if (perms !== newPerms) {
                        if (!options.verbose && options.changes) {
                            console.log(file + ' -> ' + newPerms.toString(8));
                        }
                        fs.chmodSync(file, newPerms);
                        perms = newPerms; // for the next round of changes!
                    }
                }
                else {
                    common.error('Invalid symbolic mode change: ' + symbolicMode);
                }
            });
        }
        else {
            // they gave us a full number
            newPerms = type + parseInt(mode, 8);
            // POSIX rules are that setuid and setgid can only be added using numeric
            // form, but not cleared.
            if (fs.statSync(file).isDirectory()) {
                newPerms |= (PERMS.SETUID + PERMS.SETGID) & perms;
            }
            fs.chmodSync(file, newPerms);
        }
    });
    return '';
}
module.exports = _chmod;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxzaGVsbGpzXFxzcmNcXGNobW9kLmpzIiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGlmZWR1XFxBcHBEYXRhXFxSb2FtaW5nXFxudm1cXHY4LjQuMFxcbm9kZV9tb2R1bGVzXFxnZW5lcmF0b3Itc3BlZWRzZWVkXFxub2RlX21vZHVsZXNcXHNoZWxsanNcXHNyY1xcY2htb2QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2pDLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN2QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFM0IsSUFBSSxLQUFLLEdBQUcsQ0FBQyxVQUFVLElBQUk7SUFDekIsTUFBTSxDQUFDO1FBQ0wsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJO1FBQ3JCLFdBQVcsRUFBRSxJQUFJLENBQUMsS0FBSztRQUN2QixVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUk7UUFFckIsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztRQUMxQixXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO1FBQzVCLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUM7UUFFMUIsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztRQUMxQixXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO1FBQzVCLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUM7UUFFMUIsMkVBQTJFO1FBQzNFLE1BQU0sRUFBRSxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUM1QixNQUFNLEVB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QUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNwRCxDQUFDO3dCQUNELEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO3dCQUM3QixLQUFLLEdBQUcsUUFBUSxDQUFDLENBQUMsaUNBQWlDO29CQUNyRCxDQUFDO2dCQUNILENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sTUFBTSxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRyxZQUFZLENBQUMsQ0FBQztnQkFDaEUsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sNkJBQTZCO1lBQzdCLFFBQVEsR0FBRyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUVwQyx5RUFBeUU7WUFDekUseUJBQXlCO1lBQ3pCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDcEQsQ0FBQztZQUVELEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxFQUFFLENBQUM7QUFDWixDQUFDO0FBQ0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY29tbW9uID0gcmVxdWlyZSgnLi9jb21tb24nKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxudmFyIFBFUk1TID0gKGZ1bmN0aW9uIChiYXNlKSB7XG4gIHJldHVybiB7XG4gICAgT1RIRVJfRVhFQzogYmFzZS5FWEVDLFxuICAgIE9USEVSX1dSSVRFOiBiYXNlLldSSVRFLFxuICAgIE9USEVSX1JFQUQ6IGJhc2UuUkVBRCxcblxuICAgIEdST1VQX0VYRUM6IGJhc2UuRVhFQyA8PCAzLFxuICAgIEdST1VQX1dSSVRFOiBiYXNlLldSSVRFIDw8IDMsXG4gICAgR1JPVVBfUkVBRDogYmFzZS5SRUFEIDw8IDMsXG5cbiAgICBPV05FUl9FWEVDOiBiYXNlLkVYRUMgPDwgNixcbiAgICBPV05FUl9XUklURTogYmFzZS5XUklURSA8PCA2LFxuICAgIE9XTkVSX1JFQUQ6IGJhc2UuUkVBRCA8PCA2LFxuXG4gICAgLy8gTGl0ZXJhbCBvY3RhbCBudW1iZXJzIGFyZSBhcHBhcmVudGx5IG5vdCBhbGxvd2VkIGluIFwic3RyaWN0XCIgamF2YXNjcmlwdC5cbiAgICBTVElDS1k6IHBhcnNlSW50KCcwMTAwMCcsIDgpLFxuICAgIFNFVEdJRDogcGFyc2VJbnQoJzAyMDAwJywgOCksXG4gICAgU0VUVUlEOiBwYXJzZUludCgnMDQwMDAnLCA4KSxcblxuICAgIFRZUEVfTUFTSzogcGFyc2VJbnQoJzA3NzAwMDAnLCA4KSxcbiAgfTtcbn0oe1xuICBFWEVDOiAxLFxuICBXUklURTogMixcbiAgUkVBRDogNCxcbn0pKTtcblxuY29tbW9uLnJlZ2lzdGVyKCdjaG1vZCcsIF9jaG1vZCwge1xufSk7XG5cbi8vQFxuLy9AICMjIyBjaG1vZChbb3B0aW9ucyxdIG9jdGFsX21vZGUgfHwgb2N0YWxfc3RyaW5nLCBmaWxlKVxuLy9AICMjIyBjaG1vZChbb3B0aW9ucyxdIHN5bWJvbGljX21vZGUsIGZpbGUpXG4vL0Bcbi8vQCBBdmFpbGFibGUgb3B0aW9uczpcbi8vQFxuLy9AICsgYC12YDogb3V0cHV0IGEgZGlhZ25vc3RpYyBmb3IgZXZlcnkgZmlsZSBwcm9jZXNzZWQvL0Bcbi8vQCArIGAtY2A6IGxpa2UgdmVyYm9zZSBidXQgcmVwb3J0IG9ubHkgd2hlbiBhIGNoYW5nZSBpcyBtYWRlLy9AXG4vL0AgKyBgLVJgOiBjaGFuZ2UgZmlsZXMgYW5kIGRpcmVjdG9yaWVzIHJlY3Vyc2l2ZWx5Ly9AXG4vL0Bcbi8vQCBFeGFtcGxlczpcbi8vQFxuLy9AIGBgYGphdmFzY3JpcHRcbi8vQCBjaG1vZCg3NTUsICcvVXNlcnMvYnJhbmRvbicpO1xuLy9AIGNobW9kKCc3NTUnLCAnL1VzZXJzL2JyYW5kb24nKTsgLy8gc2FtZSBhcyBhYm92ZVxuLy9AIGNobW9kKCd1K3gnLCAnL1VzZXJzL2JyYW5kb24nKTtcbi8vQCBjaG1vZCgnLVInLCAnYS13JywgJy9Vc2Vycy9icmFuZG9uJyk7XG4vL0AgYGBgXG4vL0Bcbi8vQCBBbHRlcnMgdGhlIHBlcm1pc3Npb25zIG9mIGEgZmlsZSBvciBkaXJlY3RvcnkgYnkgZWl0aGVyIHNwZWNpZnlpbmcgdGhlXG4vL0AgYWJzb2x1dGUgcGVybWlzc2lvbnMgaW4gb2N0YWwgZm9ybSBvciBleHByZXNzaW5nIHRoZSBjaGFuZ2VzIGluIHN5bWJvbHMuXG4vL0AgVGhpcyBjb21tYW5kIHRyaWVzIHRvIG1pbWljIHRoZSBQT1NJWCBiZWhhdmlvciBhcyBtdWNoIGFzIHBvc3NpYmxlLlxuLy9AIE5vdGFibGUgZXhjZXB0aW9uczpcbi8vQFxuLy9AICsgSW4gc3ltYm9saWMgbW9kZXMsICdhLXInIGFuZCAnLXInIGFyZSBpZGVudGljYWwuICBObyBjb25zaWRlcmF0aW9uIGlzXG4vL0AgICBnaXZlbiB0byB0aGUgdW1hc2suXG4vL0AgKyBUaGVyZSBpcyBubyBcInF1aWV0XCIgb3B0aW9uIHNpbmNlIGRlZmF1bHQgYmVoYXZpb3IgaXMgdG8gcnVuIHNpbGVudC5cbmZ1bmN0aW9uIF9jaG1vZChvcHRpb25zLCBtb2RlLCBmaWxlUGF0dGVybikge1xuICBpZiAoIWZpbGVQYXR0ZXJuKSB7XG4gICAgaWYgKG9wdGlvbnMubGVuZ3RoID4gMCAmJiBvcHRpb25zLmNoYXJBdCgwKSA9PT0gJy0nKSB7XG4gICAgICAvLyBTcGVjaWFsIGNhc2Ugd2hlcmUgdGhlIHNwZWNpZmllZCBmaWxlIHBlcm1pc3Npb25zIHN0YXJ0ZWQgd2l0aCAtIHRvIHN1YnRyYWN0IHBlcm1zLCB3aGljaFxuICAgICAgLy8gZ2V0IHBpY2tlZCB1cCBieSB0aGUgb3B0aW9uIHBhcnNlciBhcyBjb21tYW5kIGZsYWdzLlxuICAgICAgLy8gSWYgd2UgYXJlIGRvd24gYnkgb25lIGFyZ3VtZW50IGFuZCBvcHRpb25zIHN0YXJ0cyB3aXRoIC0sIHNoaWZ0IGV2ZXJ5dGhpbmcgb3Zlci5cbiAgICAgIFtdLnVuc2hpZnQuY2FsbChhcmd1bWVudHMsICcnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29tbW9uLmVycm9yKCdZb3UgbXVzdCBzcGVjaWZ5IGEgZmlsZS4nKTtcbiAgICB9XG4gIH1cblxuICBvcHRpb25zID0gY29tbW9uLnBhcnNlT3B0aW9ucyhvcHRpb25zLCB7XG4gICAgJ1InOiAncmVjdXJzaXZlJyxcbiAgICAnYyc6ICdjaGFuZ2VzJyxcbiAgICAndic6ICd2ZXJib3NlJyxcbiAgfSk7XG5cbiAgZmlsZVBhdHRlcm4gPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7XG5cbiAgdmFyIGZpbGVzO1xuXG4gIC8vIFRPRE86IHJlcGxhY2UgdGhpcyB3aXRoIGEgY2FsbCB0byBjb21tb24uZXhwYW5kKClcbiAgaWYgKG9wdGlvbnMucmVjdXJzaXZlKSB7XG4gICAgZmlsZXMgPSBbXTtcbiAgICBmaWxlUGF0dGVybi5mb3JFYWNoKGZ1bmN0aW9uIGFkZEZpbGUoZXhwYW5kZWRGaWxlKSB7XG4gICAgICB2YXIgc3RhdCA9IGZzLmxzdGF0U3luYyhleHBhbmRlZEZpbGUpO1xuXG4gICAgICBpZiAoIXN0YXQuaXNTeW1ib2xpY0xpbmsoKSkge1xuICAgICAgICBmaWxlcy5wdXNoKGV4cGFuZGVkRmlsZSk7XG5cbiAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkgeyAgLy8gaW50ZW50aW9uYWxseSBkb2VzIG5vdCBmb2xsb3cgc3ltbGlua3MuXG4gICAgICAgICAgZnMucmVhZGRpclN5bmMoZXhwYW5kZWRGaWxlKS5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkge1xuICAgICAgICAgICAgYWRkRmlsZShleHBhbmRlZEZpbGUgKyAnLycgKyBjaGlsZCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBmaWxlcyA9IGZpbGVQYXR0ZXJuO1xuICB9XG5cbiAgZmlsZXMuZm9yRWFjaChmdW5jdGlvbiBpbm5lckNobW9kKGZpbGUpIHtcbiAgICBmaWxlID0gcGF0aC5yZXNvbHZlKGZpbGUpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlKSkge1xuICAgICAgY29tbW9uLmVycm9yKCdGaWxlIG5vdCBmb3VuZDogJyArIGZpbGUpO1xuICAgIH1cblxuICAgIC8vIFdoZW4gcmVjdXJzaW5nLCBkb24ndCBmb2xsb3cgc3ltbGlua3MuXG4gICAgaWYgKG9wdGlvbnMucmVjdXJzaXZlICYmIGZzLmxzdGF0U3luYyhmaWxlKS5pc1N5bWJvbGljTGluaygpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIHN0YXQgPSBmcy5zdGF0U3luYyhmaWxlKTtcbiAgICB2YXIgaXNEaXIgPSBzdGF0LmlzRGlyZWN0b3J5KCk7XG4gICAgdmFyIHBlcm1zID0gc3RhdC5tb2RlO1xuICAgIHZhciB0eXBlID0gcGVybXMgJiBQRVJNUy5UWVBFX01BU0s7XG5cbiAgICB2YXIgbmV3UGVybXMgPSBwZXJtcztcblxuICAgIGlmIChpc05hTihwYXJzZUludChtb2RlLCA4KSkpIHtcbiAgICAgIC8vIHBhcnNlIG9wdGlvbnNcbiAgICAgIG1vZGUuc3BsaXQoJywnKS5mb3JFYWNoKGZ1bmN0aW9uIChzeW1ib2xpY01vZGUpIHtcbiAgICAgICAgdmFyIHBhdHRlcm4gPSAvKFt1Z29hXSopKFs9XFwrLV0pKFtyd3hYc3RdKikvaTtcbiAgICAgICAgdmFyIG1hdGNoZXMgPSBwYXR0ZXJuLmV4ZWMoc3ltYm9saWNNb2RlKTtcblxuICAgICAgICBpZiAobWF0Y2hlcykge1xuICAgICAgICAgIHZhciBhcHBseVRvID0gbWF0Y2hlc1sxXTtcbiAgICAgICAgICB2YXIgb3BlcmF0b3IgPSBtYXRjaGVzWzJdO1xuICAgICAgICAgIHZhciBjaGFuZ2UgPSBtYXRjaGVzWzNdO1xuXG4gICAgICAgICAgdmFyIGNoYW5nZU93bmVyID0gYXBwbHlUby5pbmRleE9mKCd1JykgIT09IC0xIHx8IGFwcGx5VG8gPT09ICdhJyB8fCBhcHBseVRvID09PSAnJztcbiAgICAgICAgICB2YXIgY2hhbmdlR3JvdXAgPSBhcHBseVRvLmluZGV4T2YoJ2cnKSAhPT0gLTEgfHwgYXBwbHlUbyA9PT0gJ2EnIHx8IGFwcGx5VG8gPT09ICcnO1xuICAgICAgICAgIHZhciBjaGFuZ2VPdGhlciA9IGFwcGx5VG8uaW5kZXhPZignbycpICE9PSAtMSB8fCBhcHBseVRvID09PSAnYScgfHwgYXBwbHlUbyA9PT0gJyc7XG5cbiAgICAgICAgICB2YXIgY2hhbmdlUmVhZCA9IGNoYW5nZS5pbmRleE9mKCdyJykgIT09IC0xO1xuICAgICAgICAgIHZhciBjaGFuZ2VXcml0ZSA9IGNoYW5nZS5pbmRleE9mKCd3JykgIT09IC0xO1xuICAgICAgICAgIHZhciBjaGFuZ2VFeGVjID0gY2hhbmdlLmluZGV4T2YoJ3gnKSAhPT0gLTE7XG4gICAgICAgICAgdmFyIGNoYW5nZUV4ZWNEaXIgPSBjaGFuZ2UuaW5kZXhPZignWCcpICE9PSAtMTtcbiAgICAgICAgICB2YXIgY2hhbmdlU3RpY2t5ID0gY2hhbmdlLmluZGV4T2YoJ3QnKSAhPT0gLTE7XG4gICAgICAgICAgdmFyIGNoYW5nZVNldHVpZCA9IGNoYW5nZS5pbmRleE9mKCdzJykgIT09IC0xO1xuXG4gICAgICAgICAgaWYgKGNoYW5nZUV4ZWNEaXIgJiYgaXNEaXIpIHtcbiAgICAgICAgICAgIGNoYW5nZUV4ZWMgPSB0cnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHZhciBtYXNrID0gMDtcbiAgICAgICAgICBpZiAoY2hhbmdlT3duZXIpIHtcbiAgICAgICAgICAgIG1hc2sgfD0gKGNoYW5nZVJlYWQgPyBQRVJNUy5PV05FUl9SRUFEIDogMCkgKyAoY2hhbmdlV3JpdGUgPyBQRVJNUy5PV05FUl9XUklURSA6IDApICsgKGNoYW5nZUV4ZWMgPyBQRVJNUy5PV05FUl9FWEVDIDogMCkgKyAoY2hhbmdlU2V0dWlkID8gUEVSTVMuU0VUVUlEIDogMCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjaGFuZ2VHcm91cCkge1xuICAgICAgICAgICAgbWFzayB8PSAoY2hhbmdlUmVhZCA/IFBFUk1TLkdST1VQX1JFQUQgOiAwKSArIChjaGFuZ2VXcml0ZSA/IFBFUk1TLkdST1VQX1dSSVRFIDogMCkgKyAoY2hhbmdlRXhlYyA/IFBFUk1TLkdST1VQX0VYRUMgOiAwKSArIChjaGFuZ2VTZXR1aWQgPyBQRVJNUy5TRVRHSUQgOiAwKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGNoYW5nZU90aGVyKSB7XG4gICAgICAgICAgICBtYXNrIHw9IChjaGFuZ2VSZWFkID8gUEVSTVMuT1RIRVJfUkVBRCA6IDApICsgKGNoYW5nZVdyaXRlID8gUEVSTVMuT1RIRVJfV1JJVEUgOiAwKSArIChjaGFuZ2VFeGVjID8gUEVSTVMuT1RIRVJfRVhFQyA6IDApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFN0aWNreSBiaXQgaXMgc3BlY2lhbCAtIGl0J3Mgbm90IHRpZWQgdG8gdXNlciwgZ3JvdXAgb3Igb3RoZXIuXG4gICAgICAgICAgaWYgKGNoYW5nZVN0aWNreSkge1xuICAgICAgICAgICAgbWFzayB8PSBQRVJNUy5TVElDS1k7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgc3dpdGNoIChvcGVyYXRvcikge1xuICAgICAgICAgICAgY2FzZSAnKyc6XG4gICAgICAgICAgICAgIG5ld1Blcm1zIHw9IG1hc2s7XG4gICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICctJzpcbiAgICAgICAgICAgICAgbmV3UGVybXMgJj0gfm1hc2s7XG4gICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICc9JzpcbiAgICAgICAgICAgICAgbmV3UGVybXMgPSB0eXBlICsgbWFzaztcblxuICAgICAgICAgICAgICAvLyBBY2NvcmRpbmcgdG8gUE9TSVgsIHdoZW4gdXNpbmcgPSB0byBleHBsaWNpdGx5IHNldCB0aGVcbiAgICAgICAgICAgICAgLy8gcGVybWlzc2lvbnMsIHNldHVpZCBhbmQgc2V0Z2lkIGNhbiBuZXZlciBiZSBjbGVhcmVkLlxuICAgICAgICAgICAgICBpZiAoZnMuc3RhdFN5bmMoZmlsZSkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgIG5ld1Blcm1zIHw9IChQRVJNUy5TRVRVSUQgKyBQRVJNUy5TRVRHSUQpICYgcGVybXM7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBjb21tb24uZXJyb3IoJ0NvdWxkIG5vdCByZWNvZ25pemUgb3BlcmF0b3I6IGAnICsgb3BlcmF0b3IgKyAnYCcpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChvcHRpb25zLnZlcmJvc2UpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGZpbGUgKyAnIC0+ICcgKyBuZXdQZXJtcy50b1N0cmluZyg4KSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHBlcm1zICE9PSBuZXdQZXJtcykge1xuICAgICAgICAgICAgaWYgKCFvcHRpb25zLnZlcmJvc2UgJiYgb3B0aW9ucy5jaGFuZ2VzKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGZpbGUgKyAnIC0+ICcgKyBuZXdQZXJtcy50b1N0cmluZyg4KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmcy5jaG1vZFN5bmMoZmlsZSwgbmV3UGVybXMpO1xuICAgICAgICAgICAgcGVybXMgPSBuZXdQZXJtczsgLy8gZm9yIHRoZSBuZXh0IHJvdW5kIG9mIGNoYW5nZXMhXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbW1vbi5lcnJvcignSW52YWxpZCBzeW1ib2xpYyBtb2RlIGNoYW5nZTogJyArIHN5bWJvbGljTW9kZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyB0aGV5IGdhdmUgdXMgYSBmdWxsIG51bWJlclxuICAgICAgbmV3UGVybXMgPSB0eXBlICsgcGFyc2VJbnQobW9kZSwgOCk7XG5cbiAgICAgIC8vIFBPU0lYIHJ1bGVzIGFyZSB0aGF0IHNldHVpZCBhbmQgc2V0Z2lkIGNhbiBvbmx5IGJlIGFkZGVkIHVzaW5nIG51bWVyaWNcbiAgICAgIC8vIGZvcm0sIGJ1dCBub3QgY2xlYXJlZC5cbiAgICAgIGlmIChmcy5zdGF0U3luYyhmaWxlKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIG5ld1Blcm1zIHw9IChQRVJNUy5TRVRVSUQgKyBQRVJNUy5TRVRHSUQpICYgcGVybXM7XG4gICAgICB9XG5cbiAgICAgIGZzLmNobW9kU3luYyhmaWxlLCBuZXdQZXJtcyk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuICcnO1xufVxubW9kdWxlLmV4cG9ydHMgPSBfY2htb2Q7XG4iXX0=