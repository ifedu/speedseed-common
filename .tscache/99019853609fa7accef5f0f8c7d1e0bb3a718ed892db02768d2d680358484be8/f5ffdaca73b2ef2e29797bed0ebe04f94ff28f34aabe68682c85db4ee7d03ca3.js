/**
 * `rawlist` type prompt
 */
var _ = require('lodash');
var util = require('util');
var chalk = require('chalk');
var Base = require('./base');
var Separator = require('../objects/separator');
var observe = require('../utils/events');
var Paginator = require('../utils/paginator');
/**
 * Module exports
 */
module.exports = Prompt;
/**
 * Constructor
 */
function Prompt() {
    Base.apply(this, arguments);
    if (!this.opt.choices) {
        this.throwParamError('choices');
    }
    this.validateChoices(this.opt.choices);
    // Add the default `help` (/expand) option
    this.opt.choices.push({
        key: 'h',
        name: 'Help, list all options',
        value: 'help'
    });
    this.opt.validate = function (choice) {
        if (choice == null) {
            return 'Please enter a valid command';
        }
        return choice !== 'help';
    };
    // Setup the default string (capitalize the default key)
    this.opt.default = this.generateChoicesString(this.opt.choices, this.opt.default);
    this.paginator = new Paginator();
}
util.inherits(Prompt, Base);
/**
 * Start the Inquiry session
 * @param  {Function} cb      Callback when prompt is done
 * @return {this}
 */
Prompt.prototype._run = function (cb) {
    this.done = cb;
    // Save user answer and update prompt to show selected option.
    var events = observe(this.rl);
    var validation = this.handleSubmitEvents(events.line.map(this.getCurrentValue.bind(this)));
    validation.success.forEach(this.onSubmit.bind(this));
    validation.error.forEach(this.onError.bind(this));
    this.keypressObs = events.keypress.takeUntil(validation.success)
        .forEach(this.onKeypress.bind(this));
    // Init the prompt
    this.render();
    return this;
};
/**
 * Render the prompt to screen
 * @return {Prompt} self
 */
Prompt.prototype.render = function (error, hint) {
    var message = this.getQuestion();
    var bottomContent = '';
    if (this.status === 'answered') {
        message += chalk.cyan(this.answer);
    }
    else if (this.status === 'expanded') {
        var choicesStr = renderChoices(this.opt.choices, this.selectedKey);
        message += this.paginator.paginate(choicesStr, this.selectedKey, this.opt.pageSize);
        message += '\n  Answer: ';
    }
    message += this.rl.line;
    if (error) {
        bottomContent = chalk.red('>> ') + error;
    }
    if (hint) {
        bottomContent = chalk.cyan('>> ') + hint;
    }
    this.screen.render(message, bottomContent);
};
Prompt.prototype.getCurrentValue = function (input) {
    if (!input) {
        input = this.rawDefault;
    }
    var selected = this.opt.choices.where({ key: input.toLowerCase().trim() })[0];
    if (!selected) {
        return null;
    }
    return selected.value;
};
/**
 * Generate the prompt choices string
 * @return {String}  Choices string
 */
Prompt.prototype.getChoices = function () {
    var output = '';
    this.opt.choices.forEach(function (choice) {
        output += '\n  ';
        if (choice.type === 'separator') {
            output += ' ' + choice;
            return;
        }
        var choiceStr = choice.key + ') ' + choice.name;
        if (this.selectedKey === choice.key) {
            choiceStr = chalk.cyan(choiceStr);
        }
        output += choiceStr;
    }.bind(this));
    return output;
};
Prompt.prototype.onError = function (state) {
    if (state.value === 'help') {
        this.selectedKey = '';
        this.status = 'expanded';
        this.render();
        return;
    }
    this.render(state.isValid);
};
/**
 * When user press `enter` key
 */
Prompt.prototype.onSubmit = function (state) {
    this.status = 'answered';
    var choice = this.opt.choices.where({ value: state.value })[0];
    this.answer = choice.short || choice.name;
    // Re-render prompt
    this.render();
    this.screen.done();
    this.done(state.value);
};
/**
 * When user press a key
 */
Prompt.prototype.onKeypress = function () {
    this.selectedKey = this.rl.line.toLowerCase();
    var selected = this.opt.choices.where({ key: this.selectedKey })[0];
    if (this.status === 'expanded') {
        this.render();
    }
    else {
        this.render(null, selected ? selected.name : null);
    }
};
/**
 * Validate the choices
 * @param {Array} choices
 */
Prompt.prototype.validateChoices = function (choices) {
    var formatError;
    var errors = [];
    var keymap = {};
    choices.filter(Separator.exclude).forEach(function (choice) {
        if (!choice.key || choice.key.length !== 1) {
            formatError = true;
        }
        if (keymap[choice.key]) {
            errors.push(choice.key);
        }
        keymap[choice.key] = true;
        choice.key = String(choice.key).toLowerCase();
    });
    if (formatError) {
        throw new Error('Format error: `key` param must be a single letter and is required.');
    }
    if (keymap.h) {
        throw new Error('Reserved key error: `key` param cannot be `h` - this value is reserved.');
    }
    if (errors.length) {
        throw new Error('Duplicate key error: `key` param must be unique. Duplicates: ' +
            _.uniq(errors).join(', '));
    }
};
/**
 * Generate a string out of the choices keys
 * @param  {Array}  choices
 * @param  {Number} defaultIndex - the choice index to capitalize
 * @return {String} The rendered choices key string
 */
Prompt.prototype.generateChoicesString = function (choices, defaultIndex) {
    var defIndex = 0;
    if (_.isNumber(defaultIndex) && this.opt.choices.getChoice(defaultIndex)) {
        defIndex = defaultIndex;
    }
    var defStr = this.opt.choices.pluck('key');
    this.rawDefault = defStr[defIndex];
    defStr[defIndex] = String(defStr[defIndex]).toUpperCase();
    return defStr.join('');
};
/**
 * Function for rendering checkbox choices
 * @param  {String} pointer Selected key
 * @return {String}         Rendered content
 */
function renderChoices(choices, pointer) {
    var output = '';
    choices.forEach(function (choice) {
        output += '\n  ';
        if (choice.type === 'separator') {
            output += ' ' + choice;
            return;
        }
        var choiceStr = choice.key + ') ' + choice.name;
        if (pointer === choice.key) {
            choiceStr = chalk.cyan(choiceStr);
        }
        output += choiceStr;
    });
    return output;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFxwcm9tcHRzXFxleHBhbmQuanMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcaWZlZHVcXEFwcERhdGFcXFJvYW1pbmdcXG52bVxcdjguNC4wXFxub2RlX21vZHVsZXNcXGdlbmVyYXRvci1zcGVlZHNlZWRcXG5vZGVfbW9kdWxlc1xcaW5xdWlyZXJcXGxpYlxccHJvbXB0c1xcZXhwYW5kLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBRUgsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDN0IsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2hELElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3pDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRTlDOztHQUVHO0FBRUgsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFFeEI7O0dBRUc7QUFFSDtJQUNFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRTVCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELElB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Q2hELEVBQUUsQ0FBQyxDQUFDLE9BQU8sS0FBSyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMzQixTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwQyxDQUFDO1FBQ0QsTUFBTSxJQUFJLFNBQVMsQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogYHJhd2xpc3RgIHR5cGUgcHJvbXB0XG4gKi9cblxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xudmFyIGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKTtcbnZhciBCYXNlID0gcmVxdWlyZSgnLi9iYXNlJyk7XG52YXIgU2VwYXJhdG9yID0gcmVxdWlyZSgnLi4vb2JqZWN0cy9zZXBhcmF0b3InKTtcbnZhciBvYnNlcnZlID0gcmVxdWlyZSgnLi4vdXRpbHMvZXZlbnRzJyk7XG52YXIgUGFnaW5hdG9yID0gcmVxdWlyZSgnLi4vdXRpbHMvcGFnaW5hdG9yJyk7XG5cbi8qKlxuICogTW9kdWxlIGV4cG9ydHNcbiAqL1xuXG5tb2R1bGUuZXhwb3J0cyA9IFByb21wdDtcblxuLyoqXG4gKiBDb25zdHJ1Y3RvclxuICovXG5cbmZ1bmN0aW9uIFByb21wdCgpIHtcbiAgQmFzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuXG4gIGlmICghdGhpcy5vcHQuY2hvaWNlcykge1xuICAgIHRoaXMudGhyb3dQYXJhbUVycm9yKCdjaG9pY2VzJyk7XG4gIH1cblxuICB0aGlzLnZhbGlkYXRlQ2hvaWNlcyh0aGlzLm9wdC5jaG9pY2VzKTtcblxuICAvLyBBZGQgdGhlIGRlZmF1bHQgYGhlbHBgICgvZXhwYW5kKSBvcHRpb25cbiAgdGhpcy5vcHQuY2hvaWNlcy5wdXNoKHtcbiAgICBrZXk6ICdoJyxcbiAgICBuYW1lOiAnSGVscCwgbGlzdCBhbGwgb3B0aW9ucycsXG4gICAgdmFsdWU6ICdoZWxwJ1xuICB9KTtcblxuICB0aGlzLm9wdC52YWxpZGF0ZSA9IGZ1bmN0aW9uIChjaG9pY2UpIHtcbiAgICBpZiAoY2hvaWNlID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnUGxlYXNlIGVudGVyIGEgdmFsaWQgY29tbWFuZCc7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNob2ljZSAhPT0gJ2hlbHAnO1xuICB9O1xuXG4gIC8vIFNldHVwIHRoZSBkZWZhdWx0IHN0cmluZyAoY2FwaXRhbGl6ZSB0aGUgZGVmYXVsdCBrZXkpXG4gIHRoaXMub3B0LmRlZmF1bHQgPSB0aGlzLmdlbmVyYXRlQ2hvaWNlc1N0cmluZyh0aGlzLm9wdC5jaG9pY2VzLCB0aGlzLm9wdC5kZWZhdWx0KTtcblxuICB0aGlzLnBhZ2luYXRvciA9IG5ldyBQYWdpbmF0b3IoKTtcbn1cbnV0aWwuaW5oZXJpdHMoUHJvbXB0LCBCYXNlKTtcblxuLyoqXG4gKiBTdGFydCB0aGUgSW5xdWlyeSBzZXNzaW9uXG4gKiBAcGFyYW0gIHtGdW5jdGlvbn0gY2IgICAgICBDYWxsYmFjayB3aGVuIHByb21wdCBpcyBkb25lXG4gKiBAcmV0dXJuIHt0aGlzfVxuICovXG5cblByb21wdC5wcm90b3R5cGUuX3J1biA9IGZ1bmN0aW9uIChjYikge1xuICB0aGlzLmRvbmUgPSBjYjtcblxuICAvLyBTYXZlIHVzZXIgYW5zd2VyIGFuZCB1cGRhdGUgcHJvbXB0IHRvIHNob3cgc2VsZWN0ZWQgb3B0aW9uLlxuICB2YXIgZXZlbnRzID0gb2JzZXJ2ZSh0aGlzLnJsKTtcbiAgdmFyIHZhbGlkYXRpb24gPSB0aGlzLmhhbmRsZVN1Ym1pdEV2ZW50cyhcbiAgICBldmVudHMubGluZS5tYXAodGhpcy5nZXRDdXJyZW50VmFsdWUuYmluZCh0aGlzKSlcbiAgKTtcbiAgdmFsaWRhdGlvbi5zdWNjZXNzLmZvckVhY2godGhpcy5vblN1Ym1pdC5iaW5kKHRoaXMpKTtcbiAgdmFsaWRhdGlvbi5lcnJvci5mb3JFYWNoKHRoaXMub25FcnJvci5iaW5kKHRoaXMpKTtcbiAgdGhpcy5rZXlwcmVzc09icyA9IGV2ZW50cy5rZXlwcmVzcy50YWtlVW50aWwodmFsaWRhdGlvbi5zdWNjZXNzKVxuICAgIC5mb3JFYWNoKHRoaXMub25LZXlwcmVzcy5iaW5kKHRoaXMpKTtcblxuICAvLyBJbml0IHRoZSBwcm9tcHRcbiAgdGhpcy5yZW5kZXIoKTtcblxuICByZXR1cm4gdGhpcztcbn07XG5cbi8qKlxuICogUmVuZGVyIHRoZSBwcm9tcHQgdG8gc2NyZWVuXG4gKiBAcmV0dXJuIHtQcm9tcHR9IHNlbGZcbiAqL1xuXG5Qcm9tcHQucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uIChlcnJvciwgaGludCkge1xuICB2YXIgbWVzc2FnZSA9IHRoaXMuZ2V0UXVlc3Rpb24oKTtcbiAgdmFyIGJvdHRvbUNvbnRlbnQgPSAnJztcblxuICBpZiAodGhpcy5zdGF0dXMgPT09ICdhbnN3ZXJlZCcpIHtcbiAgICBtZXNzYWdlICs9IGNoYWxrLmN5YW4odGhpcy5hbnN3ZXIpO1xuICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSAnZXhwYW5kZWQnKSB7XG4gICAgdmFyIGNob2ljZXNTdHIgPSByZW5kZXJDaG9pY2VzKHRoaXMub3B0LmNob2ljZXMsIHRoaXMuc2VsZWN0ZWRLZXkpO1xuICAgIG1lc3NhZ2UgKz0gdGhpcy5wYWdpbmF0b3IucGFnaW5hdGUoY2hvaWNlc1N0ciwgdGhpcy5zZWxlY3RlZEtleSwgdGhpcy5vcHQucGFnZVNpemUpO1xuICAgIG1lc3NhZ2UgKz0gJ1xcbiAgQW5zd2VyOiAnO1xuICB9XG5cbiAgbWVzc2FnZSArPSB0aGlzLnJsLmxpbmU7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgYm90dG9tQ29udGVudCA9IGNoYWxrLnJlZCgnPj4gJykgKyBlcnJvcjtcbiAgfVxuXG4gIGlmIChoaW50KSB7XG4gICAgYm90dG9tQ29udGVudCA9IGNoYWxrLmN5YW4oJz4+ICcpICsgaGludDtcbiAgfVxuXG4gIHRoaXMuc2NyZWVuLnJlbmRlcihtZXNzYWdlLCBib3R0b21Db250ZW50KTtcbn07XG5cblByb21wdC5wcm90b3R5cGUuZ2V0Q3VycmVudFZhbHVlID0gZnVuY3Rpb24gKGlucHV0KSB7XG4gIGlmICghaW5wdXQpIHtcbiAgICBpbnB1dCA9IHRoaXMucmF3RGVmYXVsdDtcbiAgfVxuICB2YXIgc2VsZWN0ZWQgPSB0aGlzLm9wdC5jaG9pY2VzLndoZXJlKHtrZXk6IGlucHV0LnRvTG93ZXJDYXNlKCkudHJpbSgpfSlbMF07XG4gIGlmICghc2VsZWN0ZWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBzZWxlY3RlZC52YWx1ZTtcbn07XG5cbi8qKlxuICogR2VuZXJhdGUgdGhlIHByb21wdCBjaG9pY2VzIHN0cmluZ1xuICogQHJldHVybiB7U3RyaW5nfSAgQ2hvaWNlcyBzdHJpbmdcbiAqL1xuXG5Qcm9tcHQucHJvdG90eXBlLmdldENob2ljZXMgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBvdXRwdXQgPSAnJztcblxuICB0aGlzLm9wdC5jaG9pY2VzLmZvckVhY2goZnVuY3Rpb24gKGNob2ljZSkge1xuICAgIG91dHB1dCArPSAnXFxuICAnO1xuXG4gICAgaWYgKGNob2ljZS50eXBlID09PSAnc2VwYXJhdG9yJykge1xuICAgICAgb3V0cHV0ICs9ICcgJyArIGNob2ljZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgY2hvaWNlU3RyID0gY2hvaWNlLmtleSArICcpICcgKyBjaG9pY2UubmFtZTtcbiAgICBpZiAodGhpcy5zZWxlY3RlZEtleSA9PT0gY2hvaWNlLmtleSkge1xuICAgICAgY2hvaWNlU3RyID0gY2hhbGsuY3lhbihjaG9pY2VTdHIpO1xuICAgIH1cbiAgICBvdXRwdXQgKz0gY2hvaWNlU3RyO1xuICB9LmJpbmQodGhpcykpO1xuXG4gIHJldHVybiBvdXRwdXQ7XG59O1xuXG5Qcm9tcHQucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgaWYgKHN0YXRlLnZhbHVlID09PSAnaGVscCcpIHtcbiAgICB0aGlzLnNlbGVjdGVkS2V5ID0gJyc7XG4gICAgdGhpcy5zdGF0dXMgPSAnZXhwYW5kZWQnO1xuICAgIHRoaXMucmVuZGVyKCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIHRoaXMucmVuZGVyKHN0YXRlLmlzVmFsaWQpO1xufTtcblxuLyoqXG4gKiBXaGVuIHVzZXIgcHJlc3MgYGVudGVyYCBrZXlcbiAqL1xuXG5Qcm9tcHQucHJvdG90eXBlLm9uU3VibWl0ID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gIHRoaXMuc3RhdHVzID0gJ2Fuc3dlcmVkJztcbiAgdmFyIGNob2ljZSA9IHRoaXMub3B0LmNob2ljZXMud2hlcmUoe3ZhbHVlOiBzdGF0ZS52YWx1ZX0pWzBdO1xuICB0aGlzLmFuc3dlciA9IGNob2ljZS5zaG9ydCB8fCBjaG9pY2UubmFtZTtcblxuICAvLyBSZS1yZW5kZXIgcHJvbXB0XG4gIHRoaXMucmVuZGVyKCk7XG4gIHRoaXMuc2NyZWVuLmRvbmUoKTtcbiAgdGhpcy5kb25lKHN0YXRlLnZhbHVlKTtcbn07XG5cbi8qKlxuICogV2hlbiB1c2VyIHByZXNzIGEga2V5XG4gKi9cblxuUHJvbXB0LnByb3RvdHlwZS5vbktleXByZXNzID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLnNlbGVjdGVkS2V5ID0gdGhpcy5ybC5saW5lLnRvTG93ZXJDYXNlKCk7XG4gIHZhciBzZWxlY3RlZCA9IHRoaXMub3B0LmNob2ljZXMud2hlcmUoe2tleTogdGhpcy5zZWxlY3RlZEtleX0pWzBdO1xuICBpZiAodGhpcy5zdGF0dXMgPT09ICdleHBhbmRlZCcpIHtcbiAgICB0aGlzLnJlbmRlcigpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMucmVuZGVyKG51bGwsIHNlbGVjdGVkID8gc2VsZWN0ZWQubmFtZSA6IG51bGwpO1xuICB9XG59O1xuXG4vKipcbiAqIFZhbGlkYXRlIHRoZSBjaG9pY2VzXG4gKiBAcGFyYW0ge0FycmF5fSBjaG9pY2VzXG4gKi9cblxuUHJvbXB0LnByb3RvdHlwZS52YWxpZGF0ZUNob2ljZXMgPSBmdW5jdGlvbiAoY2hvaWNlcykge1xuICB2YXIgZm9ybWF0RXJyb3I7XG4gIHZhciBlcnJvcnMgPSBbXTtcbiAgdmFyIGtleW1hcCA9IHt9O1xuICBjaG9pY2VzLmZpbHRlcihTZXBhcmF0b3IuZXhjbHVkZSkuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlKSB7XG4gICAgaWYgKCFjaG9pY2Uua2V5IHx8IGNob2ljZS5rZXkubGVuZ3RoICE9PSAxKSB7XG4gICAgICBmb3JtYXRFcnJvciA9IHRydWU7XG4gICAgfVxuICAgIGlmIChrZXltYXBbY2hvaWNlLmtleV0pIHtcbiAgICAgIGVycm9ycy5wdXNoKGNob2ljZS5rZXkpO1xuICAgIH1cbiAgICBrZXltYXBbY2hvaWNlLmtleV0gPSB0cnVlO1xuICAgIGNob2ljZS5rZXkgPSBTdHJpbmcoY2hvaWNlLmtleSkudG9Mb3dlckNhc2UoKTtcbiAgfSk7XG5cbiAgaWYgKGZvcm1hdEVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGb3JtYXQgZXJyb3I6IGBrZXlgIHBhcmFtIG11c3QgYmUgYSBzaW5nbGUgbGV0dGVyIGFuZCBpcyByZXF1aXJlZC4nKTtcbiAgfVxuICBpZiAoa2V5bWFwLmgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Jlc2VydmVkIGtleSBlcnJvcjogYGtleWAgcGFyYW0gY2Fubm90IGJlIGBoYCAtIHRoaXMgdmFsdWUgaXMgcmVzZXJ2ZWQuJyk7XG4gIH1cbiAgaWYgKGVycm9ycy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBrZXkgZXJyb3I6IGBrZXlgIHBhcmFtIG11c3QgYmUgdW5pcXVlLiBEdXBsaWNhdGVzOiAnICtcbiAgICAgICAgXy51bmlxKGVycm9ycykuam9pbignLCAnKSk7XG4gIH1cbn07XG5cbi8qKlxuICogR2VuZXJhdGUgYSBzdHJpbmcgb3V0IG9mIHRoZSBjaG9pY2VzIGtleXNcbiAqIEBwYXJhbSAge0FycmF5fSAgY2hvaWNlc1xuICogQHBhcmFtICB7TnVtYmVyfSBkZWZhdWx0SW5kZXggLSB0aGUgY2hvaWNlIGluZGV4IHRvIGNhcGl0YWxpemVcbiAqIEByZXR1cm4ge1N0cmluZ30gVGhlIHJlbmRlcmVkIGNob2ljZXMga2V5IHN0cmluZ1xuICovXG5Qcm9tcHQucHJvdG90eXBlLmdlbmVyYXRlQ2hvaWNlc1N0cmluZyA9IGZ1bmN0aW9uIChjaG9pY2VzLCBkZWZhdWx0SW5kZXgpIHtcbiAgdmFyIGRlZkluZGV4ID0gMDtcbiAgaWYgKF8uaXNOdW1iZXIoZGVmYXVsdEluZGV4KSAmJiB0aGlzLm9wdC5jaG9pY2VzLmdldENob2ljZShkZWZhdWx0SW5kZXgpKSB7XG4gICAgZGVmSW5kZXggPSBkZWZhdWx0SW5kZXg7XG4gIH1cbiAgdmFyIGRlZlN0ciA9IHRoaXMub3B0LmNob2ljZXMucGx1Y2soJ2tleScpO1xuICB0aGlzLnJhd0RlZmF1bHQgPSBkZWZTdHJbZGVmSW5kZXhdO1xuICBkZWZTdHJbZGVmSW5kZXhdID0gU3RyaW5nKGRlZlN0cltkZWZJbmRleF0pLnRvVXBwZXJDYXNlKCk7XG4gIHJldHVybiBkZWZTdHIuam9pbignJyk7XG59O1xuXG4vKipcbiAqIEZ1bmN0aW9uIGZvciByZW5kZXJpbmcgY2hlY2tib3ggY2hvaWNlc1xuICogQHBhcmFtICB7U3RyaW5nfSBwb2ludGVyIFNlbGVjdGVkIGtleVxuICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgIFJlbmRlcmVkIGNvbnRlbnRcbiAqL1xuXG5mdW5jdGlvbiByZW5kZXJDaG9pY2VzKGNob2ljZXMsIHBvaW50ZXIpIHtcbiAgdmFyIG91dHB1dCA9ICcnO1xuXG4gIGNob2ljZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlKSB7XG4gICAgb3V0cHV0ICs9ICdcXG4gICc7XG5cbiAgICBpZiAoY2hvaWNlLnR5cGUgPT09ICdzZXBhcmF0b3InKSB7XG4gICAgICBvdXRwdXQgKz0gJyAnICsgY2hvaWNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBjaG9pY2VTdHIgPSBjaG9pY2Uua2V5ICsgJykgJyArIGNob2ljZS5uYW1lO1xuICAgIGlmIChwb2ludGVyID09PSBjaG9pY2Uua2V5KSB7XG4gICAgICBjaG9pY2VTdHIgPSBjaGFsay5jeWFuKGNob2ljZVN0cik7XG4gICAgfVxuICAgIG91dHB1dCArPSBjaG9pY2VTdHI7XG4gIH0pO1xuXG4gIHJldHVybiBvdXRwdXQ7XG59XG4iXX0=