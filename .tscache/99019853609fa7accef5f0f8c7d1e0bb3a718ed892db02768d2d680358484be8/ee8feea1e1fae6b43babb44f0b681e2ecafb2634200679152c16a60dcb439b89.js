/**
 * `rawlist` type prompt
 */
var _ = require('lodash');
var util = require('util');
var chalk = require('chalk');
var Base = require('./base');
var Separator = require('../objects/separator');
var observe = require('../utils/events');
var Paginator = require('../utils/paginator');
/**
 * Module exports
 */
module.exports = Prompt;
/**
 * Constructor
 */
function Prompt() {
    Base.apply(this, arguments);
    if (!this.opt.choices) {
        this.throwParamError('choices');
    }
    this.opt.validChoices = this.opt.choices.filter(Separator.exclude);
    this.selected = 0;
    this.rawDefault = 0;
    _.extend(this.opt, {
        validate: function (val) {
            return val != null;
        }
    });
    var def = this.opt.default;
    if (_.isNumber(def) && def >= 0 && def < this.opt.choices.realLength) {
        this.selected = this.rawDefault = def;
    }
    // Make sure no default is set (so it won't be printed)
    this.opt.default = null;
    this.paginator = new Paginator();
}
util.inherits(Prompt, Base);
/**
 * Start the Inquiry session
 * @param  {Function} cb      Callback when prompt is done
 * @return {this}
 */
Prompt.prototype._run = function (cb) {
    this.done = cb;
    // Once user confirm (enter key)
    var events = observe(this.rl);
    var submit = events.line.map(this.getCurrentValue.bind(this));
    var validation = this.handleSubmitEvents(submit);
    validation.success.forEach(this.onEnd.bind(this));
    validation.error.forEach(this.onError.bind(this));
    events.keypress.takeUntil(validation.success).forEach(this.onKeypress.bind(this));
    // Init the prompt
    this.render();
    return this;
};
/**
 * Render the prompt to screen
 * @return {Prompt} self
 */
Prompt.prototype.render = function (error) {
    // Render question
    var message = this.getQuestion();
    var bottomContent = '';
    if (this.status === 'answered') {
        message += chalk.cyan(this.answer);
    }
    else {
        var choicesStr = renderChoices(this.opt.choices, this.selected);
        message += this.paginator.paginate(choicesStr, this.selected, this.opt.pageSize);
        message += '\n  Answer: ';
    }
    message += this.rl.line;
    if (error) {
        bottomContent = '\n' + chalk.red('>> ') + error;
    }
    this.screen.render(message, bottomContent);
};
/**
 * When user press `enter` key
 */
Prompt.prototype.getCurrentValue = function (index) {
    if (index == null || index === '') {
        index = this.rawDefault;
    }
    else {
        index -= 1;
    }
    var choice = this.opt.choices.getChoice(index);
    return choice ? choice.value : null;
};
Prompt.prototype.onEnd = function (state) {
    this.status = 'answered';
    this.answer = state.value;
    // Re-render prompt
    this.render();
    this.screen.done();
    this.done(state.value);
};
Prompt.prototype.onError = function () {
    this.render('Please enter a valid index');
};
/**
 * When user press a key
 */
Prompt.prototype.onKeypress = function () {
    var index = this.rl.line.length ? Number(this.rl.line) - 1 : 0;
    if (this.opt.choices.getChoice(index)) {
        this.selected = index;
    }
    else {
        this.selected = undefined;
    }
    this.render();
};
/**
 * Function for rendering list choices
 * @param  {Number} pointer Position of the pointer
 * @return {String}         Rendered content
 */
function renderChoices(choices, pointer) {
    var output = '';
    var separatorOffset = 0;
    choices.forEach(function (choice, i) {
        output += '\n  ';
        if (choice.type === 'separator') {
            separatorOffset++;
            output += ' ' + choice;
            return;
        }
        var index = i - separatorOffset;
        var display = (index + 1) + ') ' + choice.name;
        if (index === pointer) {
            display = chalk.cyan(display);
        }
        output += display;
    });
    return output;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxpZmVkdVxcQXBwRGF0YVxcUm9hbWluZ1xcbnZtXFx2OC40LjBcXG5vZGVfbW9kdWxlc1xcZ2VuZXJhdG9yLXNwZWVkc2VlZFxcbm9kZV9tb2R1bGVzXFxpbnF1aXJlclxcbGliXFxwcm9tcHRzXFxyYXdsaXN0LmpzIiwic291cmNlcyI6WyJDOlxcVXNlcnNcXGlmZWR1XFxBcHBEYXRhXFxSb2FtaW5nXFxudm1cXHY4LjQuMFxcbm9kZV9tb2R1bGVzXFxnZW5lcmF0b3Itc3BlZWRzZWVkXFxub2RlX21vZHVsZXNcXGlucXVpcmVyXFxsaWJcXHByb21wdHNcXHJhd2xpc3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFFSCxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM3QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDaEQsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDekMsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFOUM7O0dBRUc7QUFFSCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztBQUV4Qjs7R0FFRztBQUVIO0lBQ0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFFNUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQs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ZUFBZSxFQUFFLENBQUM7WUFDbEIsTUFBTSxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUM7WUFDdkIsTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUVELElBQUksS0FBSyxHQUFHLENBQUMsR0FBRyxlQUFlLENBQUM7UUFDaEMsSUFBSSxPQUFPLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDL0MsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDdEIsT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDaEMsQ0FBQztRQUNELE1BQU0sSUFBSSxPQUFPLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIGByYXdsaXN0YCB0eXBlIHByb21wdFxuICovXG5cbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbnZhciBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7XG52YXIgQmFzZSA9IHJlcXVpcmUoJy4vYmFzZScpO1xudmFyIFNlcGFyYXRvciA9IHJlcXVpcmUoJy4uL29iamVjdHMvc2VwYXJhdG9yJyk7XG52YXIgb2JzZXJ2ZSA9IHJlcXVpcmUoJy4uL3V0aWxzL2V2ZW50cycpO1xudmFyIFBhZ2luYXRvciA9IHJlcXVpcmUoJy4uL3V0aWxzL3BhZ2luYXRvcicpO1xuXG4vKipcbiAqIE1vZHVsZSBleHBvcnRzXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSBQcm9tcHQ7XG5cbi8qKlxuICogQ29uc3RydWN0b3JcbiAqL1xuXG5mdW5jdGlvbiBQcm9tcHQoKSB7XG4gIEJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcblxuICBpZiAoIXRoaXMub3B0LmNob2ljZXMpIHtcbiAgICB0aGlzLnRocm93UGFyYW1FcnJvcignY2hvaWNlcycpO1xuICB9XG5cbiAgdGhpcy5vcHQudmFsaWRDaG9pY2VzID0gdGhpcy5vcHQuY2hvaWNlcy5maWx0ZXIoU2VwYXJhdG9yLmV4Y2x1ZGUpO1xuXG4gIHRoaXMuc2VsZWN0ZWQgPSAwO1xuICB0aGlzLnJhd0RlZmF1bHQgPSAwO1xuXG4gIF8uZXh0ZW5kKHRoaXMub3B0LCB7XG4gICAgdmFsaWRhdGU6IGZ1bmN0aW9uICh2YWwpIHtcbiAgICAgIHJldHVybiB2YWwgIT0gbnVsbDtcbiAgICB9XG4gIH0pO1xuXG4gIHZhciBkZWYgPSB0aGlzLm9wdC5kZWZhdWx0O1xuICBpZiAoXy5pc051bWJlcihkZWYpICYmIGRlZiA+PSAwICYmIGRlZiA8IHRoaXMub3B0LmNob2ljZXMucmVhbExlbmd0aCkge1xuICAgIHRoaXMuc2VsZWN0ZWQgPSB0aGlzLnJhd0RlZmF1bHQgPSBkZWY7XG4gIH1cblxuICAvLyBNYWtlIHN1cmUgbm8gZGVmYXVsdCBpcyBzZXQgKHNvIGl0IHdvbid0IGJlIHByaW50ZWQpXG4gIHRoaXMub3B0LmRlZmF1bHQgPSBudWxsO1xuXG4gIHRoaXMucGFnaW5hdG9yID0gbmV3IFBhZ2luYXRvcigpO1xufVxudXRpbC5pbmhlcml0cyhQcm9tcHQsIEJhc2UpO1xuXG4vKipcbiAqIFN0YXJ0IHRoZSBJbnF1aXJ5IHNlc3Npb25cbiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBjYiAgICAgIENhbGxiYWNrIHdoZW4gcHJvbXB0IGlzIGRvbmVcbiAqIEByZXR1cm4ge3RoaXN9XG4gKi9cblxuUHJvbXB0LnByb3RvdHlwZS5fcnVuID0gZnVuY3Rpb24gKGNiKSB7XG4gIHRoaXMuZG9uZSA9IGNiO1xuXG4gIC8vIE9uY2UgdXNlciBjb25maXJtIChlbnRlciBrZXkpXG4gIHZhciBldmVudHMgPSBvYnNlcnZlKHRoaXMucmwpO1xuICB2YXIgc3VibWl0ID0gZXZlbnRzLmxpbmUubWFwKHRoaXMuZ2V0Q3VycmVudFZhbHVlLmJpbmQodGhpcykpO1xuXG4gIHZhciB2YWxpZGF0aW9uID0gdGhpcy5oYW5kbGVTdWJtaXRFdmVudHMoc3VibWl0KTtcbiAgdmFsaWRhdGlvbi5zdWNjZXNzLmZvckVhY2godGhpcy5vbkVuZC5iaW5kKHRoaXMpKTtcbiAgdmFsaWRhdGlvbi5lcnJvci5mb3JFYWNoKHRoaXMub25FcnJvci5iaW5kKHRoaXMpKTtcblxuICBldmVudHMua2V5cHJlc3MudGFrZVVudGlsKHZhbGlkYXRpb24uc3VjY2VzcykuZm9yRWFjaCh0aGlzLm9uS2V5cHJlc3MuYmluZCh0aGlzKSk7XG5cbiAgLy8gSW5pdCB0aGUgcHJvbXB0XG4gIHRoaXMucmVuZGVyKCk7XG5cbiAgcmV0dXJuIHRoaXM7XG59O1xuXG4vKipcbiAqIFJlbmRlciB0aGUgcHJvbXB0IHRvIHNjcmVlblxuICogQHJldHVybiB7UHJvbXB0fSBzZWxmXG4gKi9cblxuUHJvbXB0LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgLy8gUmVuZGVyIHF1ZXN0aW9uXG4gIHZhciBtZXNzYWdlID0gdGhpcy5nZXRRdWVzdGlvbigpO1xuICB2YXIgYm90dG9tQ29udGVudCA9ICcnO1xuXG4gIGlmICh0aGlzLnN0YXR1cyA9PT0gJ2Fuc3dlcmVkJykge1xuICAgIG1lc3NhZ2UgKz0gY2hhbGsuY3lhbih0aGlzLmFuc3dlcik7XG4gIH0gZWxzZSB7XG4gICAgdmFyIGNob2ljZXNTdHIgPSByZW5kZXJDaG9pY2VzKHRoaXMub3B0LmNob2ljZXMsIHRoaXMuc2VsZWN0ZWQpO1xuICAgIG1lc3NhZ2UgKz0gdGhpcy5wYWdpbmF0b3IucGFnaW5hdGUoY2hvaWNlc1N0ciwgdGhpcy5zZWxlY3RlZCwgdGhpcy5vcHQucGFnZVNpemUpO1xuICAgIG1lc3NhZ2UgKz0gJ1xcbiAgQW5zd2VyOiAnO1xuICB9XG5cbiAgbWVzc2FnZSArPSB0aGlzLnJsLmxpbmU7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgYm90dG9tQ29udGVudCA9ICdcXG4nICsgY2hhbGsucmVkKCc+PiAnKSArIGVycm9yO1xuICB9XG5cbiAgdGhpcy5zY3JlZW4ucmVuZGVyKG1lc3NhZ2UsIGJvdHRvbUNvbnRlbnQpO1xufTtcblxuLyoqXG4gKiBXaGVuIHVzZXIgcHJlc3MgYGVudGVyYCBrZXlcbiAqL1xuXG5Qcm9tcHQucHJvdG90eXBlLmdldEN1cnJlbnRWYWx1ZSA9IGZ1bmN0aW9uIChpbmRleCkge1xuICBpZiAoaW5kZXggPT0gbnVsbCB8fCBpbmRleCA9PT0gJycpIHtcbiAgICBpbmRleCA9IHRoaXMucmF3RGVmYXVsdDtcbiAgfSBlbHNlIHtcbiAgICBpbmRleCAtPSAxO1xuICB9XG5cbiAgdmFyIGNob2ljZSA9IHRoaXMub3B0LmNob2ljZXMuZ2V0Q2hvaWNlKGluZGV4KTtcbiAgcmV0dXJuIGNob2ljZSA/IGNob2ljZS52YWx1ZSA6IG51bGw7XG59O1xuXG5Qcm9tcHQucHJvdG90eXBlLm9uRW5kID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gIHRoaXMuc3RhdHVzID0gJ2Fuc3dlcmVkJztcbiAgdGhpcy5hbnN3ZXIgPSBzdGF0ZS52YWx1ZTtcblxuICAvLyBSZS1yZW5kZXIgcHJvbXB0XG4gIHRoaXMucmVuZGVyKCk7XG5cbiAgdGhpcy5zY3JlZW4uZG9uZSgpO1xuICB0aGlzLmRvbmUoc3RhdGUudmFsdWUpO1xufTtcblxuUHJvbXB0LnByb3RvdHlwZS5vbkVycm9yID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLnJlbmRlcignUGxlYXNlIGVudGVyIGEgdmFsaWQgaW5kZXgnKTtcbn07XG5cbi8qKlxuICogV2hlbiB1c2VyIHByZXNzIGEga2V5XG4gKi9cblxuUHJvbXB0LnByb3RvdHlwZS5vbktleXByZXNzID0gZnVuY3Rpb24gKCkge1xuICB2YXIgaW5kZXggPSB0aGlzLnJsLmxpbmUubGVuZ3RoID8gTnVtYmVyKHRoaXMucmwubGluZSkgLSAxIDogMDtcblxuICBpZiAodGhpcy5vcHQuY2hvaWNlcy5nZXRDaG9pY2UoaW5kZXgpKSB7XG4gICAgdGhpcy5zZWxlY3RlZCA9IGluZGV4O1xuICB9IGVsc2Uge1xuICAgIHRoaXMuc2VsZWN0ZWQgPSB1bmRlZmluZWQ7XG4gIH1cblxuICB0aGlzLnJlbmRlcigpO1xufTtcblxuLyoqXG4gKiBGdW5jdGlvbiBmb3IgcmVuZGVyaW5nIGxpc3QgY2hvaWNlc1xuICogQHBhcmFtICB7TnVtYmVyfSBwb2ludGVyIFBvc2l0aW9uIG9mIHRoZSBwb2ludGVyXG4gKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgUmVuZGVyZWQgY29udGVudFxuICovXG5cbmZ1bmN0aW9uIHJlbmRlckNob2ljZXMoY2hvaWNlcywgcG9pbnRlcikge1xuICB2YXIgb3V0cHV0ID0gJyc7XG4gIHZhciBzZXBhcmF0b3JPZmZzZXQgPSAwO1xuXG4gIGNob2ljZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hvaWNlLCBpKSB7XG4gICAgb3V0cHV0ICs9ICdcXG4gICc7XG5cbiAgICBpZiAoY2hvaWNlLnR5cGUgPT09ICdzZXBhcmF0b3InKSB7XG4gICAgICBzZXBhcmF0b3JPZmZzZXQrKztcbiAgICAgIG91dHB1dCArPSAnICcgKyBjaG9pY2U7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIGluZGV4ID0gaSAtIHNlcGFyYXRvck9mZnNldDtcbiAgICB2YXIgZGlzcGxheSA9IChpbmRleCArIDEpICsgJykgJyArIGNob2ljZS5uYW1lO1xuICAgIGlmIChpbmRleCA9PT0gcG9pbnRlcikge1xuICAgICAgZGlzcGxheSA9IGNoYWxrLmN5YW4oZGlzcGxheSk7XG4gICAgfVxuICAgIG91dHB1dCArPSBkaXNwbGF5O1xuICB9KTtcblxuICByZXR1cm4gb3V0cHV0O1xufVxuIl19